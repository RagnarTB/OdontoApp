<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(titulo='Mis Citas', contenido=~{::#contenido-principal}, scripts=~{::#page-scripts})}">

<body>
<div id="contenido-principal">

    <style>
        /* Estilo para fechas pasadas */
        .fc-day-past {
            background-color: #f5f5f5 !important;
            opacity: 0.6;
        }

        .fc-timegrid-slot.fc-timegrid-slot-past {
            background-color: #fafafa !important;
            opacity: 0.5;
        }

        .fc-timegrid-slot-past {
            cursor: not-allowed !important;
        }

        .badge-orange {
            background-color: #fd7e14;
            color: white;
        }
    </style>

    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1><i class="fas fa-calendar-alt"></i> Mis Citas</h1>
                    <p class="text-muted">Agenda y gestiona tus citas médicas</p>
                </div>
                <div class="col-sm-6">
                    <button type="button" class="btn btn-primary float-sm-right" data-toggle="modal" data-target="#modalAgendarCita">
                        <i class="fas fa-plus"></i> Agendar Nueva Cita
                    </button>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">

            <!-- Leyenda -->
            <div class="card card-outline card-info mb-3">
                <div class="card-body">
                    <div class="row">
                        <div class="col-12">
                            <strong class="mr-2">Leyenda de Estados:</strong>
                            <span class="badge badge-warning mr-2"><i class="fas fa-circle"></i> Pendiente</span>
                            <span class="badge badge-info mr-2"><i class="fas fa-circle"></i> Confirmada</span>
                            <span class="badge badge-success mr-2"><i class="fas fa-circle"></i> Asistió</span>
                            <span class="badge badge-danger mr-2"><i class="fas fa-circle"></i> No Asistió</span>
                            <span class="badge badge-secondary mr-2"><i class="fas fa-circle"></i> Cancelada</span>
                            <span class="badge badge-orange mr-2"><i class="fas fa-circle"></i> Reprogramada</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendario -->
            <div class="card card-primary">
                <div class="card-body p-0">
                    <div id="calendario" style="padding: 15px;"></div>
                </div>
            </div>

        </div>
    </section>

    <!-- MODAL: Agendar Cita -->
    <div class="modal fade" id="modalAgendarCita" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary">
                    <h4 class="modal-title"><i class="fas fa-calendar-plus"></i> Agendar Nueva Cita</h4>
                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <form th:action="@{/paciente/citas/agendar}" method="post" id="formAgendarCita">
                    <div class="modal-body">

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Importante:</strong> Tu cita quedará en estado PENDIENTE hasta que sea confirmada por el personal de la clínica.
                        </div>

                        <div class="form-group">
                            <label for="agendarOdontologo">Odontólogo <span class="text-danger">*</span></label>
                            <select name="odontologoUsuarioId" id="agendarOdontologo" class="form-control" required>
                                <option value="">Seleccione un odontólogo...</option>
                                <option th:each="odontologo : ${listaOdontologos}"
                                        th:value="${odontologo.id}"
                                        th:text="${odontologo.nombreCompleto}"></option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="agendarProcedimiento">Procedimiento <span class="text-danger">*</span></label>
                            <select name="procedimientoId" id="agendarProcedimiento" class="form-control" required>
                                <option value="">Seleccione un procedimiento...</option>
                                <option th:each="proc : ${listaProcedimientos}"
                                        th:value="${proc.id}"
                                        th:text="${proc.nombre + ' (' + proc.duracionBaseMinutos + ' min)'}"
                                        th:data-duracion="${proc.duracionBaseMinutos}"></option>
                            </select>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="agendarFecha">Fecha <span class="text-danger">*</span></label>
                                    <input type="date" name="fecha" id="agendarFecha" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="agendarHora">Hora Disponible <span class="text-danger">*</span></label>
                                    <select name="hora" id="agendarHora" class="form-control" required disabled>
                                        <option value="">Primero seleccione fecha, odontólogo y procedimiento</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="agendarMotivo">Motivo de Consulta</label>
                            <textarea name="motivoConsulta" id="agendarMotivo" class="form-control" rows="3"
                                      placeholder="Describa el motivo de su consulta (opcional)"></textarea>
                        </div>

                        <input type="hidden" name="fechaHoraInicio" id="agendarFechaHoraInicio">

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Agendar Cita</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: Detalle de Cita -->
    <div class="modal fade" id="modalDetalleCita" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info">
                    <h4 class="modal-title"><i class="fas fa-info-circle"></i> Detalle de Cita</h4>
                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <dl class="row">
                        <dt class="col-sm-4">ID de Cita:</dt>
                        <dd class="col-sm-8" id="detalleCitaId"></dd>

                        <dt class="col-sm-4">Fecha y Hora:</dt>
                        <dd class="col-sm-8" id="detalleFechaHora"></dd>

                        <dt class="col-sm-4">Odontólogo:</dt>
                        <dd class="col-sm-8" id="detalleOdontologo"></dd>

                        <dt class="col-sm-4">Procedimiento:</dt>
                        <dd class="col-sm-8" id="detalleProcedimiento"></dd>

                        <dt class="col-sm-4">Duración:</dt>
                        <dd class="col-sm-8" id="detalleDuracion"></dd>

                        <dt class="col-sm-4">Estado:</dt>
                        <dd class="col-sm-8" id="detalleEstado"></dd>

                        <dt class="col-sm-4">Motivo:</dt>
                        <dd class="col-sm-8" id="detalleMotivo"></dd>
                    </dl>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" id="btnReprogramar" style="display: none;">
                        <i class="fas fa-calendar"></i> Reprogramar
                    </button>
                    <button type="button" class="btn btn-danger" id="btnCancelar" style="display: none;">
                        <i class="fas fa-ban"></i> Cancelar Cita
                    </button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Reprogramar Cita -->
    <div class="modal fade" id="modalReprogramarCita" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h4 class="modal-title"><i class="fas fa-calendar"></i> Reprogramar Cita</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <form th:action="@{/paciente/citas/reprogramar}" method="post" id="formReprogramarCita">
                    <div class="modal-body">

                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            La cita reprogramada deberá ser confirmada nuevamente por el personal de la clínica.
                        </div>

                        <input type="hidden" name="citaId" id="reprogramarCitaId">
                        <input type="hidden" name="odontologoUsuarioId" id="reprogramarOdontologoId">

                        <div class="form-group">
                            <label>Cita Actual:</label>
                            <p id="reprogramarCitaActual" class="form-control-plaintext font-weight-bold"></p>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="reprogramarFecha">Nueva Fecha <span class="text-danger">*</span></label>
                                    <input type="date" name="fecha" id="reprogramarFecha" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="reprogramarHora">Nueva Hora <span class="text-danger">*</span></label>
                                    <select name="hora" id="reprogramarHora" class="form-control" required disabled>
                                        <option value="">Seleccione fecha primero</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <input type="hidden" name="nuevaFechaHoraInicio" id="reprogramarNuevaFechaHora">
                        <input type="hidden" name="motivo" value="Reprogramado por el paciente">

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-warning"><i class="fas fa-save"></i> Reprogramar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: Cancelar Cita -->
    <div class="modal fade" id="modalCancelarCita" tabindex="-1" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger">
                    <h4 class="modal-title"><i class="fas fa-ban"></i> Cancelar Cita</h4>
                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <form th:action="@{/paciente/citas/cancelar}" method="post" id="formCancelarCita">
                    <div class="modal-body">

                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Atención:</strong> Esta acción no se puede deshacer.
                        </div>

                        <input type="hidden" name="citaId" id="cancelarCitaId">

                        <div class="form-group">
                            <label>Cita a cancelar:</label>
                            <p id="cancelarCitaInfo" class="form-control-plaintext font-weight-bold"></p>
                        </div>

                        <div class="form-group">
                            <label for="cancelarMotivo">Motivo de Cancelación <span class="text-danger">*</span></label>
                            <textarea name="motivo" id="cancelarMotivo" class="form-control" rows="3" required
                                      placeholder="Por favor indique el motivo de la cancelación"></textarea>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Volver</button>
                        <button type="submit" class="btn btn-danger"><i class="fas fa-ban"></i> Confirmar Cancelación</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>

<!-- SCRIPTS ESPECÍFICOS DE LA PÁGINA -->
<th:block th:fragment="page-scripts">
    <!-- FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/locales/es.global.min.js"></script>

    <script th:inline="javascript">
        $(document).ready(function() {
            // Variables globales
            let calendar;
            let citaActual = null;

            // Inicializar calendario
            inicializarCalendario();

            // Event Listeners
            $('#agendarFecha, #agendarOdontologo, #agendarProcedimiento').on('change', cargarHorariosDisponibles);
            $('#agendarHora').on('change', actualizarFechaHoraCompleta);
            $('#reprogramarFecha').on('change', cargarHorariosReprogramacion);
            $('#reprogramarHora').on('change', actualizarFechaHoraReprogramacion);
            $('#btnReprogramar').on('click', abrirModalReprogramar);
            $('#btnCancelar').on('click', abrirModalCancelar);

            function inicializarCalendario() {
                const calendarEl = document.getElementById('calendario');

                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'timeGridWeek',
                    locale: 'es',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    slotMinTime: '08:00:00',
                    slotMaxTime: '20:00:00',
                    allDaySlot: false,
                    height: 'auto',
                    events: function(info, successCallback, failureCallback) {
                        fetch('/paciente/citas/api/eventos?' + new URLSearchParams({
                            start: info.startStr,
                            end: info.endStr
                        }))
                        .then(response => response.json())
                        .then(data => successCallback(data))
                        .catch(error => {
                            console.error('Error al cargar eventos:', error);
                            failureCallback(error);
                        });
                    },
                    eventClick: function(info) {
                        mostrarDetalleCita(info.event);
                    },
                    eventDidMount: function(info) {
                        // Marcar slots pasados
                        const ahora = new Date();
                        if (info.event.start < ahora) {
                            info.el.classList.add('evento-pasado');
                        }
                    }
                });

                calendar.render();
            }

            function mostrarDetalleCita(event) {
                const props = event.extendedProps;

                citaActual = {
                    id: event.id,
                    odontologoId: props.odontologoId,
                    odontologoNombre: props.odontologoNombre,
                    procedimientoId: props.procedimientoId,
                    procedimientoNombre: props.procedimientoNombre,
                    estadoNombre: props.estadoNombre,
                    fechaHoraInicio: event.start,
                    fechaHoraFin: event.end,
                    motivoConsulta: props.motivoConsulta || 'No especificado'
                };

                // Llenar modal de detalle
                $('#detalleCitaId').text('#' + event.id);
                $('#detalleFechaHora').text(formatearFechaHora(event.start));
                $('#detalleOdontologo').text(props.odontologoNombre);
                $('#detalleProcedimiento').text(props.procedimientoNombre || 'Consulta General');

                const duracion = Math.round((event.end - event.start) / 60000);
                $('#detalleDuracion').text(duracion + ' minutos');

                $('#detalleEstado').html(obtenerBadgeEstado(props.estadoNombre));
                $('#detalleMotivo').text(props.motivoConsulta || 'No especificado');

                // Mostrar/ocultar botones según estado
                const estadosModificables = ['PENDIENTE', 'CONFIRMADA'];
                if (estadosModificables.includes(props.estadoNombre)) {
                    $('#btnReprogramar').show();
                    $('#btnCancelar').show();
                } else {
                    $('#btnReprogramar').hide();
                    $('#btnCancelar').hide();
                }

                $('#modalDetalleCita').modal('show');
            }

            function cargarHorariosDisponibles() {
                const fecha = $('#agendarFecha').val();
                const odontologoId = $('#agendarOdontologo').val();
                const procedimientoId = $('#agendarProcedimiento').val();

                if (!fecha || !odontologoId || !procedimientoId) {
                    $('#agendarHora').prop('disabled', true);
                    return;
                }

                const duracion = $('#agendarProcedimiento option:selected').data('duracion') || 30;

                fetch('/paciente/citas/api/horarios-disponibles?' + new URLSearchParams({
                    odontologoId: odontologoId,
                    fecha: fecha,
                    duracion: duracion
                }))
                .then(response => response.json())
                .then(data => {
                    const select = $('#agendarHora');
                    select.empty();

                    if (data.error) {
                        select.append('<option value="">Error: ' + data.mensaje + '</option>');
                        select.prop('disabled', true);
                        return;
                    }

                    if (!data.disponible || !data.horariosDisponibles || data.horariosDisponibles.length === 0) {
                        select.append('<option value="">No hay horarios disponibles</option>');
                        select.prop('disabled', true);
                        return;
                    }

                    select.append('<option value="">Seleccione un horario...</option>');
                    data.horariosDisponibles.forEach(slot => {
                        if (slot.disponible) {
                            select.append(`<option value="${slot.inicio}">${slot.inicio} - ${slot.fin}</option>`);
                        }
                    });
                    select.prop('disabled', false);
                })
                .catch(error => {
                    console.error('Error al cargar horarios:', error);
                    mostrarError('Error al cargar horarios disponibles');
                });
            }

            function actualizarFechaHoraCompleta() {
                const fecha = $('#agendarFecha').val();
                const hora = $('#agendarHora').val();

                if (fecha && hora) {
                    $('#agendarFechaHoraInicio').val(fecha + 'T' + hora);
                }
            }

            function abrirModalReprogramar() {
                if (!citaActual) return;

                $('#reprogramarCitaId').val(citaActual.id);
                $('#reprogramarOdontologoId').val(citaActual.odontologoId);
                $('#reprogramarCitaActual').text(
                    formatearFechaHora(citaActual.fechaHoraInicio) + ' - ' + citaActual.procedimientoNombre
                );

                $('#modalDetalleCita').modal('hide');
                $('#modalReprogramarCita').modal('show');
            }

            function cargarHorariosReprogramacion() {
                const fecha = $('#reprogramarFecha').val();
                const odontologoId = $('#reprogramarOdontologoId').val();

                if (!fecha || !odontologoId || !citaActual) {
                    $('#reprogramarHora').prop('disabled', true);
                    return;
                }

                const duracion = Math.round((citaActual.fechaHoraFin - citaActual.fechaHoraInicio) / 60000);

                fetch('/paciente/citas/api/horarios-disponibles?' + new URLSearchParams({
                    odontologoId: odontologoId,
                    fecha: fecha,
                    duracion: duracion,
                    citaIdExcluir: citaActual.id
                }))
                .then(response => response.json())
                .then(data => {
                    const select = $('#reprogramarHora');
                    select.empty();

                    if (!data.disponible || !data.horariosDisponibles || data.horariosDisponibles.length === 0) {
                        select.append('<option value="">No hay horarios disponibles</option>');
                        select.prop('disabled', true);
                        return;
                    }

                    select.append('<option value="">Seleccione un horario...</option>');
                    data.horariosDisponibles.forEach(slot => {
                        if (slot.disponible) {
                            select.append(`<option value="${slot.inicio}">${slot.inicio} - ${slot.fin}</option>`);
                        }
                    });
                    select.prop('disabled', false);
                })
                .catch(error => {
                    console.error('Error al cargar horarios:', error);
                });
            }

            function actualizarFechaHoraReprogramacion() {
                const fecha = $('#reprogramarFecha').val();
                const hora = $('#reprogramarHora').val();

                if (fecha && hora) {
                    $('#reprogramarNuevaFechaHora').val(fecha + 'T' + hora);
                }
            }

            function abrirModalCancelar() {
                if (!citaActual) return;

                $('#cancelarCitaId').val(citaActual.id);
                $('#cancelarCitaInfo').text(
                    formatearFechaHora(citaActual.fechaHoraInicio) + ' - ' + citaActual.procedimientoNombre
                );

                $('#modalDetalleCita').modal('hide');
                $('#modalCancelarCita').modal('show');
            }

            function formatearFechaHora(date) {
                return new Date(date).toLocaleString('es-PE', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            function obtenerBadgeEstado(estado) {
                const badges = {
                    'PENDIENTE': '<span class="badge badge-warning">Pendiente</span>',
                    'CONFIRMADA': '<span class="badge badge-info">Confirmada</span>',
                    'ASISTIO': '<span class="badge badge-success">Asistió</span>',
                    'NO_ASISTIO': '<span class="badge badge-danger">No Asistió</span>',
                    'CANCELADA_PACIENTE': '<span class="badge badge-secondary">Cancelada</span>',
                    'CANCELADA_CLINICA': '<span class="badge badge-secondary">Cancelada</span>',
                    'REPROGRAMADA': '<span class="badge badge-orange">Reprogramada</span>'
                };
                return badges[estado] || '<span class="badge badge-light">' + estado + '</span>';
            }

            // Limpiar modales al cerrar
            $('#modalAgendarCita').on('hidden.bs.modal', function() {
                $('#formAgendarCita')[0].reset();
                $('#agendarHora').prop('disabled', true);
            });

            $('#modalReprogramarCita').on('hidden.bs.modal', function() {
                $('#formReprogramarCita')[0].reset();
                $('#reprogramarHora').prop('disabled', true);
            });

            $('#modalCancelarCita').on('hidden.bs.modal', function() {
                $('#formCancelarCita')[0].reset();
            });
        });
    </script>
</th:block>

</body>
</html>
