<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout/base :: layout(titulo='Cambiar Contrase√±a', contenido=~{::#contenido-principal}, scripts=~{::#custom-scripts})}">

<body>
    <div id="contenido-principal">
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1><i class="fas fa-key"></i> Cambiar Contrase√±a</h1>
                    </div>
                    <div class="col-sm-6">
                        <a th:href="@{/paciente/perfil}" class="btn btn-secondary float-sm-right">
                            <i class="fas fa-arrow-left"></i> Volver a Mi Perfil
                        </a>
                    </div>
                </div>
            </div>
        </section>
        <section class="content">
            <div class="container-fluid">
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="card card-primary">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-shield-alt"></i> Actualizar Contrase√±a</h3>
                            </div>
                            <form th:action="@{/usuarios/cambiar-password}" method="post" id="formCambioPassword">
                                <div class="card-body">
                                    <!-- Mensaje de error -->
                                    <div th:if="${error}" class="alert alert-danger alert-dismissible">
                                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                                        <i class="icon fas fa-ban"></i> <span th:text="${error}"></span>
                                    </div>
                                    <!-- Usuario actual -->
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Usuario:</strong> <span th:text="${usuario.email}"></span>
                                    </div>
                                    <!-- Contrase√±a Actual -->
                                    <div class="form-group">
                                        <label for="passwordActual">Contrase√±a Actual <span
                                                class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                            </div>
                                            <input type="password" class="form-control" id="passwordActual"
                                                name="passwordActual" placeholder="Ingresa tu contrase√±a actual"
                                                required>
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="button"
                                                    id="togglePasswordActual">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Nueva Contrase√±a -->
                                    <div class="form-group">
                                        <label for="nuevaPassword">Nueva Contrase√±a <span
                                                class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-key"></i></span>
                                            </div>
                                            <input type="password" class="form-control" id="nuevaPassword"
                                                name="nuevaPassword" placeholder="Nueva contrase√±a segura" required>
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="button"
                                                    id="toggleNuevaPassword">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <small id="password-strength" class="form-text"></small>
                                    </div>
                                    <!-- Confirmar Nueva Contrase√±a -->
                                    <div class="form-group">
                                        <label for="confirmarPassword">Confirmar Nueva Contrase√±a <span
                                                class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-check"></i></span>
                                            </div>
                                            <input type="password" class="form-control" id="confirmarPassword"
                                                name="confirmarPassword" placeholder="Repite la nueva contrase√±a"
                                                required>
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="button"
                                                    id="toggleConfirmarPassword">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <small id="password-match" class="form-text"></small>
                                    </div>
                                    <!-- Requisitos de contrase√±a -->
                                    <div class="alert alert-light border">
                                        <strong><i class="fas fa-shield-alt"></i> La contrase√±a debe contener:</strong>
                                        <ul id="requisitos-lista" class="mb-0 mt-2">
                                            <li id="req-length">‚úó M√≠nimo 8 caracteres</li>
                                            <li id="req-uppercase">‚úó Al menos una may√∫scula (A-Z)</li>
                                            <li id="req-lowercase">‚úó Al menos una min√∫scula (a-z)</li>
                                            <li id="req-number">‚úó Al menos un n√∫mero (0-9)</li>
                                            <li id="req-special">‚úó Al menos un car√°cter especial (!@#$%&*)</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <button type="submit" class="btn btn-primary" id="btnSubmit" disabled>
                                        <i class="fas fa-save"></i> Cambiar Contrase√±a
                                    </button>
                                    <a th:href="@{/paciente/perfil}" class="btn btn-default">
                                        <i class="fas fa-times"></i> Cancelar
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Scripts personalizados -->
    <th:block id="custom-scripts">
        <style>
            /* Ocultar el ojo autom√°tico del navegador */
            input[type="password"]::-ms-reveal,
            input[type="password"]::-ms-clear {
                display: none;
            }

            input[type="password"]::-webkit-contacts-auto-fill-button,
            input[type="password"]::-webkit-credentials-auto-fill-button {
                visibility: hidden;
                display: none !important;
                pointer-events: none;
                height: 0;
                width: 0;
                margin: 0;
            }
        </style>
        <script th:inline="javascript">
            /*<![CDATA[*/
            console.log('üîß Iniciando script de validaci√≥n de contrase√±a');
            console.log('jQuery disponible:', typeof $ !== 'undefined');

            $(document).ready(function () {
                console.log('‚úÖ Document ready ejecutado');

                // Toggle mostrar/ocultar contrase√±as
                function togglePasswordVisibility(inputId, buttonId) {
                    const input = $('#' + inputId);
                    const button = $('#' + buttonId);
                    const icon = button.find('i');

                    console.log('Configurando toggle para:', inputId, 'Input encontrado:', input.length);

                    button.on('click', function () {
                        if (input.attr('type') === 'password') {
                            input.attr('type', 'text');
                            icon.removeClass('fa-eye').addClass('fa-eye-slash');
                        } else {
                            input.attr('type', 'password');
                            icon.removeClass('fa-eye-slash').addClass('fa-eye');
                        }
                    });
                }

                togglePasswordVisibility('passwordActual', 'togglePasswordActual');
                togglePasswordVisibility('nuevaPassword', 'toggleNuevaPassword');
                togglePasswordVisibility('confirmarPassword', 'toggleConfirmarPassword');

                // Validaci√≥n en tiempo real
                const nuevaPassword = $('#nuevaPassword');
                const confirmarPassword = $('#confirmarPassword');
                const strengthIndicator = $('#password-strength');
                const matchIndicator = $('#password-match');
                const btnSubmit = $('#btnSubmit');

                console.log('Elementos encontrados:', {
                    nuevaPassword: nuevaPassword.length,
                    confirmarPassword: confirmarPassword.length,
                    btnSubmit: btnSubmit.length
                });

                function validarPassword() {
                    const password = nuevaPassword.val();
                    const ESPECIALES = '!@#$%&*';
                    const tieneMayuscula = /[A-Z]/.test(password);
                    const tieneMinuscula = /[a-z]/.test(password);
                    const tieneNumero = /[0-9]/.test(password);
                    const tieneEspecial = new RegExp(`[${ESPECIALES.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&')}]`).test(password);
                    const tieneMinimo8 = password.length >= 8;

                    // Actualizar lista de requisitos
                    actualizarRequisito('req-length', tieneMinimo8);
                    actualizarRequisito('req-uppercase', tieneMayuscula);
                    actualizarRequisito('req-lowercase', tieneMinuscula);
                    actualizarRequisito('req-number', tieneNumero);
                    actualizarRequisito('req-special', tieneEspecial);

                    // Calcular fortaleza
                    const cumplidos = [tieneMayuscula, tieneMinuscula, tieneNumero, tieneEspecial, tieneMinimo8]
                        .filter(Boolean).length;

                    if (password.length === 0) {
                        strengthIndicator.text('').removeClass('text-danger text-success');
                    } else if (cumplidos < 5) {
                        strengthIndicator.text('Contrase√±a d√©bil').removeClass('text-success').addClass('text-danger');
                    } else {
                        strengthIndicator.text('‚úì Contrase√±a v√°lida').removeClass('text-danger').addClass('text-success');
                    }

                    return cumplidos === 5;
                }

                function actualizarRequisito(id, cumplido) {
                    const elemento = $('#' + id);
                    if (elemento.length === 0) {
                        console.warn('Elemento no encontrado:', id);
                        return;
                    }

                    // Obtener el texto sin el s√≠mbolo
                    const textoOriginal = elemento.text().replace(/[‚úì‚úó]\s*/, '');

                    if (cumplido) {
                        elemento.css('color', '#28a745').text('‚úì ' + textoOriginal);
                    } else {
                        elemento.css('color', '#dc3545').text('‚úó ' + textoOriginal);
                    }
                }

                function validarCoincidencia() {
                    const nueva = nuevaPassword.val();
                    const confirmar = confirmarPassword.val();

                    if (confirmar.length === 0) {
                        matchIndicator.text('').removeClass('text-danger text-success');
                        return false;
                    }

                    if (nueva === confirmar) {
                        matchIndicator.text('‚úì Las contrase√±as coinciden').removeClass('text-danger').addClass('text-success');
                        return true;
                    } else {
                        matchIndicator.text('‚úó Las contrase√±as no coinciden').removeClass('text-success').addClass('text-danger');
                        return false;
                    }
                }

                function habilitarBoton() {
                    const passwordValida = validarPassword();
                    const passwordsCoinciden = validarCoincidencia();
                    const passwordActualLlena = $('#passwordActual').val().length > 0;

                    btnSubmit.prop('disabled', !(passwordValida && passwordsCoinciden && passwordActualLlena));
                }

                // Registrar eventos
                console.log('Registrando eventos de input...');
                nuevaPassword.on('input', function() {
                    console.log('Input en nuevaPassword:', nuevaPassword.val());
                    habilitarBoton();
                });
                confirmarPassword.on('input', habilitarBoton);
                $('#passwordActual').on('input', habilitarBoton);

                // Prevenir env√≠o si no cumple validaciones
                $('#formCambioPassword').on('submit', function (e) {
                    if (btnSubmit.prop('disabled')) {
                        e.preventDefault();
                        alert('Por favor, completa todos los requisitos antes de continuar.');
                    }
                });

                console.log('‚úÖ Script de validaci√≥n configurado completamente');
            });
            /*]]>*/
        </script>
    </th:block>
</body>

</html>