<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
    th:replace="~{layout/base :: layout(titulo='Cambiar Contraseña', contenido=~{::#contenido-principal})}">

<body>
    <div id="contenido-principal">

        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1><i class="fas fa-key"></i> Cambiar Contraseña</h1>
                    </div>
                    <div class="col-sm-6">
                        <a th:href="@{/paciente/perfil}" class="btn btn-secondary float-sm-right">
                            <i class="fas fa-arrow-left"></i> Volver a Mi Perfil
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <section class="content">
            <div class="container-fluid">
                <div class="row justify-content-center">
                    <div class="col-md-8">
                        <div class="card card-primary">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-shield-alt"></i> Actualizar Contraseña</h3>
                            </div>

                            <form th:action="@{/usuarios/cambiar-password}" method="post" id="formCambioPassword">
                                <div class="card-body">

                                    <!-- Mensaje de error -->
                                    <div th:if="${error}" class="alert alert-danger alert-dismissible">
                                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                                        <i class="icon fas fa-ban"></i> <span th:text="${error}"></span>
                                    </div>

                                    <!-- Usuario actual -->
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>Usuario:</strong> <span th:text="${usuario.email}"></span>
                                    </div>

                                    <!-- Contraseña Actual -->
                                    <div class="form-group">
                                        <label for="passwordActual">Contraseña Actual <span
                                                class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                            </div>
                                            <input type="password" class="form-control" id="passwordActual"
                                                name="passwordActual" placeholder="Ingresa tu contraseña actual"
                                                required>
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="button"
                                                    id="togglePasswordActual">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Nueva Contraseña -->
                                    <div class="form-group">
                                        <label for="nuevaPassword">Nueva Contraseña <span
                                                class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-key"></i></span>
                                            </div>
                                            <input type="password" class="form-control" id="nuevaPassword"
                                                name="nuevaPassword" placeholder="Nueva contraseña segura" required>
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="button"
                                                    id="toggleNuevaPassword">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <small id="password-strength" class="form-text"></small>
                                    </div>

                                    <!-- Confirmar Nueva Contraseña -->
                                    <div class="form-group">
                                        <label for="confirmarPassword">Confirmar Nueva Contraseña <span
                                                class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text"><i class="fas fa-check"></i></span>
                                            </div>
                                            <input type="password" class="form-control" id="confirmarPassword"
                                                name="confirmarPassword" placeholder="Repite la nueva contraseña"
                                                required>
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-secondary" type="button"
                                                    id="toggleConfirmarPassword">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <small id="password-match" class="form-text"></small>
                                    </div>

                                    <!-- Requisitos de contraseña -->
                                    <div class="alert alert-light border">
                                        <strong><i class="fas fa-shield-alt"></i> La contraseña debe contener:</strong>
                                        <ul id="requisitos-lista" class="mb-0 mt-2">
                                            <li id="req-length">✗ Mínimo 8 caracteres</li>
                                            <li id="req-uppercase">✗ Al menos una mayúscula (A-Z)</li>
                                            <li id="req-lowercase">✗ Al menos una minúscula (a-z)</li>
                                            <li id="req-number">✗ Al menos un número (0-9)</li>
                                            <li id="req-special">✗ Al menos un carácter especial (!@#$%&*)</li>
                                        </ul>
                                    </div>

                                </div>

                                <div class="card-footer">
                                    <button type="submit" class="btn btn-primary" id="btnSubmit" disabled>
                                        <i class="fas fa-save"></i> Cambiar Contraseña
                                    </button>
                                    <a th:href="@{/paciente/perfil}" class="btn btn-default">
                                        <i class="fas fa-times"></i> Cancelar
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <script>
        window.addEventListener('DOMContentLoaded', function () {
        // Toggle mostrar/ocultar contraseñas
        function togglePasswordVisibility(inputId, buttonId) {
            const input = document.getElementById(inputId);
            const button = document.getElementById(buttonId);
            const icon = button.querySelector('i');

            button.addEventListener('click', function () {
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        }

        togglePasswordVisibility('passwordActual', 'togglePasswordActual');
        togglePasswordVisibility('nuevaPassword', 'toggleNuevaPassword');
        togglePasswordVisibility('confirmarPassword', 'toggleConfirmarPassword');

        // Validación en tiempo real
        const nuevaPassword = document.getElementById('nuevaPassword');
        const confirmarPassword = document.getElementById('confirmarPassword');
        const strengthIndicator = document.getElementById('password-strength');
        const matchIndicator = document.getElementById('password-match');
        const btnSubmit = document.getElementById('btnSubmit');

        function validarPassword() {
            const password = nuevaPassword.value;
            const ESPECIALES = '!@#$%&*';

            const tieneMayuscula = /[A-Z]/.test(password);
            const tieneMinuscula = /[a-z]/.test(password);
            const tieneNumero = /[0-9]/.test(password);
            const tieneEspecial = new RegExp(`[${ESPECIALES.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&')}]`).test(password);
            const tieneMinimo8 = password.length >= 8;

            // Actualizar lista de requisitos
            actualizarRequisito('req-length', tieneMinimo8);
            actualizarRequisito('req-uppercase', tieneMayuscula);
            actualizarRequisito('req-lowercase', tieneMinuscula);
            actualizarRequisito('req-number', tieneNumero);
            actualizarRequisito('req-special', tieneEspecial);

            // Calcular fortaleza
            const cumplidos = [tieneMayuscula, tieneMinuscula, tieneNumero, tieneEspecial, tieneMinimo8]
                .filter(Boolean).length;

            if (password.length === 0) {
                strengthIndicator.textContent = '';
                strengthIndicator.className = 'form-text';
            } else if (cumplidos < 5) {
                strengthIndicator.textContent = 'Contraseña débil';
                strengthIndicator.className = 'form-text text-danger';
            } else {
                strengthIndicator.textContent = '✓ Contraseña válida';
                strengthIndicator.className = 'form-text text-success';
            }

            return cumplidos === 5;
        }

        function actualizarRequisito(id, cumplido) {
            const elemento = document.getElementById(id);
            if (cumplido) {
                elemento.style.color = '#28a745';
                elemento.innerHTML = elemento.innerHTML.replace('✗', '✓');
            } else {
                elemento.style.color = '#dc3545';
                elemento.innerHTML = elemento.innerHTML.replace('✓', '✗');
            }
        }

        function validarCoincidencia() {
            const nueva = nuevaPassword.value;
            const confirmar = confirmarPassword.value;

            if (confirmar.length === 0) {
                matchIndicator.textContent = '';
                matchIndicator.className = 'form-text';
                return false;
            }

            if (nueva === confirmar) {
                matchIndicator.textContent = '✓ Las contraseñas coinciden';
                matchIndicator.className = 'form-text text-success';
                return true;
            } else {
                matchIndicator.textContent = '✗ Las contraseñas no coinciden';
                matchIndicator.className = 'form-text text-danger';
                return false;
            }
        }

        function habilitarBoton() {
            const passwordValida = validarPassword();
            const passwordsCoinciden = validarCoincidencia();
            const passwordActualLlena = document.getElementById('passwordActual').value.length > 0;

            btnSubmit.disabled = !(passwordValida && passwordsCoinciden && passwordActualLlena);
        }

        nuevaPassword.addEventListener('input', habilitarBoton);
        confirmarPassword.addEventListener('input', habilitarBoton);
        document.getElementById('passwordActual').addEventListener('input', habilitarBoton);

        // Prevenir envío si no cumple validaciones
        document.getElementById('formCambioPassword').addEventListener('submit', function (e) {
            if (btnSubmit.disabled) {
                e.preventDefault();
                alert('Por favor, completa todos los requisitos antes de continuar.');
            }
        });
        });
    </script>

</body>

</html>
