<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cambiar Contraseña - OdontoApp</title>
    <link rel="stylesheet" th:href="@{/adminlte/plugins/fontawesome-free/css/all.min.css}">
    <link rel="stylesheet" th:href="@{/adminlte/dist/css/adminlte.min.css}">

    <style>
        body {
            background-color: #f4f6f9;
        }

        .password-box {
            width: 500px;
            margin: 50px auto;
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .card-warning {
            border-top: 3px solid #ffc107;
        }

        .requisitos-password {
            background-color: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .requisitos-password ul {
            margin-bottom: 0;
            padding-left: 20px;
        }

        .requisitos-password li {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .btn-cambiar {
            background-color: #ffc107;
            border: none;
            color: #000;
            font-weight: 600;
        }

        .btn-cambiar:hover {
            background-color: #e0a800;
            color: #000;
        }
    </style>
</head>

<body class="hold-transition login-page">
    <div class="password-box">
        <div class="card card-outline card-warning">
            <div class="card-header text-center">
                <a href="#" class="h1"><b>Odonto</b>App</a>
            </div>

            <div class="card-body">
                <!-- Alerta de advertencia -->
                <div class="alert alert-warning">
                    <h5><i class="icon fas fa-exclamation-triangle"></i> Cambio de Contraseña Obligatorio</h5>
                    Por seguridad, debes cambiar tu contraseña temporal antes de continuar.
                </div>

                <!-- Mensaje de error -->
                <div th:if="${error}" class="alert alert-danger alert-dismissible">
                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                    <i class="icon fas fa-ban"></i> <span th:text="${error}"></span>
                </div>

                <form th:action="@{/cambiar-password-obligatorio}" method="post" id="formCambioPassword">

                    <!-- Usuario actual -->
                    <div class="mb-3">
                        <p><strong>Usuario:</strong> <span th:text="${usuario.email}"></span></p>
                    </div>

                    <!-- Contraseña Actual -->
                    <div class="form-group">
                        <label for="passwordActual">Contraseña Temporal Actual</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="passwordActual" name="passwordActual"
                                placeholder="Ingresa tu contraseña temporal" required>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="togglePasswordActual">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Nueva Contraseña -->
                    <div class="form-group">
                        <label for="nuevaPassword">Nueva Contraseña</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="nuevaPassword" name="nuevaPassword"
                                placeholder="Nueva contraseña segura" required>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="toggleNuevaPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <small id="password-strength" class="form-text"></small>
                    </div>

                    <!-- Confirmar Nueva Contraseña -->
                    <div class="form-group">
                        <label for="confirmarPassword">Confirmar Nueva Contraseña</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="confirmarPassword" name="confirmarPassword"
                                placeholder="Repite la nueva contraseña" required>
                            <div class="input-group-append">
                                <button class="btn btn-outline-secondary" type="button" id="toggleConfirmarPassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <small id="password-match" class="form-text"></small>
                    </div>

                    <!-- Requisitos de contraseña -->
                    <div class="requisitos-password">
                        <strong><i class="fas fa-shield-alt"></i> La contraseña debe contener:</strong>
                        <ul id="requisitos-lista">
                            <li id="req-length">✗ Mínimo 8 caracteres</li>
                            <li id="req-uppercase">✗ Al menos una mayúscula (A-Z)</li>
                            <li id="req-lowercase">✗ Al menos una minúscula (a-z)</li>
                            <li id="req-number">✗ Al menos un número (0-9)</li>
                            <li id="req-special">✗ Al menos un carácter especial (!@#$%&*)</li>
                        </ul>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <button type="submit" class="btn btn-cambiar btn-block" id="btnSubmit" disabled>
                                <i class="fas fa-shield-alt"></i> Cambiar Contraseña y Continuar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script th:src="@{/adminlte/plugins/jquery/jquery.min.js}"></script>
    <script th:src="@{/adminlte/plugins/bootstrap/js/bootstrap.bundle.min.js}"></script>

    <script>
        // Toggle mostrar/ocultar contraseñas
        function togglePasswordVisibility(inputId, buttonId) {
            const input = document.getElementById(inputId);
            const button = document.getElementById(buttonId);
            const icon = button.querySelector('i');

            button.addEventListener('click', function () {
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        }

        togglePasswordVisibility('passwordActual', 'togglePasswordActual');
        togglePasswordVisibility('nuevaPassword', 'toggleNuevaPassword');
        togglePasswordVisibility('confirmarPassword', 'toggleConfirmarPassword');

        // Validación en tiempo real
        const nuevaPassword = document.getElementById('nuevaPassword');
        const confirmarPassword = document.getElementById('confirmarPassword');
        const strengthIndicator = document.getElementById('password-strength');
        const matchIndicator = document.getElementById('password-match');
        const btnSubmit = document.getElementById('btnSubmit');

        function validarPassword() {
            const password = nuevaPassword.value;
            const ESPECIALES = '!@#$%&*';

            const tieneMayuscula = /[A-Z]/.test(password);
            const tieneMinuscula = /[a-z]/.test(password);
            const tieneNumero = /[0-9]/.test(password);
            const tieneEspecial = new RegExp(`[${ESPECIALES.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&')}]`).test(password);
            const tieneMinimo8 = password.length >= 8;

            // Actualizar lista de requisitos
            actualizarRequisito('req-length', tieneMinimo8);
            actualizarRequisito('req-uppercase', tieneMayuscula);
            actualizarRequisito('req-lowercase', tieneMinuscula);
            actualizarRequisito('req-number', tieneNumero);
            actualizarRequisito('req-special', tieneEspecial);

            // Calcular fortaleza
            const cumplidos = [tieneMayuscula, tieneMinuscula, tieneNumero, tieneEspecial, tieneMinimo8]
                .filter(Boolean).length;

            if (password.length === 0) {
                strengthIndicator.textContent = '';
                strengthIndicator.className = 'form-text';
            } else if (cumplidos < 5) {
                strengthIndicator.textContent = 'Contraseña débil';
                strengthIndicator.className = 'form-text text-danger';
            } else {
                strengthIndicator.textContent = '✓ Contraseña válida';
                strengthIndicator.className = 'form-text text-success';
            }

            return cumplidos === 5;
        }

        function actualizarRequisito(id, cumplido) {
            const elemento = document.getElementById(id);
            if (cumplido) {
                elemento.style.color = '#28a745';
                elemento.innerHTML = elemento.innerHTML.replace('✗', '✓');
            } else {
                elemento.style.color = '#dc3545';
                elemento.innerHTML = elemento.innerHTML.replace('✓', '✗');
            }
        }

        function validarCoincidencia() {
            const nueva = nuevaPassword.value;
            const confirmar = confirmarPassword.value;

            if (confirmar.length === 0) {
                matchIndicator.textContent = '';
                matchIndicator.className = 'form-text';
                return false;
            }

            if (nueva === confirmar) {
                matchIndicator.textContent = '✓ Las contraseñas coinciden';
                matchIndicator.className = 'form-text text-success';
                return true;
            } else {
                matchIndicator.textContent = '✗ Las contraseñas no coinciden';
                matchIndicator.className = 'form-text text-danger';
                return false;
            }
        }

        function habilitarBoton() {
            const passwordValida = validarPassword();
            const passwordsCoinciden = validarCoincidencia();
            const passwordActualLlena = document.getElementById('passwordActual').value.length > 0;

            btnSubmit.disabled = !(passwordValida && passwordsCoinciden && passwordActualLlena);
        }

        nuevaPassword.addEventListener('input', habilitarBoton);
        confirmarPassword.addEventListener('input', habilitarBoton);
        document.getElementById('passwordActual').addEventListener('input', habilitarBoton);

        // Prevenir envío si no cumple validaciones
        document.getElementById('formCambioPassword').addEventListener('submit', function (e) {
            if (btnSubmit.disabled) {
                e.preventDefault();
                alert('Por favor, completa todos los requisitos antes de continuar.');
            }
        });
    </script>
</body>

</html>