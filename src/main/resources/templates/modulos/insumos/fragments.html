<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<body>

    <div th:fragment="modalMovimiento">
        <form th:action="@{/inventario/movimientos/registrar}" th:object="${movimientoDTO}" method="post">
            <div class="modal-body">
                <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

                <input type="hidden" th:field="*{insumoId}" />

                <div class="form-group">
                    <label for="tipoMovimientoId">Tipo de Movimiento</label>
                    <select id="tipoMovimientoId" th:field="*{tipoMovimientoId}" class="form-control" required>
                        <option value="">-- Seleccione un tipo --</option>
                        <option th:each="tipo : ${tiposMovimiento}" th:value="${tipo.id}" th:text="${tipo.nombre}">
                        </option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="motivoMovimientoId">Motivo</label>
                    <select id="motivoMovimientoId" th:field="*{motivoMovimientoId}" class="form-control" required>
                        <option value="">-- Seleccione un motivo --</option>
                        <option th:each="motivo : ${motivosMovimiento}" th:value="${motivo.id}"
                            th:text="${motivo.nombre}"
                            th:attr="data-tipo-id=${motivo.tipoMovimiento?.id}"></option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cantidad">Cantidad</label>
                    <input type="number" step="0.01" min="0.01" id="cantidad" th:field="*{cantidad}"
                        class="form-control" required>
                    <div class="text-danger" th:if="${#fields.hasErrors('cantidad')}" th:errors="*{cantidad}"></div>
                </div>
                <div class="form-group">
                    <label for="referencia">Referencia (Opcional)</label>
                    <input type="text" id="referencia" th:field="*{referencia}" class="form-control"
                        placeholder="Ej: Compra #123, Cita #456">
                </div>
                <div class="form-group">
                    <label for="notas">Notas (Opcional)</label>
                    <textarea id="notas" th:field="*{notas}" class="form-control" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Registrar Movimiento</button>
            </div>
        </form>
    </div>

    <div th:fragment="historialMovimientos" th:if="${paginaMovimientos}">
        <table class="table table-sm table-striped mt-3">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Motivo</th>
                    <th class="text-right">Cantidad</th>
                    <th class="text-right">Stock Anterior</th>
                    <th class="text-right">Stock Resultante</th>
                    <th>Usuario</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="mov : ${paginaMovimientos.content}">
                    <td th:text="${#temporals.format(mov.fechaCreacion, 'dd/MM/yyyy HH:mm')}"></td>
                    <td>
                        <span class="badge"
                            th:classappend="${mov.tipoMovimiento.afectaStock.name() == 'SUMA' ? 'badge-success' : 'badge-danger'}"
                            th:text="${mov.tipoMovimiento.nombre}"></span>
                    </td>
                    <td th:text="${mov.motivoMovimiento.nombre}"></td>
                    <td class="text-right"
                        th:classappend="${mov.tipoMovimiento.afectaStock.name() == 'SUMA' ? 'text-success' : 'text-danger'}"
                        th:text="${(mov.tipoMovimiento.afectaStock.name() == 'SUMA' ? '+' : '-') + mov.cantidad.toPlainString()}">
                    </td>
                    <td class="text-right" th:text="${mov.stockAnterior.toPlainString()}"></td>
                    <td class="text-right font-weight-bold" th:text="${mov.stockNuevo.toPlainString()}"></td>
                    <td th:text="${mov.creadoPor}"></td>
                </tr>
                <tr th:if="${paginaMovimientos.empty}">
                    <td colspan="7" class="text-center text-muted">Este artículo aún no tiene movimientos registrados.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

</body>

</html>