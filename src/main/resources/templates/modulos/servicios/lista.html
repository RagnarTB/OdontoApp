<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    th:replace="~{layout/base :: layout(titulo='Gestión de Servicios', contenido=~{::#contenido-principal}, scripts=~{::#page-scripts})}">

<body>
    <div id="contenido-principal">

        <style>
            .category-card {
                display: flex;
                align-items: center;
                padding: 1rem;
                border-radius: 0.75rem;
                color: white;
                transition: transform 0.2s;
            }

            .category-card:hover {
                transform: translateY(-5px);
            }

            .category-icon {
                font-size: 1.5rem;
                margin-right: 1rem;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: rgba(255, 255, 255, 0.2);
                border-radius: 0.5rem;
            }

            .table .badge {
                font-size: 0.8rem;
                padding: 0.4em 0.8em;
                color: white !important;
                font-weight: 600;
            }
        </style>

        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1>Gestión de Servicios</h1>
                        <p class="text-muted">Administra los servicios ofrecidos en tu clínica</p>
                    </div>
                    <div class="col-sm-6">
                        <button type="button" class="btn btn-outline-secondary float-sm-right shadow-sm ml-2"
                            data-toggle="modal" data-target="#modalCategoriasProc">
                            <i class="fas fa-tags mr-2"></i> Gestionar Categorías
                        </button>
                        <a th:href="@{/servicios/nuevo}" class="btn btn-primary float-sm-right shadow-sm"
                            sec:authorize="hasAuthority('CREAR_SERVICIOS')">
                            <i class="fas fa-plus mr-2"></i> Nuevo Servicio
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <section class="content">
            <div class="container-fluid">

                <div class="row mb-4">
                    <div class="col-12">
                        <h5>Resumen por categoría</h5>
                        <div class="row">
                            <div class="col-lg col-md-4 col-6 mb-3" th:each="cat : ${categoriasConteo}">
                                <div class="category-card shadow" th:styleappend="'background-color:' + ${cat.color}">
                                    <div class="category-icon"><i th:class="${cat.icono}"></i></div>
                                    <div>
                                        <h6 class="mb-0 font-weight-bold" th:text="${cat.nombre}">Consulta</h6>
                                        <small th:text="${cat.cantidadServicios} + ' servicios'">1 servicio</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert"
                    th:text="${success}"></div>
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert"
                    th:text="${error}"></div>

                <!-- Tabs para Activos/Eliminados -->
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link" th:classappend="${!mostrarEliminados} ? 'active' : ''"
                           th:href="@{/servicios}">
                            <i class="fas fa-procedures"></i> Servicios Activos
                        </a>
                    </li>
                    <li class="nav-item" sec:authorize="hasAuthority('RESTAURAR_SERVICIOS')">
                        <a class="nav-link" th:classappend="${mostrarEliminados} ? 'active' : ''"
                           th:href="@{/servicios/eliminados}">
                            <i class="fas fa-trash-restore"></i> Servicios Eliminados
                        </a>
                    </li>
                </ul>

                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="card-title font-weight-bold">
                                <span th:if="${!mostrarEliminados}">Lista de Servicios</span>
                                <span th:if="${mostrarEliminados}">Servicios Eliminados</span>
                                (<span th:text="${paginaProcedimientos.totalElements}"></span>)
                            </h3>
                            <div class="card-tools" th:if="${!mostrarEliminados}">
                                <form th:action="@{/servicios}" method="get" class="form-inline">
                                    <input type="text" name="keyword" class="form-control"
                                        placeholder="Buscar por nombre, código o descripción..." th:value="${keyword}"
                                        style="width: 300px;">
                                    <select class="form-control ml-2" name="categoriaId">
                                        <option value="">Todas las categorías</option>
                                        <option th:each="cat : ${todasLasCategorias}" th:value="${cat.id}"
                                            th:text="${cat.nombre}"
                                            th:selected="${categoriaId != null && categoriaId.toString() == cat.id.toString()}"></option>
                                    </select>
                                    <button type="submit" class="btn btn-default ml-2"><i
                                            class="fas fa-search"></i></button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>Servicio</th>
                                    <th class="text-center">Categoría</th>
                                    <th class="text-center">Duración</th>
                                    <th class="text-center">Precio</th>
                                    <th class="text-center">Estado</th>
                                    <th>Última Actualización</th>
                                    <th style="width: 120px;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="proc : ${paginaProcedimientos.content}">
                                    <td>
                                        <b th:text="${proc.nombre}">Consulta General</b><br>
                                        <small class="text-muted" th:text="${proc.codigo}">CON-001</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge"
                                            th:styleappend="'background-color:' + ${proc.categoria.color}"
                                            th:text="${proc.categoria.nombre}">Consulta</span>
                                    </td>
                                    <td class="text-center" th:text="${proc.duracionBaseMinutos} + ' min'">30 min</td>
                                    <td class="text-center"
                                        th:text="'S/. ' + ${#numbers.formatDecimal(proc.precioBase, 1, 'COMMA', 2, 'POINT')}">
                                        S/. 80</td>
                                    <td class="text-center"><span class="badge badge-success">Activo</span></td>
                                    <td th:text="${#temporals.format(proc.fechaModificacion, 'dd/MM/yyyy')}">18/6/2024
                                    </td>
                                    <td>
                                        <!-- Vista de ELIMINADOS: Solo botón restaurar -->
                                        <div th:if="${mostrarEliminados}">
                                            <a th:href="@{/servicios/restablecer/{id}(id=${proc.id})}"
                                                class="btn btn-sm btn-success" title="Restaurar Servicio"
                                                sec:authorize="hasAuthority('RESTAURAR_SERVICIOS')">
                                                <i class="fas fa-trash-restore"></i> Restaurar
                                            </a>
                                        </div>

                                        <!-- Vista NORMAL: Acciones estándar -->
                                        <div th:if="${!mostrarEliminados}">
                                            <a th:href="@{/servicios/editar/{id}(id=${proc.id})}"
                                                class="btn btn-sm btn-warning" title="Editar"
                                                data-permiso="EDITAR_SERVICIOS"
                                                data-accion-descripcion="editar servicios">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a th:href="@{/servicios/eliminar/{id}(id=${proc.id})}"
                                                class="btn btn-sm btn-danger btn-eliminar-servicio" title="Eliminar"
                                                th:data-nombre="${proc.nombre}"
                                                data-permiso="ELIMINAR_SERVICIOS"
                                                data-accion-descripcion="eliminar servicios">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                <tr th:if="${paginaProcedimientos.empty}">
                                    <td colspan="7" class="text-center text-muted">No se encontraron servicios.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginación -->
                    <div class="card-footer clearfix" th:if="${paginaProcedimientos.totalPages > 1}">
                        <ul class="pagination pagination-sm m-0 float-right">
                            <!-- Botón Primera Página -->
                            <li class="page-item" th:classappend="${paginaProcedimientos.first} ? 'disabled'">
                                <a class="page-link" th:href="@{/servicios(page=0, keyword=${keyword}, categoriaId=${categoriaId})}" aria-label="Primera">
                                    <span aria-hidden="true">&laquo;&laquo;</span>
                                </a>
                            </li>

                            <!-- Botón Anterior -->
                            <li class="page-item" th:classappend="${!paginaProcedimientos.hasPrevious()} ? 'disabled'">
                                <a class="page-link" th:href="@{/servicios(page=${paginaProcedimientos.number - 1}, keyword=${keyword}, categoriaId=${categoriaId})}" aria-label="Anterior">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>

                            <!-- Números de página -->
                            <li class="page-item"
                                th:each="i : ${#numbers.sequence(0, paginaProcedimientos.totalPages - 1)}"
                                th:if="${i >= paginaProcedimientos.number - 2 && i <= paginaProcedimientos.number + 2}"
                                th:classappend="${i == paginaProcedimientos.number} ? 'active'">
                                <a class="page-link" th:href="@{/servicios(page=${i}, keyword=${keyword}, categoriaId=${categoriaId})}" th:text="${i + 1}">1</a>
                            </li>

                            <!-- Botón Siguiente -->
                            <li class="page-item" th:classappend="${!paginaProcedimientos.hasNext()} ? 'disabled'">
                                <a class="page-link" th:href="@{/servicios(page=${paginaProcedimientos.number + 1}, keyword=${keyword}, categoriaId=${categoriaId})}" aria-label="Siguiente">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>

                            <!-- Botón Última Página -->
                            <li class="page-item" th:classappend="${paginaProcedimientos.last} ? 'disabled'">
                                <a class="page-link" th:href="@{/servicios(page=${paginaProcedimientos.totalPages - 1}, keyword=${keyword}, categoriaId=${categoriaId})}" aria-label="Última">
                                    <span aria-hidden="true">&raquo;&raquo;</span>
                                </a>
                            </li>
                        </ul>

                        <div class="float-left">
                            <span class="text-muted">
                                Mostrando <b th:text="${paginaProcedimientos.numberOfElements}"></b> de <b th:text="${paginaProcedimientos.totalElements}"></b> servicios
                                (Página <b th:text="${paginaProcedimientos.number + 1}"></b> de <b th:text="${paginaProcedimientos.totalPages}"></b>)
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Modal para Gestión de Categorías de Procedimientos -->
        <div class="modal fade" id="modalCategoriasProc" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Gestión de Categorías</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" id="contenidoModalCategoriaProc">
                        <!-- Se cargará dinámicamente vía AJAX -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="page-scripts" th:fragment="scripts">
        <script th:inline="javascript">
            // Cargar gestión de categorías al abrir el modal
            $('#modalCategoriasProc').on('show.bs.modal', function () {
                cargarGestionCategoriasProc();
            });

        function cargarGestionCategoriasProc() {
            $.get('/categorias-procedimiento/gestion', function(data) {
                $('#contenidoModalCategoriaProc').html(data);
            }).fail(function() {
                $('#contenidoModalCategoriaProc').html('<div class="alert alert-danger">Error al cargar categorías.</div>');
            });
        }

        function cargarFormularioCategoriaProc(url) {
            $.get(url, function(data) {
                $('#contenidoModalCategoriaProc').html(data);
            }).fail(function() {
                $('#contenidoModalCategoriaProc').html('<div class="alert alert-danger">Error al cargar el formulario.</div>');
            });
        }

        // Confirmación de eliminación con SweetAlert2
        $(document).on('click', '.btn-eliminar-servicio', function(e) {
            e.preventDefault();
            const url = $(this).attr('href');
            const nombre = $(this).data('nombre');

            confirmarEliminacion(nombre).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = url;
                }
            });
        });

        // Confirmación de eliminación de categoría de procedimiento
        $(document).on('click', '.btn-eliminar-cat-proc', function(e) {
            e.preventDefault();
            const url = $(this).data('url');
            const nombre = $(this).data('nombre');

            confirmarEliminacion(nombre).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = url;
                }
            });
        });
        </script>
    </div>
</body>

</html>