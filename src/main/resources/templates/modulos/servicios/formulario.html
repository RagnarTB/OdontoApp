<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    th:replace="~{layout/base :: layout(titulo='Formulario de Servicio', contenido=~{::#contenido-principal})}">

<body>
    <div id="contenido-principal">

        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 th:if="${procedimientoDTO.id == null}">Nuevo Servicio</h1>
                        <h1 th:unless="${procedimientoDTO.id == null}">Editar Servicio</h1>
                    </div>
                    <div class="col-sm-6">
                        <a th:href="@{/servicios}" class="btn btn-outline-secondary float-sm-right">
                            <i class="fas fa-arrow-left mr-2"></i> Volver al Listado
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <section class="content">
            <div class="container-fluid">
                <div class="card card-primary card-outline shadow-sm">
                    <div class="card-header">
                        <h3 class="card-title">Datos del Servicio</h3>
                    </div>
                    <form th:action="@{/servicios/guardar}" th:object="${procedimientoDTO}" method="post">
                        <input type="hidden" th:field="*{id}" />

                        <div class="card-body">
                            <div th:if="${error}" class="alert alert-danger" role="alert" th:text="${error}"></div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="codigo">Código del Servicio</label>
                                        <input type="text" class="form-control" id="codigo" th:field="*{codigo}"
                                            placeholder="Ej: LIM-001" required>
                                        <div class="text-danger" th:if="${#fields.hasErrors('codigo')}"
                                            th:errors="*{codigo}"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="nombre">Nombre del Servicio</label>
                                        <input type="text" class="form-control" id="nombre" th:field="*{nombre}"
                                            placeholder="Ej: Limpieza Dental (Profilaxis)" required>
                                        <div class="text-danger" th:if="${#fields.hasErrors('nombre')}"
                                            th:errors="*{nombre}"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="categoriaId">Categoría</label>
                                        <select class="form-control" id="categoriaId" th:field="*{categoriaId}"
                                            required>
                                            <option value="">-- Seleccione una categoría --</option>
                                            <option th:each="cat : ${categorias}" th:value="${cat.id}"
                                                th:text="${cat.nombre}"></option>
                                        </select>
                                        <div class="text-danger" th:if="${#fields.hasErrors('categoriaId')}"
                                            th:errors="*{categoriaId}"></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="duracionBaseMinutos">Duración (minutos)</label>
                                        <input type="number" class="form-control" id="duracionBaseMinutos"
                                            th:field="*{duracionBaseMinutos}" placeholder="Ej: 45"
                                            data-validar="numeros"
                                            min="1"
                                            required>
                                        <div class="text-danger" th:if="${#fields.hasErrors('duracionBaseMinutos')}"
                                            th:errors="*{duracionBaseMinutos}"></div>
                                        <small class="form-text text-muted">Solo números enteros positivos</small>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="precioBase">Precio Base (S/.)</label>
                                        <input type="number" step="0.01" class="form-control" id="precioBase"
                                            th:field="*{precioBase}" placeholder="Ej: 120.00"
                                            data-validar="decimal"
                                            data-max-decimals="2"
                                            min="0"
                                            required>
                                        <div class="text-danger" th:if="${#fields.hasErrors('precioBase')}"
                                            th:errors="*{precioBase}"></div>
                                        <small class="form-text text-muted">Números con hasta 2 decimales</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="descripcion">Descripción (Opcional)</label>
                                        <textarea class="form-control" id="descripcion" th:field="*{descripcion}"
                                            rows="3"
                                            placeholder="Añada una breve descripción del servicio..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Sección de Insumos -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <h5 class="border-bottom pb-2 mb-3">
                                        <i class="fas fa-box-open mr-2"></i>Insumos del Procedimiento
                                    </h5>
                                    <p class="text-muted small">Configure los insumos que se utilizan por defecto en este procedimiento</p>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label for="insumoSelector">Insumo</label>
                                        <select class="form-control" id="insumoSelector">
                                            <option value="">-- Seleccione un insumo --</option>
                                            <option th:each="insumo : ${insumos}"
                                                th:value="${insumo.id}"
                                                th:text="${insumo.nombre + ' (' + insumo.codigo + ')'}"
                                                th:attr="data-unidad=${insumo.unidadMedida.abreviatura}"></option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label for="cantidadInsumo">Cantidad</label>
                                        <input type="number" class="form-control" id="cantidadInsumo"
                                            placeholder="1.0" step="0.01" min="0.01">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label for="unidadInsumo">Unidad</label>
                                        <input type="text" class="form-control" id="unidadInsumo"
                                            placeholder="unid" readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="d-block">&nbsp;</label>
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input"
                                                id="esObligatorioInsumo" checked>
                                            <label class="custom-control-label" for="esObligatorioInsumo">
                                                Obligatorio
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="d-block">&nbsp;</label>
                                        <button type="button" class="btn btn-success btn-block" id="btnAgregarInsumo">
                                            <i class="fas fa-plus"></i> Agregar
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover table-bordered">
                                            <thead class="thead-light">
                                                <tr>
                                                    <th>Insumo</th>
                                                    <th width="100">Cantidad</th>
                                                    <th width="80">Unidad</th>
                                                    <th width="100">Tipo</th>
                                                    <th width="80">Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tablaInsumosBody">
                                                <tr id="msgSinInsumos">
                                                    <td colspan="5" class="text-center text-muted">
                                                        <i class="fas fa-info-circle"></i> No se han agregado insumos
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden inputs para los insumos que se enviarán con el formulario -->
                            <div id="insumosHiddenInputs"></div>
                        </div>

                        <div class="card-footer">
                            <button type="submit" class="btn btn-primary shadow-sm">
                                <i class="fas fa-save mr-2"></i> Guardar Servicio
                            </button>
                            <a th:href="@{/servicios}" class="btn btn-secondary">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>
        </section>
    </div>

    <script th:inline="javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
        // Array para mantener los insumos agregados
        let insumosAgregados = [];

        // Cargar insumos existentes si estamos editando
        const procedimientoId = /*[[${procedimientoDTO.id}]]*/ null;
        if (procedimientoId) {
            cargarInsumosExistentes(procedimientoId);
        }

        // Cuando se selecciona un insumo, cargar su unidad
        $('#insumoSelector').on('change', function() {
            const unidad = $(this).find(':selected').data('unidad');
            $('#unidadInsumo').val(unidad || '');
        });

        // Botón agregar insumo
        $('#btnAgregarInsumo').on('click', function(e) {
            e.preventDefault(); // Prevenir submit del formulario
            console.log('Botón agregar insumo clickeado');

            const insumoId = $('#insumoSelector').val();
            const insumoNombre = $('#insumoSelector option:selected').text();
            const cantidad = parseFloat($('#cantidadInsumo').val());
            const unidad = $('#unidadInsumo').val();
            const esObligatorio = $('#esObligatorioInsumo').is(':checked');

            console.log('Datos:', { insumoId, insumoNombre, cantidad, unidad, esObligatorio });

            // Validaciones
            if (!insumoId) {
                alert('Debe seleccionar un insumo');
                return false;
            }
            if (!cantidad || cantidad <= 0) {
                alert('Debe ingresar una cantidad válida');
                return false;
            }
            if (!unidad) {
                alert('La unidad de medida no está definida');
                return false;
            }

            // Verificar si ya existe
            if (insumosAgregados.find(i => i.insumoId == insumoId)) {
                alert('Este insumo ya ha sido agregado');
                return false;
            }

            // Agregar al array
            insumosAgregados.push({
                insumoId: insumoId,
                insumoNombre: insumoNombre,
                cantidad: cantidad,
                unidad: unidad,
                esObligatorio: esObligatorio
            });

            console.log('Insumo agregado. Total:', insumosAgregados.length);

            // Actualizar tabla
            actualizarTablaInsumos();

            // Limpiar campos
            $('#insumoSelector').val('');
            $('#cantidadInsumo').val('');
            $('#unidadInsumo').val('');
            $('#esObligatorioInsumo').prop('checked', true);

            return false;
        });

        // Función para actualizar la tabla de insumos
        function actualizarTablaInsumos() {
            const tbody = $('#tablaInsumosBody');
            tbody.empty();

            if (insumosAgregados.length === 0) {
                tbody.append(`
                    <tr id="msgSinInsumos">
                        <td colspan="5" class="text-center text-muted">
                            <i class="fas fa-info-circle"></i> No se han agregado insumos
                        </td>
                    </tr>
                `);
            } else {
                insumosAgregados.forEach((insumo, index) => {
                    const tipoBadge = insumo.esObligatorio
                        ? '<span class="badge badge-danger">Obligatorio</span>'
                        : '<span class="badge badge-secondary">Opcional</span>';

                    tbody.append(`
                        <tr>
                            <td>${insumo.insumoNombre}</td>
                            <td>${insumo.cantidad}</td>
                            <td>${insumo.unidad}</td>
                            <td>${tipoBadge}</td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-danger" onclick="eliminarInsumo(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                });
            }

            // Actualizar hidden inputs
            actualizarHiddenInputs();
        }

        // Función para eliminar insumo (global para que pueda ser llamada desde onclick)
        window.eliminarInsumo = function(index) {
            insumosAgregados.splice(index, 1);
            actualizarTablaInsumos();
        };

        // Función para actualizar los hidden inputs que se enviarán con el formulario
        function actualizarHiddenInputs() {
            const container = $('#insumosHiddenInputs');
            container.empty();

            insumosAgregados.forEach((insumo, index) => {
                container.append(`
                    <input type="hidden" name="insumos[${index}].insumoId" value="${insumo.insumoId}" />
                    <input type="hidden" name="insumos[${index}].cantidad" value="${insumo.cantidad}" />
                    <input type="hidden" name="insumos[${index}].unidad" value="${insumo.unidad}" />
                    <input type="hidden" name="insumos[${index}].esObligatorio" value="${insumo.esObligatorio}" />
                `);
            });
        }

        // Cargar insumos existentes al editar
        function cargarInsumosExistentes(procedimientoId) {
            $.get(`/procedimientos/${procedimientoId}/insumos`, function(data) {
                if (data && data.length > 0) {
                    data.forEach(function(insumoData) {
                        insumosAgregados.push({
                            insumoId: insumoData.insumoId,
                            insumoNombre: insumoData.insumoNombre,
                            cantidad: insumoData.cantidadDefecto,
                            unidad: insumoData.unidad,
                            esObligatorio: insumoData.esObligatorio
                        });
                    });
                    actualizarTablaInsumos();
                }
            }).fail(function(xhr, status, error) {
                console.error('Error al cargar insumos existentes:', error);
            });
        }
    });
    /*]]>*/
    </script>
</body>

</html>