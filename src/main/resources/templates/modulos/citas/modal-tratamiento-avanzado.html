<!-- Modal Registrar Tratamiento AVANZADO -->
<div th:fragment="modalRegistrarTratamiento" class="modal fade" id="modalRegistrarTratamiento" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-tooth mr-2"></i>Registrar Tratamiento Dental
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <input type="hidden" id="tratamientoCitaId" name="citaId">
                <input type="hidden" id="tratamientoPlanificadoId" name="tratamientoPlanificadoId">

                <!-- Informaci√≥n Precargada de la Cita -->
                <div class="alert alert-info mb-3 py-2">
                    <small>
                        <strong><i class="fas fa-info-circle mr-1"></i></strong>
                        <span id="infoCitaPaciente"></span> | <span id="infoCitaOdontologo"></span> | <span id="infoCitaFecha"></span>
                    </small>
                </div>

                <!-- Procedimiento Selection -->
                <div class="form-group">
                    <label for="tratamientoProcedimientoId" class="font-weight-bold">Procedimiento <span class="text-danger">*</span></label>
                    <select class="form-control form-control-sm" id="tratamientoProcedimientoId" required>
                        <option value="">Seleccione un procedimiento...</option>
                        <option th:each="proc : ${listaProcedimientos}"
                                th:value="${proc.id}"
                                th:data-codigo="${proc.codigo}"
                                th:attr="data-duracion=${proc.duracionBaseMinutos}"
                                th:text="${proc.codigo + ' - ' + proc.nombre + ' (' + proc.duracionBaseMinutos + ' min)'}"></option>
                    </select>
                </div>

                <!-- Selector Visual de Dientes (FDI) - Compacto -->
                <div class="card card-outline card-primary mb-2" id="selectorDientes" style="display:none;">
                    <div class="card-header py-1">
                        <h6 class="mb-0" style="font-size: 0.9rem;"><i class="fas fa-teeth mr-1"></i>Pieza(s) Dental(es)</h6>
                    </div>
                    <div class="card-body text-center py-2">
                        <small class="text-muted d-block mb-1" style="font-size: 0.7rem;">MAXILAR SUPERIOR</small>
                        <div class="mb-1">
                            <div class="btn-group mr-1 btn-group-sm" id="cuadrante-1"></div>
                            <span class="mx-1">|</span>
                            <div class="btn-group btn-group-sm" id="cuadrante-2"></div>
                        </div>
                        <hr class="my-1">
                        <small class="text-muted d-block mb-1" style="font-size: 0.7rem;">MAXILAR INFERIOR</small>
                        <div>
                            <div class="btn-group mr-1 btn-group-sm" id="cuadrante-4"></div>
                            <span class="mx-1">|</span>
                            <div class="btn-group btn-group-sm" id="cuadrante-3"></div>
                        </div>
                        <input type="hidden" id="tratamientoPiezasDentales" name="piezasDentales">
                        <small class="form-text text-muted mt-1" style="font-size: 0.75rem;">
                            <strong>Seleccionados:</strong> <span id="dientesSeleccionados">Ninguno</span>
                        </small>
                    </div>
                </div>

                <!-- Campos Din√°micos por Procedimiento -->
                <div id="camposDinamicos"></div>

                <!-- Insumos Incluidos en el Procedimiento - Compacto -->
                <div class="card card-outline card-secondary mb-2" id="seccionInsumos" style="display:none;">
                    <div class="card-header py-1">
                        <h6 class="mb-0" style="font-size: 0.9rem;"><i class="fas fa-box mr-1"></i>Insumos</h6>
                    </div>
                    <div class="card-body py-2">
                        <div class="table-responsive" style="max-height: 150px; overflow-y: auto;">
                            <table class="table table-sm table-bordered mb-0" style="font-size: 0.85rem;">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Insumo</th>
                                        <th width="60">Cant.</th>
                                        <th width="60">Unidad</th>
                                        <th width="80">Tipo</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaInsumosDefault">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">
                                            Seleccione un procedimiento
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="btnAgregarInsumoAdicional">
                            <i class="fas fa-plus mr-1"></i>Agregar Insumo
                        </button>
                    </div>
                </div>

                <!-- Descripci√≥n General -->
                <div class="form-group mb-2">
                    <label for="tratamientoDescripcion" class="font-weight-bold">Observaciones</label>
                    <textarea class="form-control form-control-sm" id="tratamientoDescripcion" rows="2"
                              placeholder="Observaciones adicionales"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-info" id="btnPlanificarTratamiento" data-loading-text="Planificando tratamiento...">
                    <i class="fas fa-calendar-plus mr-1"></i>Planificar para Despu√©s
                </button>
                <button type="button" class="btn btn-success" id="btnRealizarInmediato" data-loading-text="Registrando tratamiento...">
                    <i class="fas fa-check-circle mr-1"></i>Tratamiento Realizado Ahora
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Script del modal de tratamiento (se incluye en el bloque scripts del layout) -->
<th:block th:fragment="scriptModalTratamiento">
<script th:inline="javascript">
/*<![CDATA[*/
$(document).ready(function() {
    console.log('‚úÖ Inicializando modal de tratamiento (jQuery disponible)...'); // Debug
    // Configurar token CSRF para todas las peticiones AJAX
    var token = $("meta[name='_csrf']").attr("content");
    var header = $("meta[name='_csrf_header']").attr("content");
    $.ajaxSetup({
        beforeSend: function(xhr) {
            xhr.setRequestHeader(header, token);
        }
    });

    let citaDatos = {};
    let dientesSeleccionadosArray = [];

    // FDI Tooth Structure
    const cuadrantes = {
        1: [18, 17, 16, 15, 14, 13, 12, 11],
        2: [21, 22, 23, 24, 25, 26, 27, 28],
        3: [31, 32, 33, 34, 35, 36, 37, 38],
        4: [48, 47, 46, 45, 44, 43, 42, 41]
    };

    // Procedimientos que requieren selector de dientes
    // Todos excepto blanqueamiento (EST-001) y controles generales
    const procedimientosConDientes = ['END-001', 'END-002', 'IMP-001', 'IMP-002',
                                       'EST-002', 'CIR-001', 'CIR-002'];

    // Generar selector de dientes
    function generarSelectorDientes() {
        Object.keys(cuadrantes).forEach(function(cuad) {
            let html = '';
            cuadrantes[cuad].forEach(function(num) {
                html += `<button type="button" class="btn btn-outline-secondary btn-sm btn-diente"
                                data-diente="${num}">${num}</button>`;
            });
            $(`#cuadrante-${cuad}`).html(html);
        });
    }

    // Click en diente
    $(document).on('click', '.btn-diente', function() {
        const diente = $(this).data('diente');
        if ($(this).hasClass('active')) {
            $(this).removeClass('active');
            dientesSeleccionadosArray = dientesSeleccionadosArray.filter(d => d != diente);
        } else {
            $(this).addClass('active');
            dientesSeleccionadosArray.push(diente);
        }
        $('#dientesSeleccionados').text(dientesSeleccionadosArray.length > 0 ?
            dientesSeleccionadosArray.join(', ') : 'Ninguno');
        $('#tratamientoPiezasDentales').val(dientesSeleccionadosArray.join(','));
    });

    // Al abrir modal (desde detalle de cita)
    $('#modalRegistrarTratamiento').on('show.bs.modal', function() {
        // Cargar datos de la cita directamente sin verificar si ya existe tratamiento
        const citaId = $('#detalleCitaId').val();

        if (citaId) {
            continuarCargaModal(citaId);
        } else {
            continuarCargaModal(null);
        }
    });

    // Funci√≥n auxiliar para cargar el modal
    function continuarCargaModal(citaId) {
        // Limpiar form
        $('#tratamientoProcedimientoId').val('');
        $('#tratamientoDescripcion').val('');
        $('#camposDinamicos').html('');
        $('#selectorDientes').hide();
        $('#seccionInsumos').hide();
        dientesSeleccionadosArray = [];
        $('.btn-diente').removeClass('active');
        $('#dientesSeleccionados').text('Ninguno');
        $('#tratamientoPiezasDentales').val('');

        // Limpiar insumos adicionales
        $('.insumo-adicional').remove();
        contadorInsumosAdicionales = 0;

        if (citaId) {
            $('#tratamientoCitaId').val(citaId);

            // Cargar informaci√≥n de la cita y guardar en citaDatos
            const paciente = $('#detallePaciente').text();
            const pacienteId = $('#detallePacienteId').val();
            const odontologo = $('#detalleOdontologo').text();
            const odontologoId = $('#detalleOdontologoId').val();
            const fecha = $('#detalleFecha').val();
            const hora = $('#detalleHora').val();
            const procedimientoId = $('#detalleProcedimientoId').val();
            const procedimiento = $('#detalleProcedimiento').text();

            // **GUARDAR EN citaDatos para uso posterior**
            citaDatos = {
                id: citaId,
                pacienteNombre: paciente,
                pacienteId: pacienteId,
                odontologoNombre: odontologo,
                odontologoId: odontologoId,
                procedimientoId: procedimientoId,
                procedimientoNombre: procedimiento,
                fecha: fecha,
                hora: hora
            };

            console.log('Datos de la cita cargados:', citaDatos); // Debug

            $('#infoCitaPaciente').text(paciente);
            $('#infoCitaOdontologo').text(odontologo);
            $('#infoCitaFecha').text(fecha + ' ' + hora);

            // Si hay procedimiento asociado, pre-seleccionarlo
            if (procedimientoId) {
                $('#tratamientoProcedimientoId').val(procedimientoId);
                // Trigger change para cargar campos din√°micos e insumos
                $('#tratamientoProcedimientoId').trigger('change');
            }
        }
    }

    // Cambio de procedimiento
    $('#tratamientoProcedimientoId').on('change', function() {
        const codigo = $(this).find(':selected').data('codigo');
        const procId = $(this).val();

        // Mostrar selector de dientes si aplica
        if (procedimientosConDientes.includes(codigo)) {
            $('#selectorDientes').show();
            generarSelectorDientes();
        } else {
            $('#selectorDientes').hide();
        }

        // Cargar campos din√°micos
        cargarCamposDinamicos(codigo);

        // Cargar insumos del procedimiento
        if (procId) {
            cargarInsumosProcedimiento(procId);
        }
    });

    // Campos din√°micos por procedimiento
    function cargarCamposDinamicos(codigo) {
        let html = '';

        switch(codigo) {
            case 'CON-001': // Consulta General
                html = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Motivo Consulta</label>
                                <input type="text" class="form-control" name="motivo" placeholder="Ej: Dolor molar">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Diagn√≥stico</label>
                                <input type="text" class="form-control" name="diagnostico">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Observaciones</label>
                        <textarea class="form-control" name="observaciones" rows="2"></textarea>
                    </div>
                `;
                break;

            case 'CON-002': // Consulta Emergencia
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Motivo Emergencia</label>
                                <input type="text" class="form-control" name="motivo" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Nivel Dolor (1-10)</label>
                                <input type="number" class="form-control" name="nivelDolor" min="1" max="10" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Tratamiento Inmediato</label>
                                <input type="text" class="form-control" name="tratamientoInmediato">
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'END-001': // Endodoncia Molar
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>N¬∫ Conductos</label>
                                <input type="number" class="form-control" name="numConductos" value="3" min="1" max="5">
                                <small class="text-muted">Molares: 3-4 conductos t√≠picamente</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>T√©cnica</label>
                                <select class="form-control" name="tecnica">
                                    <option>Convencional</option>
                                    <option>Rotatoria</option>
                                    <option>Mixta</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Radiograf√≠a</label>
                                <select class="form-control" name="radiografia">
                                    <option value="SI">S√≠ - Tomada</option>
                                    <option value="NO">No</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'ORT-001': // Instalaci√≥n Brackets
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Tipo Brackets</label>
                                <select class="form-control" name="tipoBrackets">
                                    <option>Met√°licos</option>
                                    <option>Cer√°micos</option>
                                    <option>Zafiro</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Arcada</label>
                                <select class="form-control" name="arcada">
                                    <option>Superior</option>
                                    <option>Inferior</option>
                                    <option>Ambas</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Plan Tratamiento</label>
                                <input type="text" class="form-control" name="planTratamiento" placeholder="Ej: 18 meses">
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'END-002': // Endodoncia Unirradicular
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>N¬∫ Conductos</label>
                                <input type="number" class="form-control" name="numConductos" value="1" min="1" max="2">
                                <small class="text-muted">Anteriores/Premolares: 1-2 conductos</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>T√©cnica</label>
                                <select class="form-control" name="tecnica">
                                    <option>Convencional</option>
                                    <option>Rotatoria</option>
                                    <option>Mixta</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Obturaci√≥n</label>
                                <select class="form-control" name="obturacion">
                                    <option>Gutapercha</option>
                                    <option>Resina Termopl√°stica</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'ORT-002': // Control Ortodoncia
                html = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Actividades Realizadas</label>
                                <select class="form-control" name="actividades" multiple size="3">
                                    <option>Cambio de arco</option>
                                    <option>Ajuste de ligaduras</option>
                                    <option>Colocaci√≥n de el√°sticos</option>
                                    <option>Revisi√≥n general</option>
                                </select>
                                <small class="text-muted">Mantenga Ctrl para seleccionar varios</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Avance del Tratamiento</label>
                                <input type="number" class="form-control" name="avancePorcentaje" min="0" max="100" placeholder="%">
                                <small class="text-muted">Porcentaje completado</small>
                            </div>
                            <div class="form-group mt-2">
                                <label>Pr√≥ximo Control</label>
                                <input type="date" class="form-control" name="proximoControl">
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'PER-001': // Limpieza Dental B√°sica
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>T√©cnica Utilizada</label>
                                <select class="form-control" name="tecnica">
                                    <option>Ultrasonido</option>
                                    <option>Manual</option>
                                    <option>Combinada</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Nivel de Placa</label>
                                <select class="form-control" name="nivelPlaca">
                                    <option>Bajo</option>
                                    <option>Moderado</option>
                                    <option>Alto</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Aplicaci√≥n de Fl√∫or</label>
                                <select class="form-control" name="fluor">
                                    <option value="SI">S√≠</option>
                                    <option value="NO">No</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'PER-002': // Limpieza Profunda (Curetaje)
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Cuadrantes Tratados</label>
                                <select class="form-control" name="cuadrantes" multiple size="4">
                                    <option value="1">Cuadrante 1 (Superior Derecho)</option>
                                    <option value="2">Cuadrante 2 (Superior Izquierdo)</option>
                                    <option value="3">Cuadrante 3 (Inferior Izquierdo)</option>
                                    <option value="4">Cuadrante 4 (Inferior Derecho)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Anestesia</label>
                                <select class="form-control" name="anestesia">
                                    <option>Local infiltrativa</option>
                                    <option>Troncular</option>
                                    <option>No se requiri√≥</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Profundidad Bolsas (mm)</label>
                                <input type="number" class="form-control" name="profundidadBolsas" min="1" max="15" placeholder="Ej: 5">
                                <small class="text-muted">Promedio de profundidad</small>
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'IMP-001': // Instalaci√≥n de Implante
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Marca del Implante</label>
                                <select class="form-control" name="marca">
                                    <option>Straumann</option>
                                    <option>Nobel Biocare</option>
                                    <option>Zimmer</option>
                                    <option>Otra</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Di√°metro (mm)</label>
                                <input type="number" class="form-control" name="diametro" step="0.1" placeholder="Ej: 4.0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Longitud (mm)</label>
                                <input type="number" class="form-control" name="longitud" step="0.5" placeholder="Ej: 10.0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Injerto √ìseo</label>
                                <select class="form-control" name="injertoOseo">
                                    <option value="NO">No requerido</option>
                                    <option value="SI">S√≠ - Realizado</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Torque de Inserci√≥n (Ncm)</label>
                                <input type="number" class="form-control" name="torque" placeholder="Ej: 35">
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'IMP-002': // Corona sobre Implante
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Tipo de Corona</label>
                                <select class="form-control" name="tipoCorona">
                                    <option>Porcelana</option>
                                    <option>Zirconio</option>
                                    <option>Metal-Porcelana</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Color</label>
                                <input type="text" class="form-control" name="color" placeholder="Ej: A2">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Tipo de Fijaci√≥n</label>
                                <select class="form-control" name="fijacion">
                                    <option>Atornillada</option>
                                    <option>Cementada</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'EST-001': // Blanqueamiento Dental
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Tipo de Blanqueamiento</label>
                                <select class="form-control" name="tipoBlanqueamiento">
                                    <option>LED (consultorio)</option>
                                    <option>L√°ser (consultorio)</option>
                                    <option>Ambulatorio (f√©rulas)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Concentraci√≥n Gel</label>
                                <select class="form-control" name="concentracion">
                                    <option>10% Per√≥xido Carbamida</option>
                                    <option>16% Per√≥xido Carbamida</option>
                                    <option>35% Per√≥xido Hidr√≥geno</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Sesiones Programadas</label>
                                <input type="number" class="form-control" name="sesiones" min="1" max="6" value="3">
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'EST-002': // Carillas de Resina
                html = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Material Utilizado</label>
                                <select class="form-control" name="material">
                                    <option>Resina Nanoparticulada</option>
                                    <option>Resina Microh√≠brida</option>
                                    <option>Resina Nanocer√°mica</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Color/Tono</label>
                                <input type="text" class="form-control" name="color" placeholder="Ej: A2, B1">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>T√©cnica de Adhesi√≥n</label>
                        <input type="text" class="form-control" name="tecnicaAdhesion" placeholder="Ej: Grabado √°cido + adhesivo universal">
                    </div>
                `;
                break;

            case 'CIR-001': // Extracci√≥n Simple
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Motivo Extracci√≥n</label>
                                <select class="form-control" name="motivo">
                                    <option>Caries avanzada</option>
                                    <option>Fractura</option>
                                    <option>Movilidad</option>
                                    <option>Periodontal</option>
                                    <option>Ortod√≥ntico</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Tipo Anestesia</label>
                                <select class="form-control" name="anestesia">
                                    <option>Local infiltrativa</option>
                                    <option>Troncular</option>
                                    <option>Ambas</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Sutura</label>
                                <select class="form-control" name="sutura">
                                    <option value="NO">No requerida</option>
                                    <option value="SI">S√≠ - Realizada</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'CIR-002': // Extracci√≥n Quir√∫rgica
                html = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Tipo de Extracci√≥n</label>
                                <select class="form-control" name="tipoExtraccion">
                                    <option>Cordal incluido</option>
                                    <option>Cordal semi-incluido</option>
                                    <option>Quiste dent√≠gero</option>
                                    <option>Resto radicular</option>
                                    <option>Otra cirug√≠a compleja</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Incisi√≥n Realizada</label>
                                <select class="form-control" name="incision">
                                    <option>Colgajo triangular</option>
                                    <option>Colgajo trapezoidal</option>
                                    <option>Colgajo rectangular</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Osteotom√≠a</label>
                                <select class="form-control" name="osteotomia">
                                    <option value="NO">No</option>
                                    <option value="SI">S√≠</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Odontosecci√≥n</label>
                                <select class="form-control" name="odontoseccion">
                                    <option value="NO">No</option>
                                    <option value="SI">S√≠</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Puntos de Sutura</label>
                                <input type="number" class="form-control" name="puntosSutura" min="0" placeholder="Ej: 3">
                            </div>
                        </div>
                    </div>
                `;
                break;
        }

        $('#camposDinamicos').html(html);
    }

    // Cargar insumos del procedimiento
    function cargarInsumosProcedimiento(procId) {
        $.get(`/procedimientos/${procId}/insumos`, function(insumos) {
            if (insumos && insumos.length > 0) {
                let html = '';
                insumos.forEach(function(ins) {
                    const tipoBadge = ins.esObligatorio ? 'danger' : 'secondary';
                    const tipoTexto = ins.esObligatorio ? 'Oblig.' : 'Opc.';
                    html += `
                        <tr>
                            <td>${ins.insumoNombre}</td>
                            <td><input type="number" class="form-control form-control-sm"
                                       value="${ins.cantidadDefecto}"
                                       min="0"
                                       step="0.01"
                                       style="width:50px;"
                                       data-insumo-id="${ins.insumoId}"></td>
                            <td>${ins.unidad}</td>
                            <td><span class="badge badge-${tipoBadge}" style="font-size:0.7rem;">${tipoTexto}</span></td>
                        </tr>
                    `;
                });
                $('#tablaInsumosDefault').html(html);
                $('#seccionInsumos').show();
            } else {
                $('#seccionInsumos').hide();
            }
        }).fail(function() {
            $('#seccionInsumos').hide();
        });
    }

    // Contador para insumos adicionales
    let contadorInsumosAdicionales = 0;
    let insumosDisponibles = [];

    // Cargar lista de insumos al inicio
    function cargarInsumosDisponibles() {
        $.get('/tratamientos/insumos', function(insumos) {
            insumosDisponibles = insumos;
            console.log('Insumos cargados:', insumosDisponibles.length);
        }).fail(function() {
            console.error('Error cargando lista de insumos');
        });
    }

    // Cargar insumos al inicializar
    cargarInsumosDisponibles();

    // Agregar insumo adicional
    $(document).on('click', '#btnAgregarInsumoAdicional', function() {
        console.log('Agregando insumo adicional...');

        if (insumosDisponibles.length === 0) {
            if (typeof Swal !== 'undefined') {
                Swal.fire('Advertencia', 'No hay insumos disponibles en el sistema', 'warning');
            } else {
                alert('No hay insumos disponibles en el sistema');
            }
            return;
        }

        contadorInsumosAdicionales++;

        // Construir options del select
        let optionsHtml = '<option value="">Seleccione insumo...</option>';
        insumosDisponibles.forEach(function(insumo) {
            const stockInfo = insumo.stockActual > 0 ? `(Stock: ${insumo.stockActual})` : '(Sin stock)';
            optionsHtml += `<option value="${insumo.id}" data-unidad="${insumo.unidad}" data-precio="${insumo.precioUnitario || 0}">
                ${insumo.codigo} - ${insumo.nombre} ${stockInfo}
            </option>`;
        });

        const nuevaFila = `
            <tr class="insumo-adicional" data-id="${contadorInsumosAdicionales}">
                <td>
                    <select class="form-control form-control-sm select-insumo-adicional" required>
                        ${optionsHtml}
                    </select>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm insumo-cantidad" value="1" min="0.1" step="0.1" style="width:50px;">
                </td>
                <td class="insumo-unidad-display">-</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger btn-eliminar-insumo" style="padding:0.1rem 0.3rem; font-size:0.7rem;">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            </tr>
        `;

        $('#tablaInsumosDefault').append(nuevaFila);

        if (typeof Swal !== 'undefined') {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Insumo agregado',
                showConfirmButton: false,
                timer: 1500
            });
        }
    });

    // Cuando se selecciona un insumo, actualizar la unidad
    $(document).on('change', '.select-insumo-adicional', function() {
        const unidad = $(this).find(':selected').data('unidad');
        $(this).closest('tr').find('.insumo-unidad-display').text(unidad || '-');
    });

    // Eliminar insumo adicional
    $(document).on('click', '.btn-eliminar-insumo', function() {
        $(this).closest('tr').remove();
    });

    // Bot√≥n Tratamiento Inmediato (usar delegaci√≥n de eventos)
    $(document).off('click', '#btnRealizarInmediato').on('click', '#btnRealizarInmediato', function() {
        console.log('Bot√≥n Realizar Inmediato clickeado'); // Debug

        // Validar que se haya seleccionado un procedimiento
        const procedimientoId = $('#tratamientoProcedimientoId').val();
        console.log('Procedimiento ID:', procedimientoId); // Debug

        if (!procedimientoId) {
            if (typeof Swal !== 'undefined') {
                Swal.fire('Advertencia', 'Debe seleccionar un procedimiento antes de registrar el tratamiento', 'warning');
            } else {
                alert('Debe seleccionar un procedimiento antes de registrar el tratamiento');
            }
            return;
        }

        // Validar que haya una cita asociada
        const citaId = $('#tratamientoCitaId').val();
        console.log('Cita ID:', citaId); // Debug

        if (!citaId) {
            if (typeof Swal !== 'undefined') {
                Swal.fire('Error', 'No se encontr√≥ la informaci√≥n de la cita', 'error');
            } else {
                alert('No se encontr√≥ la informaci√≥n de la cita');
            }
            return;
        }

        const datos = recopilarDatosTratamiento('INMEDIATO');
        console.log('Datos del tratamiento:', datos); // Debug

        // Activar loading usando el sistema global
        const $btn = $(this);
        setButtonLoading($btn, true);

        $.ajax({
            url: '/tratamientos/realizar-inmediato',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(datos),
            success: function(response) {
                console.log('Respuesta del servidor:', response); // Debug
                setButtonLoading($btn, false);
                if (typeof Swal !== 'undefined') {
                    Swal.fire('√âxito', response.mensaje || 'Tratamiento registrado correctamente', 'success');
                } else {
                    alert(response.mensaje || 'Tratamiento registrado correctamente');
                }
                $('#modalRegistrarTratamiento').modal('hide');
                location.reload();
            },
            error: function(xhr) {
                console.error('Error completo:', xhr); // Debug
                console.error('Status:', xhr.status); // Debug
                console.error('Response:', xhr.responseJSON); // Debug
                console.error('Response Text:', xhr.responseText); // Debug
                setButtonLoading($btn, false);

                let mensaje = 'No se pudo registrar el tratamiento';

                // Intentar obtener el mensaje de error del servidor
                if (xhr.responseJSON) {
                    mensaje = xhr.responseJSON.mensaje || xhr.responseJSON.error || mensaje;
                } else if (xhr.responseText) {
                    try {
                        const errorObj = JSON.parse(xhr.responseText);
                        mensaje = errorObj.mensaje || errorObj.error || mensaje;
                    } catch (e) {
                        mensaje = xhr.responseText.substring(0, 200); // Primeros 200 caracteres
                    }
                }

                if (typeof Swal !== 'undefined') {
                    Swal.fire('Error', mensaje, 'error');
                } else {
                    alert('Error: ' + mensaje);
                }
            }
        });
    });

    // Bot√≥n Planificar (abrir modal de planificaci√≥n)
    $(document).off('click', '#btnPlanificarTratamiento').on('click', '#btnPlanificarTratamiento', function() {
        console.log('Bot√≥n Planificar clickeado'); // Debug

        // Validar que se haya seleccionado un procedimiento
        const procedimientoId = $('#tratamientoProcedimientoId').val();
        console.log('Procedimiento ID:', procedimientoId); // Debug

        if (!procedimientoId) {
            if (typeof Swal !== 'undefined') {
                Swal.fire('Advertencia', 'Debe seleccionar un procedimiento antes de planificar el tratamiento', 'warning');
            } else {
                alert('Debe seleccionar un procedimiento antes de planificar el tratamiento');
            }
            return;
        }

        // Recopilar todos los datos del tratamiento
        const datos = recopilarDatosTratamiento('PLANIFICADO');
        console.log('Datos del tratamiento planificado:', datos); // Debug

        // Guardar datos temporalmente para usar en el modal de planificaci√≥n
        window.datosTratamientoPlanificar = datos;

        // Obtener el procedimiento seleccionado
        const procedimientoTexto = $('#tratamientoProcedimientoId option:selected').text();

        // Pre-poblar modal con informaci√≥n de la cita actual
        const citaId = citaDatos.id || '';
        const pacienteId = citaDatos.pacienteId || '';
        const pacienteNombre = citaDatos.pacienteNombre || 'N/A';
        const odontologoNombre = citaDatos.odontologoNombre || 'N/A';
        const odontologoId = citaDatos.odontologoId || '';

        $('#planificarCitaId').val(citaId);
        $('#planificarPacienteId').val(pacienteId);
        $('#planificarProcedimientoId').val(procedimientoId);
        $('#planificarOdontologoId').val(odontologoId);
        $('#planificarPiezasDentales').val(datos.piezasDentales || '');
        $('#planificarDescripcion').val(datos.descripcion || '');
        $('#planificarCamposDinamicos').val(JSON.stringify(datos.camposDinamicos || []));
        $('#planificarInsumosAdicionales').val(JSON.stringify(datos.insumosAdicionales || []));

        $('#planificarPacienteNombre').text(pacienteNombre);
        $('#planificarProcedimientoNombre').text(procedimientoTexto);

        // Cerrar modal de tratamiento y abrir modal de planificaci√≥n
        $('#modalRegistrarTratamiento').modal('hide');
        setTimeout(function() {
            $('#modalPlanificarTratamiento').modal('show');
        }, 300);
    });

    function recopilarDatosTratamiento(tipo) {
        // Recopilar TODOS los insumos (predeterminados + adicionales) con cantidades modificadas
        const insumosTotales = [];

        // 1. Recopilar insumos predeterminados de la tabla (capturando cantidades de inputs)
        $('#tablaInsumosDefault tr').not('.insumo-adicional').each(function() {
            const $row = $(this);
            const $cantidadInput = $row.find('input[type="number"]');

            // Solo procesar filas que tienen input de cantidad (no la fila de "Seleccione procedimiento")
            if ($cantidadInput.length > 0) {
                const insumoId = $cantidadInput.data('insumo-id');
                const cantidad = $cantidadInput.val();

                if (insumoId && cantidad && parseFloat(cantidad) > 0) {
                    insumosTotales.push({
                        insumoId: insumoId,
                        cantidad: cantidad
                    });
                }
            }
        });

        // 2. Recopilar insumos adicionales agregados manualmente
        $('.insumo-adicional').each(function() {
            const insumoId = $(this).find('.select-insumo-adicional').val();
            const cantidad = $(this).find('.insumo-cantidad').val();

            if (insumoId && cantidad && parseFloat(cantidad) > 0) {
                insumosTotales.push({
                    insumoId: insumoId,
                    cantidad: cantidad
                });
            }
        });

        console.log('üì¶ Insumos totales a enviar:', insumosTotales);

        return {
            citaId: $('#tratamientoCitaId').val(),
            procedimientoId: $('#tratamientoProcedimientoId').val(),
            piezasDentales: $('#tratamientoPiezasDentales').val(),
            descripcion: $('#tratamientoDescripcion').val(),
            tipo: tipo,
            camposDinamicos: $('#camposDinamicos').find('input, select, textarea').serializeArray(),
            insumosTotales: insumosTotales, // ‚Üê Lista unificada
            tratamientoPlanificadoId: $('#tratamientoPlanificadoId').val() || null // ‚Üê ID expl√≠cito para flujo planificado->realizado
        };
    }
}); // Fin de $(document).ready
/*]]>*/
</script>
</th:block>
