<!-- Modal Registrar Tratamiento AVANZADO -->
<div th:fragment="modalRegistrarTratamiento" class="modal fade" id="modalRegistrarTratamiento" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-tooth mr-2"></i>Registrar Tratamiento Dental
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <input type="hidden" id="tratamientoCitaId" name="citaId">

                <!-- Información Precargada de la Cita -->
                <div class="alert alert-info mb-3 py-2">
                    <small>
                        <strong><i class="fas fa-info-circle mr-1"></i></strong>
                        <span id="infoCitaPaciente"></span> | <span id="infoCitaOdontologo"></span> | <span id="infoCitaFecha"></span>
                    </small>
                </div>

                <!-- Procedimiento Selection -->
                <div class="form-group">
                    <label for="tratamientoProcedimientoId" class="font-weight-bold">Procedimiento <span class="text-danger">*</span></label>
                    <select class="form-control form-control-sm" id="tratamientoProcedimientoId" required>
                        <option value="">Seleccione un procedimiento...</option>
                        <option th:each="proc : ${listaProcedimientos}"
                                th:value="${proc.id}"
                                th:data-codigo="${proc.codigo}"
                                th:text="${proc.codigo + ' - ' + proc.nombre + ' (' + proc.duracionBaseMinutos + ' min)'}"></option>
                    </select>
                </div>

                <!-- Selector Visual de Dientes (FDI) - Compacto -->
                <div class="card card-outline card-primary mb-2" id="selectorDientes" style="display:none;">
                    <div class="card-header py-1">
                        <h6 class="mb-0" style="font-size: 0.9rem;"><i class="fas fa-teeth mr-1"></i>Pieza(s) Dental(es)</h6>
                    </div>
                    <div class="card-body text-center py-2">
                        <small class="text-muted d-block mb-1" style="font-size: 0.7rem;">MAXILAR SUPERIOR</small>
                        <div class="mb-1">
                            <div class="btn-group mr-1 btn-group-sm" id="cuadrante-1"></div>
                            <span class="mx-1">|</span>
                            <div class="btn-group btn-group-sm" id="cuadrante-2"></div>
                        </div>
                        <hr class="my-1">
                        <small class="text-muted d-block mb-1" style="font-size: 0.7rem;">MAXILAR INFERIOR</small>
                        <div>
                            <div class="btn-group mr-1 btn-group-sm" id="cuadrante-4"></div>
                            <span class="mx-1">|</span>
                            <div class="btn-group btn-group-sm" id="cuadrante-3"></div>
                        </div>
                        <input type="hidden" id="tratamientoPiezasDentales" name="piezasDentales">
                        <small class="form-text text-muted mt-1" style="font-size: 0.75rem;">
                            <strong>Seleccionados:</strong> <span id="dientesSeleccionados">Ninguno</span>
                        </small>
                    </div>
                </div>

                <!-- Campos Dinámicos por Procedimiento -->
                <div id="camposDinamicos"></div>

                <!-- Insumos Incluidos en el Procedimiento - Compacto -->
                <div class="card card-outline card-secondary mb-2" id="seccionInsumos" style="display:none;">
                    <div class="card-header py-1">
                        <h6 class="mb-0" style="font-size: 0.9rem;"><i class="fas fa-box mr-1"></i>Insumos</h6>
                    </div>
                    <div class="card-body py-2">
                        <div class="table-responsive" style="max-height: 150px; overflow-y: auto;">
                            <table class="table table-sm table-bordered mb-0" style="font-size: 0.85rem;">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Insumo</th>
                                        <th width="60">Cant.</th>
                                        <th width="60">Unidad</th>
                                        <th width="80">Tipo</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaInsumosDefault">
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">
                                            Seleccione un procedimiento
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="btnAgregarInsumoAdicional">
                            <i class="fas fa-plus mr-1"></i>Agregar Insumo
                        </button>
                    </div>
                </div>

                <!-- Descripción General -->
                <div class="form-group mb-2">
                    <label for="tratamientoDescripcion" class="font-weight-bold">Observaciones</label>
                    <textarea class="form-control form-control-sm" id="tratamientoDescripcion" rows="2"
                              placeholder="Observaciones adicionales"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-info" id="btnPlanificarTratamiento" data-loading-text="Planificando tratamiento...">
                    <i class="fas fa-calendar-plus mr-1"></i>Planificar para Después
                </button>
                <button type="button" class="btn btn-success" id="btnRealizarInmediato" data-loading-text="Registrando tratamiento...">
                    <i class="fas fa-check-circle mr-1"></i>Tratamiento Realizado Ahora
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Script del modal de tratamiento (debe incluirse donde se usa el modal) -->
<th:block th:fragment="scriptModalTratamiento">
<script th:inline="javascript">
/*<![CDATA[*/
// Verificar que jQuery esté cargado antes de ejecutar
if (typeof jQuery === 'undefined') {
    console.error('ERROR: jQuery no está cargado. El modal de tratamiento no funcionará correctamente.');
    console.error('Por favor, asegúrese de incluir jQuery antes de este script.');
} else {
    console.log('jQuery detectado correctamente, inicializando modal de tratamiento...');
}

// Usar función auto-ejecutable que espera a que jQuery y DOM estén listos
(function() {
    // Si jQuery no está disponible, intentar esperar un momento
    if (typeof jQuery === 'undefined') {
        setTimeout(function() {
            if (typeof jQuery !== 'undefined') {
                initModalTratamiento();
            } else {
                console.error('jQuery no se cargó a tiempo');
            }
        }, 1000);
        return;
    }

    // Si ya está listo, inicializar inmediatamente
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        initModalTratamiento();
    } else {
        $(document).ready(function() {
            initModalTratamiento();
        });
    }
})();

function initModalTratamiento() {
    console.log('Inicializando modal de tratamiento...'); // Debug
    // Configurar token CSRF para todas las peticiones AJAX
    var token = $("meta[name='_csrf']").attr("content");
    var header = $("meta[name='_csrf_header']").attr("content");
    $.ajaxSetup({
        beforeSend: function(xhr) {
            xhr.setRequestHeader(header, token);
        }
    });

    let citaDatos = {};
    let dientesSeleccionadosArray = [];

    // FDI Tooth Structure
    const cuadrantes = {
        1: [18, 17, 16, 15, 14, 13, 12, 11],
        2: [21, 22, 23, 24, 25, 26, 27, 28],
        3: [31, 32, 33, 34, 35, 36, 37, 38],
        4: [48, 47, 46, 45, 44, 43, 42, 41]
    };

    // Procedimientos que requieren selector de dientes
    // Todos excepto blanqueamiento (EST-001) y controles generales
    const procedimientosConDientes = ['END-001', 'END-002', 'IMP-001', 'IMP-002',
                                       'EST-002', 'CIR-001', 'CIR-002'];

    // Generar selector de dientes
    function generarSelectorDientes() {
        Object.keys(cuadrantes).forEach(function(cuad) {
            let html = '';
            cuadrantes[cuad].forEach(function(num) {
                html += `<button type="button" class="btn btn-outline-secondary btn-sm btn-diente"
                                data-diente="${num}">${num}</button>`;
            });
            $(`#cuadrante-${cuad}`).html(html);
        });
    }

    // Click en diente
    $(document).on('click', '.btn-diente', function() {
        const diente = $(this).data('diente');
        if ($(this).hasClass('active')) {
            $(this).removeClass('active');
            dientesSeleccionadosArray = dientesSeleccionadosArray.filter(d => d != diente);
        } else {
            $(this).addClass('active');
            dientesSeleccionadosArray.push(diente);
        }
        $('#dientesSeleccionados').text(dientesSeleccionadosArray.length > 0 ?
            dientesSeleccionadosArray.join(', ') : 'Ninguno');
        $('#tratamientoPiezasDentales').val(dientesSeleccionadosArray.join(','));
    });

    // Al abrir modal (desde detalle de cita)
    $('#modalRegistrarTratamiento').on('show.bs.modal', function() {
        // Intentar cargar datos de la cita si están disponibles
        const citaId = $('#detalleCitaId').val();

        if (citaId) {
            // **VERIFICAR SI YA EXISTE TRATAMIENTO EN ESTA CITA**
            $.get('/tratamientos/verificar-cita/' + citaId, function(response) {
                if (response.tieneTratamiento) {
                    // Cerrar el modal inmediatamente
                    $('#modalRegistrarTratamiento').modal('hide');

                    // Mostrar mensaje de advertencia bonito
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'info',
                            title: '<i class="fas fa-info-circle text-info"></i> Tratamiento Ya Registrado',
                            html: `
                                <div class="text-left">
                                    <p class="mb-3">Esta cita ya tiene un tratamiento registrado:</p>
                                    <div class="card bg-light">
                                        <div class="card-body py-2">
                                            <p class="mb-1"><i class="fas fa-procedures text-primary mr-2"></i><strong>Procedimiento:</strong></p>
                                            <p class="mb-2 ml-4">${response.procedimiento}</p>
                                            <p class="mb-0"><i class="fas fa-calendar text-success mr-2"></i><strong>Fecha:</strong> ${response.fecha}</p>
                                        </div>
                                    </div>
                                    <div class="alert alert-warning mt-3 mb-0" role="alert">
                                        <i class="fas fa-exclamation-triangle mr-2"></i>
                                        <small><strong>Nota:</strong> Solo se permite un tratamiento por cita.</small>
                                    </div>
                                </div>
                            `,
                            confirmButtonText: '<i class="fas fa-check mr-1"></i> Entendido',
                            confirmButtonColor: '#3085d6',
                            customClass: {
                                popup: 'swal2-lg'
                            }
                        });
                    } else {
                        alert('Esta cita ya tiene un tratamiento registrado: ' + response.procedimiento);
                    }
                    return;
                }

                // Si no hay tratamiento, continuar con la carga normal
                continuarCargaModal(citaId);
            }).fail(function() {
                console.error('Error verificando tratamiento de la cita');
                continuarCargaModal(citaId);
            });
        } else {
            continuarCargaModal(null);
        }
    });

    // Función auxiliar para cargar el modal
    function continuarCargaModal(citaId) {
        // Limpiar form
        $('#tratamientoProcedimientoId').val('');
        $('#tratamientoDescripcion').val('');
        $('#camposDinamicos').html('');
        $('#selectorDientes').hide();
        $('#seccionInsumos').hide();
        dientesSeleccionadosArray = [];
        $('.btn-diente').removeClass('active');
        $('#dientesSeleccionados').text('Ninguno');
        $('#tratamientoPiezasDentales').val('');

        // Limpiar insumos adicionales
        $('.insumo-adicional').remove();
        contadorInsumosAdicionales = 0;

        if (citaId) {
            $('#tratamientoCitaId').val(citaId);

            // Cargar información de la cita
            const paciente = $('#detallePaciente').text();
            const odontologo = $('#detalleOdontologo').text();
            const fecha = $('#detalleFecha').val();
            const hora = $('#detalleHora').val();
            const procedimientoId = $('#detalleProcedimientoId').val();

            $('#infoCitaPaciente').text(paciente);
            $('#infoCitaOdontologo').text(odontologo);
            $('#infoCitaFecha').text(fecha + ' ' + hora);

            // Si hay procedimiento asociado, pre-seleccionarlo
            if (procedimientoId) {
                $('#tratamientoProcedimientoId').val(procedimientoId);
                // Trigger change para cargar campos dinámicos e insumos
                $('#tratamientoProcedimientoId').trigger('change');
            }
        }
    }

    // Cambio de procedimiento
    $('#tratamientoProcedimientoId').on('change', function() {
        const codigo = $(this).find(':selected').data('codigo');
        const procId = $(this).val();

        // Mostrar selector de dientes si aplica
        if (procedimientosConDientes.includes(codigo)) {
            $('#selectorDientes').show();
            generarSelectorDientes();
        } else {
            $('#selectorDientes').hide();
        }

        // Cargar campos dinámicos
        cargarCamposDinamicos(codigo);

        // Cargar insumos del procedimiento
        if (procId) {
            cargarInsumosProcedimiento(procId);
        }
    });

    // Campos dinámicos por procedimiento
    function cargarCamposDinamicos(codigo) {
        let html = '';

        switch(codigo) {
            case 'CON-001': // Consulta General
                html = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Motivo Consulta</label>
                                <input type="text" class="form-control" name="motivo" placeholder="Ej: Dolor molar">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Diagnóstico</label>
                                <input type="text" class="form-control" name="diagnostico">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Observaciones</label>
                        <textarea class="form-control" name="observaciones" rows="2"></textarea>
                    </div>
                `;
                break;

            case 'CON-002': // Consulta Emergencia
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Motivo Emergencia</label>
                                <input type="text" class="form-control" name="motivo" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Nivel Dolor (1-10)</label>
                                <input type="number" class="form-control" name="nivelDolor" min="1" max="10" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Tratamiento Inmediato</label>
                                <input type="text" class="form-control" name="tratamientoInmediato">
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'END-001': // Endodoncia Molar
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Nº Conductos</label>
                                <input type="number" class="form-control" name="numConductos" value="3" min="1" max="5">
                                <small class="text-muted">Molares: 3-4 conductos típicamente</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Técnica</label>
                                <select class="form-control" name="tecnica">
                                    <option>Convencional</option>
                                    <option>Rotatoria</option>
                                    <option>Mixta</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Radiografía</label>
                                <select class="form-control" name="radiografia">
                                    <option value="SI">Sí - Tomada</option>
                                    <option value="NO">No</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'ORT-001': // Instalación Brackets
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Tipo Brackets</label>
                                <select class="form-control" name="tipoBrackets">
                                    <option>Metálicos</option>
                                    <option>Cerámicos</option>
                                    <option>Zafiro</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Arcada</label>
                                <select class="form-control" name="arcada">
                                    <option>Superior</option>
                                    <option>Inferior</option>
                                    <option>Ambas</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Plan Tratamiento</label>
                                <input type="text" class="form-control" name="planTratamiento" placeholder="Ej: 18 meses">
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'END-002': // Endodoncia Unirradicular
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Nº Conductos</label>
                                <input type="number" class="form-control" name="numConductos" value="1" min="1" max="2">
                                <small class="text-muted">Anteriores/Premolares: 1-2 conductos</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Técnica</label>
                                <select class="form-control" name="tecnica">
                                    <option>Convencional</option>
                                    <option>Rotatoria</option>
                                    <option>Mixta</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Obturación</label>
                                <select class="form-control" name="obturacion">
                                    <option>Gutapercha</option>
                                    <option>Resina Termoplástica</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'ORT-002': // Control Ortodoncia
                html = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Actividades Realizadas</label>
                                <select class="form-control" name="actividades" multiple size="3">
                                    <option>Cambio de arco</option>
                                    <option>Ajuste de ligaduras</option>
                                    <option>Colocación de elásticos</option>
                                    <option>Revisión general</option>
                                </select>
                                <small class="text-muted">Mantenga Ctrl para seleccionar varios</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Avance del Tratamiento</label>
                                <input type="number" class="form-control" name="avancePorcentaje" min="0" max="100" placeholder="%">
                                <small class="text-muted">Porcentaje completado</small>
                            </div>
                            <div class="form-group mt-2">
                                <label>Próximo Control</label>
                                <input type="date" class="form-control" name="proximoControl">
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'PER-001': // Limpieza Dental Básica
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Técnica Utilizada</label>
                                <select class="form-control" name="tecnica">
                                    <option>Ultrasonido</option>
                                    <option>Manual</option>
                                    <option>Combinada</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Nivel de Placa</label>
                                <select class="form-control" name="nivelPlaca">
                                    <option>Bajo</option>
                                    <option>Moderado</option>
                                    <option>Alto</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Aplicación de Flúor</label>
                                <select class="form-control" name="fluor">
                                    <option value="SI">Sí</option>
                                    <option value="NO">No</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'PER-002': // Limpieza Profunda (Curetaje)
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Cuadrantes Tratados</label>
                                <select class="form-control" name="cuadrantes" multiple size="4">
                                    <option value="1">Cuadrante 1 (Superior Derecho)</option>
                                    <option value="2">Cuadrante 2 (Superior Izquierdo)</option>
                                    <option value="3">Cuadrante 3 (Inferior Izquierdo)</option>
                                    <option value="4">Cuadrante 4 (Inferior Derecho)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Anestesia</label>
                                <select class="form-control" name="anestesia">
                                    <option>Local infiltrativa</option>
                                    <option>Troncular</option>
                                    <option>No se requirió</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Profundidad Bolsas (mm)</label>
                                <input type="number" class="form-control" name="profundidadBolsas" min="1" max="15" placeholder="Ej: 5">
                                <small class="text-muted">Promedio de profundidad</small>
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'IMP-001': // Instalación de Implante
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Marca del Implante</label>
                                <select class="form-control" name="marca">
                                    <option>Straumann</option>
                                    <option>Nobel Biocare</option>
                                    <option>Zimmer</option>
                                    <option>Otra</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Diámetro (mm)</label>
                                <input type="number" class="form-control" name="diametro" step="0.1" placeholder="Ej: 4.0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Longitud (mm)</label>
                                <input type="number" class="form-control" name="longitud" step="0.5" placeholder="Ej: 10.0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Injerto Óseo</label>
                                <select class="form-control" name="injertoOseo">
                                    <option value="NO">No requerido</option>
                                    <option value="SI">Sí - Realizado</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Torque de Inserción (Ncm)</label>
                                <input type="number" class="form-control" name="torque" placeholder="Ej: 35">
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'IMP-002': // Corona sobre Implante
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Tipo de Corona</label>
                                <select class="form-control" name="tipoCorona">
                                    <option>Porcelana</option>
                                    <option>Zirconio</option>
                                    <option>Metal-Porcelana</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Color</label>
                                <input type="text" class="form-control" name="color" placeholder="Ej: A2">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Tipo de Fijación</label>
                                <select class="form-control" name="fijacion">
                                    <option>Atornillada</option>
                                    <option>Cementada</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'EST-001': // Blanqueamiento Dental
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Tipo de Blanqueamiento</label>
                                <select class="form-control" name="tipoBlanqueamiento">
                                    <option>LED (consultorio)</option>
                                    <option>Láser (consultorio)</option>
                                    <option>Ambulatorio (férulas)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Concentración Gel</label>
                                <select class="form-control" name="concentracion">
                                    <option>10% Peróxido Carbamida</option>
                                    <option>16% Peróxido Carbamida</option>
                                    <option>35% Peróxido Hidrógeno</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Sesiones Programadas</label>
                                <input type="number" class="form-control" name="sesiones" min="1" max="6" value="3">
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'EST-002': // Carillas de Resina
                html = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Material Utilizado</label>
                                <select class="form-control" name="material">
                                    <option>Resina Nanoparticulada</option>
                                    <option>Resina Microhíbrida</option>
                                    <option>Resina Nanocerámica</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Color/Tono</label>
                                <input type="text" class="form-control" name="color" placeholder="Ej: A2, B1">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Técnica de Adhesión</label>
                        <input type="text" class="form-control" name="tecnicaAdhesion" placeholder="Ej: Grabado ácido + adhesivo universal">
                    </div>
                `;
                break;

            case 'CIR-001': // Extracción Simple
                html = `
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Motivo Extracción</label>
                                <select class="form-control" name="motivo">
                                    <option>Caries avanzada</option>
                                    <option>Fractura</option>
                                    <option>Movilidad</option>
                                    <option>Periodontal</option>
                                    <option>Ortodóntico</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Tipo Anestesia</label>
                                <select class="form-control" name="anestesia">
                                    <option>Local infiltrativa</option>
                                    <option>Troncular</option>
                                    <option>Ambas</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Sutura</label>
                                <select class="form-control" name="sutura">
                                    <option value="NO">No requerida</option>
                                    <option value="SI">Sí - Realizada</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;
                break;

            case 'CIR-002': // Extracción Quirúrgica
                html = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Tipo de Extracción</label>
                                <select class="form-control" name="tipoExtraccion">
                                    <option>Cordal incluido</option>
                                    <option>Cordal semi-incluido</option>
                                    <option>Quiste dentígero</option>
                                    <option>Resto radicular</option>
                                    <option>Otra cirugía compleja</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Incisión Realizada</label>
                                <select class="form-control" name="incision">
                                    <option>Colgajo triangular</option>
                                    <option>Colgajo trapezoidal</option>
                                    <option>Colgajo rectangular</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Osteotomía</label>
                                <select class="form-control" name="osteotomia">
                                    <option value="NO">No</option>
                                    <option value="SI">Sí</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Odontosección</label>
                                <select class="form-control" name="odontoseccion">
                                    <option value="NO">No</option>
                                    <option value="SI">Sí</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>Puntos de Sutura</label>
                                <input type="number" class="form-control" name="puntosSutura" min="0" placeholder="Ej: 3">
                            </div>
                        </div>
                    </div>
                `;
                break;
        }

        $('#camposDinamicos').html(html);
    }

    // Cargar insumos del procedimiento
    function cargarInsumosProcedimiento(procId) {
        $.get(`/procedimientos/${procId}/insumos`, function(insumos) {
            if (insumos && insumos.length > 0) {
                let html = '';
                insumos.forEach(function(ins) {
                    const tipoBadge = ins.esObligatorio ? 'danger' : 'secondary';
                    const tipoTexto = ins.esObligatorio ? 'Oblig.' : 'Opc.';
                    html += `
                        <tr>
                            <td>${ins.insumoNombre}</td>
                            <td><input type="number" class="form-control form-control-sm" value="${ins.cantidadDefecto}" min="0" style="width:50px;"></td>
                            <td>${ins.unidad}</td>
                            <td><span class="badge badge-${tipoBadge}" style="font-size:0.7rem;">${tipoTexto}</span></td>
                        </tr>
                    `;
                });
                $('#tablaInsumosDefault').html(html);
                $('#seccionInsumos').show();
            } else {
                $('#seccionInsumos').hide();
            }
        }).fail(function() {
            $('#seccionInsumos').hide();
        });
    }

    // Contador para insumos adicionales
    let contadorInsumosAdicionales = 0;
    let insumosDisponibles = [];

    // Cargar lista de insumos al inicio
    function cargarInsumosDisponibles() {
        $.get('/tratamientos/insumos', function(insumos) {
            insumosDisponibles = insumos;
            console.log('Insumos cargados:', insumosDisponibles.length);
        }).fail(function() {
            console.error('Error cargando lista de insumos');
        });
    }

    // Cargar insumos al inicializar
    cargarInsumosDisponibles();

    // Agregar insumo adicional
    $(document).on('click', '#btnAgregarInsumoAdicional', function() {
        console.log('Agregando insumo adicional...');

        if (insumosDisponibles.length === 0) {
            if (typeof Swal !== 'undefined') {
                Swal.fire('Advertencia', 'No hay insumos disponibles en el sistema', 'warning');
            } else {
                alert('No hay insumos disponibles en el sistema');
            }
            return;
        }

        contadorInsumosAdicionales++;

        // Construir options del select
        let optionsHtml = '<option value="">Seleccione insumo...</option>';
        insumosDisponibles.forEach(function(insumo) {
            const stockInfo = insumo.stockActual > 0 ? `(Stock: ${insumo.stockActual})` : '(Sin stock)';
            optionsHtml += `<option value="${insumo.id}" data-unidad="${insumo.unidad}" data-precio="${insumo.precioUnitario || 0}">
                ${insumo.codigo} - ${insumo.nombre} ${stockInfo}
            </option>`;
        });

        const nuevaFila = `
            <tr class="insumo-adicional" data-id="${contadorInsumosAdicionales}">
                <td>
                    <select class="form-control form-control-sm select-insumo-adicional" required>
                        ${optionsHtml}
                    </select>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm insumo-cantidad" value="1" min="0.1" step="0.1" style="width:50px;">
                </td>
                <td class="insumo-unidad-display">-</td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger btn-eliminar-insumo" style="padding:0.1rem 0.3rem; font-size:0.7rem;">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            </tr>
        `;

        $('#tablaInsumosDefault').append(nuevaFila);

        if (typeof Swal !== 'undefined') {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Insumo agregado',
                showConfirmButton: false,
                timer: 1500
            });
        }
    });

    // Cuando se selecciona un insumo, actualizar la unidad
    $(document).on('change', '.select-insumo-adicional', function() {
        const unidad = $(this).find(':selected').data('unidad');
        $(this).closest('tr').find('.insumo-unidad-display').text(unidad || '-');
    });

    // Eliminar insumo adicional
    $(document).on('click', '.btn-eliminar-insumo', function() {
        $(this).closest('tr').remove();
    });

    // Botón Tratamiento Inmediato (usar delegación de eventos)
    $(document).off('click', '#btnRealizarInmediato').on('click', '#btnRealizarInmediato', function() {
        console.log('Botón Realizar Inmediato clickeado'); // Debug

        // Validar que se haya seleccionado un procedimiento
        const procedimientoId = $('#tratamientoProcedimientoId').val();
        console.log('Procedimiento ID:', procedimientoId); // Debug

        if (!procedimientoId) {
            if (typeof Swal !== 'undefined') {
                Swal.fire('Advertencia', 'Debe seleccionar un procedimiento antes de registrar el tratamiento', 'warning');
            } else {
                alert('Debe seleccionar un procedimiento antes de registrar el tratamiento');
            }
            return;
        }

        // Validar que haya una cita asociada
        const citaId = $('#tratamientoCitaId').val();
        console.log('Cita ID:', citaId); // Debug

        if (!citaId) {
            if (typeof Swal !== 'undefined') {
                Swal.fire('Error', 'No se encontró la información de la cita', 'error');
            } else {
                alert('No se encontró la información de la cita');
            }
            return;
        }

        const datos = recopilarDatosTratamiento('INMEDIATO');
        console.log('Datos del tratamiento:', datos); // Debug

        // Activar loading usando el sistema global
        const $btn = $(this);
        setButtonLoading($btn, true);

        $.ajax({
            url: '/tratamientos/realizar-inmediato',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(datos),
            success: function(response) {
                console.log('Respuesta del servidor:', response); // Debug
                setButtonLoading($btn, false);
                if (typeof Swal !== 'undefined') {
                    Swal.fire('Éxito', response.mensaje || 'Tratamiento registrado correctamente', 'success');
                } else {
                    alert(response.mensaje || 'Tratamiento registrado correctamente');
                }
                $('#modalRegistrarTratamiento').modal('hide');
                location.reload();
            },
            error: function(xhr) {
                console.error('Error en la petición:', xhr); // Debug
                setButtonLoading($btn, false);
                const mensaje = xhr.responseJSON?.mensaje || 'No se pudo registrar el tratamiento';
                if (typeof Swal !== 'undefined') {
                    Swal.fire('Error', mensaje, 'error');
                } else {
                    alert('Error: ' + mensaje);
                }
            }
        });
    });

    // Botón Planificar (usar delegación de eventos)
    $(document).off('click', '#btnPlanificarTratamiento').on('click', '#btnPlanificarTratamiento', function() {
        console.log('Botón Planificar clickeado'); // Debug

        // Validar que se haya seleccionado un procedimiento
        const procedimientoId = $('#tratamientoProcedimientoId').val();
        console.log('Procedimiento ID:', procedimientoId); // Debug

        if (!procedimientoId) {
            if (typeof Swal !== 'undefined') {
                Swal.fire('Advertencia', 'Debe seleccionar un procedimiento antes de planificar el tratamiento', 'warning');
            } else {
                alert('Debe seleccionar un procedimiento antes de planificar el tratamiento');
            }
            return;
        }

        // Validar que haya una cita asociada
        const citaId = $('#tratamientoCitaId').val();
        console.log('Cita ID:', citaId); // Debug

        if (!citaId) {
            if (typeof Swal !== 'undefined') {
                Swal.fire('Error', 'No se encontró la información de la cita', 'error');
            } else {
                alert('No se encontró la información de la cita');
            }
            return;
        }

        const datos = recopilarDatosTratamiento('PLANIFICADO');
        console.log('Datos del tratamiento planificado:', datos); // Debug

        // Activar loading usando el sistema global
        const $btn = $(this);
        setButtonLoading($btn, true);

        $.ajax({
            url: '/tratamientos/planificar',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(datos),
            success: function(response) {
                console.log('Respuesta del servidor:', response); // Debug
                setButtonLoading($btn, false);
                if (typeof Swal !== 'undefined') {
                    Swal.fire('Éxito', response.mensaje || 'Tratamiento planificado correctamente', 'success');
                } else {
                    alert(response.mensaje || 'Tratamiento planificado correctamente');
                }
                $('#modalRegistrarTratamiento').modal('hide');
                location.reload();
            },
            error: function(xhr) {
                console.error('Error en la petición:', xhr); // Debug
                setButtonLoading($btn, false);
                const mensaje = xhr.responseJSON?.mensaje || 'No se pudo planificar el tratamiento';
                if (typeof Swal !== 'undefined') {
                    Swal.fire('Error', mensaje, 'error');
                } else {
                    alert('Error: ' + mensaje);
                }
            }
        });
    });

    function recopilarDatosTratamiento(tipo) {
        // Recopilar insumos adicionales
        const insumosAdicionales = [];
        $('.insumo-adicional').each(function() {
            const insumoId = $(this).find('.select-insumo-adicional').val();
            const cantidad = $(this).find('.insumo-cantidad').val();

            if (insumoId && cantidad) {
                insumosAdicionales.push({
                    insumoId: insumoId,
                    cantidad: cantidad
                });
            }
        });

        return {
            citaId: $('#tratamientoCitaId').val(),
            procedimientoId: $('#tratamientoProcedimientoId').val(),
            piezasDentales: $('#tratamientoPiezasDentales').val(),
            descripcion: $('#tratamientoDescripcion').val(),
            tipo: tipo,
            camposDinamicos: $('#camposDinamicos').find('input, select, textarea').serializeArray(),
            insumosAdicionales: insumosAdicionales
        };
    }
} // Fin de initModalTratamiento
/*]]>*/
</script>
</th:block>
