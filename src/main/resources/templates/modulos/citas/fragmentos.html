<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<body>

<!-- ========================================== -->
<!-- MODAL: Agendar Nueva Cita -->
<!-- ========================================== -->
<div th:fragment="modalAgendarCita" class="modal fade" id="modalAgendarCita" tabindex="-1" role="dialog" aria-labelledby="modalAgendarCitaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form th:action="@{/citas/agendar}" method="post" data-auto-loading="true">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalAgendarCitaLabel">
                        <i class="fas fa-calendar-plus mr-2"></i>Agendar Nueva Cita
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <!-- Indicadores de progreso del wizard -->
                <div class="modal-body pb-2">
                    <div class="wizard-steps d-flex justify-content-between mb-4">
                        <div class="wizard-step active" data-step="1">
                            <div class="step-circle">
                                <span class="step-number">1</span>
                                <i class="fas fa-check step-check" style="display: none;"></i>
                            </div>
                            <div class="step-label">Información Básica</div>
                        </div>
                        <div class="wizard-line"></div>
                        <div class="wizard-step" data-step="2">
                            <div class="step-circle">
                                <span class="step-number">2</span>
                                <i class="fas fa-check step-check" style="display: none;"></i>
                            </div>
                            <div class="step-label">Horario</div>
                        </div>
                        <div class="wizard-line"></div>
                        <div class="wizard-step" data-step="3">
                            <div class="step-circle">
                                <span class="step-number">3</span>
                                <i class="fas fa-check step-check" style="display: none;"></i>
                            </div>
                            <div class="step-label">Detalles</div>
                        </div>
                    </div>

                    <style>
                        .wizard-steps {
                            position: relative;
                            padding: 0 20px;
                        }
                        .wizard-step {
                            text-align: center;
                            flex: 1;
                            position: relative;
                            z-index: 2;
                        }
                        .step-circle {
                            width: 45px;
                            height: 45px;
                            border-radius: 50%;
                            background: #e9ecef;
                            color: #6c757d;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 0 auto 8px;
                            font-weight: bold;
                            border: 3px solid #e9ecef;
                            transition: all 0.3s;
                        }
                        .wizard-step.active .step-circle {
                            background: #007bff;
                            color: white;
                            border-color: #007bff;
                            transform: scale(1.1);
                        }
                        .wizard-step.completed .step-circle {
                            background: #28a745;
                            color: white;
                            border-color: #28a745;
                        }
                        .wizard-step.completed .step-number {
                            display: none;
                        }
                        .wizard-step.completed .step-check {
                            display: block !important;
                        }
                        .step-label {
                            font-size: 12px;
                            color: #6c757d;
                            font-weight: 500;
                        }
                        .wizard-step.active .step-label {
                            color: #007bff;
                            font-weight: 600;
                        }
                        .wizard-step.completed .step-label {
                            color: #28a745;
                        }
                        .wizard-line {
                            flex: 1;
                            height: 3px;
                            background: #e9ecef;
                            margin: 22px 10px 0;
                            position: relative;
                        }
                        .wizard-content-step {
                            display: none;
                        }
                        .wizard-content-step.active {
                            display: block;
                        }
                    </style>
                </div>

                <div class="modal-body pt-0">
                    <!-- Alerta de validación -->
                    <div id="alertaValidacionCita" class="alert alert-danger d-none" role="alert">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span id="mensajeValidacionCita"></span>
                    </div>

                    <!-- Campo hidden para enviar la fecha/hora seleccionada -->
                    <input type="hidden" id="fechaHoraInicioAgendar" name="fechaHoraInicio" required>

                    <!-- PASO 1: Información Básica -->
                    <div class="wizard-content-step active" id="wizard-step-1">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="pacienteIdAgendar">Paciente <span class="text-danger">*</span></label>
                                <select class="form-control" id="pacienteIdAgendar" name="pacienteUsuarioId" required>
                                    <option value="">Seleccione un paciente</option>
                                    <option th:each="paciente : ${listaPacientes}"
                                            th:value="${paciente.usuario != null ? paciente.usuario.id : ''}"
                                            th:text="${paciente.nombreCompleto}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="odontologoIdAgendar">Odontólogo <span class="text-danger">*</span></label>
                                <select class="form-control" id="odontologoIdAgendar" name="odontologoUsuarioId" required>
                                    <option value="">Seleccione un odontólogo</option>
                                    <option th:each="odontologo : ${listaOdontologos}"
                                            th:value="${odontologo.id}"
                                            th:text="${odontologo.nombreCompleto}"></option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="procedimientoIdAgendar">Procedimiento <small class="text-muted">(Opcional)</small></label>
                                <select class="form-control" id="procedimientoIdAgendar" name="procedimientoId">
                                    <option value="">Seleccione un procedimiento</option>
                                    <option th:each="procedimiento : ${listaProcedimientos}"
                                            th:value="${procedimiento.id}"
                                            th:text="${procedimiento.nombre} + ' (' + ${procedimiento.duracionBaseMinutos} + ' min)'"
                                            th:attr="data-duracion=${procedimiento.duracionBaseMinutos}"></option>
                                </select>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i> Influye en la duración de la cita
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="fechaCitaAgendar">Fecha de la Cita <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="fechaCitaAgendar" required>
                                <small class="form-text text-muted">
                                    <i class="fas fa-calendar-alt"></i> Seleccione la fecha para ver horarios
                                </small>
                            </div>
                        </div>
                    </div>
                    </div>
                    <!-- FIN PASO 1 -->

                    <!-- PASO 2: Seleccionar Horario -->
                    <div class="wizard-content-step" id="wizard-step-2">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="text-primary mb-0">
                            <i class="fas fa-clock mr-2"></i>Seleccionar Horario Disponible
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="btnRefrescarHorarios" title="Refrescar horarios disponibles">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>

                    <!-- Indicador de horario seleccionado -->
                    <div class="alert alert-info" id="horario-seleccionado-info" style="display: none;">
                        <i class="fas fa-check-circle mr-2"></i>
                        <strong>Horario seleccionado:</strong> <span id="horario-seleccionado-texto">Ninguno</span>
                    </div>

                    <!-- Grilla de horarios disponibles -->
                    <div id="grilla-horarios-disponibles" class="mb-3">
                        <div class="alert alert-secondary text-center">
                            <i class="fas fa-info-circle mr-2"></i>
                            Seleccione un odontólogo y fecha para ver los horarios disponibles
                        </div>
                    </div>
                    </div>
                    <!-- FIN PASO 2 -->

                    <!-- PASO 3: Información Adicional -->
                    <div class="wizard-content-step" id="wizard-step-3">
                    <h6 class="text-primary mb-3">
                        <i class="fas fa-notes-medical mr-2"></i>Información Adicional <small class="text-muted">(Opcional)</small>
                    </h6>

                    <div class="form-group">
                        <label for="motivoConsultaAgendar">Motivo de Consulta</label>
                        <textarea class="form-control" id="motivoConsultaAgendar" name="motivoConsulta" rows="2" placeholder="Describa el motivo de la consulta"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="notasInternasAgendar">Notas Internas</label>
                        <textarea class="form-control" id="notasInternasAgendar" name="notasInternas" rows="2" placeholder="Notas visibles solo para el personal"></textarea>
                    </div>
                    </div>
                    <!-- FIN PASO 3 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>Cancelar
                    </button>
                    <div class="ml-auto">
                        <button type="button" class="btn btn-outline-secondary" id="btnWizardAnterior" style="display: none;">
                            <i class="fas fa-arrow-left mr-1"></i>Anterior
                        </button>
                        <button type="button" class="btn btn-primary" id="btnWizardSiguiente">
                            Siguiente<i class="fas fa-arrow-right ml-1"></i>
                        </button>
                        <button type="submit" class="btn btn-success" id="btnWizardFinalizar" style="display: none;" data-loading-text="Agendando cita...">
                            <i class="fas fa-check mr-1"></i>Agendar Cita
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- MODAL: Detalle de Cita -->
<!-- ========================================== -->
<div th:fragment="modalDetalleCita" class="modal fade" id="modalDetalleCita" tabindex="-1" role="dialog" aria-labelledby="modalDetalleCitaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalDetalleCitaLabel">
                    <i class="fas fa-info-circle mr-2"></i>Detalle de Cita
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="detalleCitaId" class="citaIdField">
                <input type="hidden" id="detalleOdontologoId">
                <input type="hidden" id="detalleProcedimientoId">
                <input type="hidden" id="detalleFecha">
                <input type="hidden" id="detalleHora">

                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Paciente:</strong> <span id="detallePaciente"></span></p>
                        <p><strong>Odontólogo:</strong> <span id="detalleOdontologo"></span></p>
                        <p><strong>Procedimiento:</strong> <span id="detalleProcedimiento"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Estado:</strong> <span id="detalleEstado" class="badge"></span></p>
                        <p><strong>Fecha Inicio:</strong> <span id="detalleFechaHoraInicio"></span></p>
                        <p><strong>Fecha Fin:</strong> <span id="detalleFechaHoraFin"></span></p>
                    </div>
                </div>

                <hr>

                <div class="row">
                    <div class="col-12">
                        <p><strong>Motivo de Consulta:</strong></p>
                        <p class="text-muted" id="detalleMotivoConsulta"></p>
                    </div>
                    <div class="col-12">
                        <p><strong>Notas Internas:</strong></p>
                        <p class="text-muted" id="detalleNotasInternas"></p>
                    </div>
                </div>

                <hr>

                <!-- Botones de Acción -->
                <div class="text-center">
                    <!-- Botón Confirmar Cita -->
                    <form th:action="@{/citas/confirmar}" method="post" style="display: inline-block;" id="btnConfirmarCita" data-auto-loading="true">
                        <input type="hidden" name="citaId" class="citaIdField">
                        <button type="submit" class="btn btn-success" data-loading-text="Confirmando cita...">
                            <i class="fas fa-check-circle mr-1"></i>Confirmar Cita
                        </button>
                    </form>

                    <!-- Botones Marcar Asistencia -->
                    <div id="divAsistencia" style="display: none;" sec:authorize="hasAnyAuthority('EDITAR_CITAS', 'ADMIN')">
                        <form th:action="@{/citas/marcar-asistencia}" method="post" style="display: inline-block;" data-auto-loading="true">
                            <input type="hidden" name="citaId" class="citaIdField">
                            <input type="hidden" name="asistio" value="true">
                            <button type="submit" class="btn btn-success" data-loading-text="Registrando asistencia...">
                                <i class="fas fa-user-check mr-1"></i>Asistió
                            </button>
                        </form>
                        <form th:action="@{/citas/marcar-asistencia}" method="post" style="display: inline-block;" data-auto-loading="true">
                            <input type="hidden" name="citaId" class="citaIdField">
                            <input type="hidden" name="asistio" value="false">
                            <button type="submit" class="btn btn-danger" data-loading-text="Registrando inasistencia...">
                                <i class="fas fa-user-times mr-1"></i>No Asistió
                            </button>
                        </form>
                    </div>

                    <!-- Botón Reprogramar -->
                    <button type="button" class="btn btn-warning" id="btnReprogramar" data-dismiss="modal" data-toggle="modal" data-target="#modalReprogramarCita"
                            sec:authorize="hasAnyAuthority('EDITAR_CITAS', 'ADMIN')">
                        <i class="fas fa-calendar-alt mr-1"></i>Reprogramar
                    </button>

                    <!-- Botón Cancelar -->
                    <button type="button" class="btn btn-danger" id="btnCancelar" data-dismiss="modal" data-toggle="modal" data-target="#modalCancelarCita"
                            sec:authorize="hasAnyAuthority('EDITAR_CITAS', 'ELIMINAR_CITAS', 'ADMIN')">
                        <i class="fas fa-ban mr-1"></i>Cancelar
                    </button>

                    <!-- Botón Registrar Tratamiento -->
                    <button type="button" class="btn btn-primary" id="btnRegistrarTratamiento" data-dismiss="modal" data-toggle="modal" data-target="#modalRegistrarTratamiento"
                            sec:authorize="hasAnyAuthority('EDITAR_CITAS', 'ADMIN')">
                        <i class="fas fa-notes-medical mr-1"></i>Registrar Tratamiento
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-1"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- MODAL: Reprogramar Cita -->
<!-- ========================================== -->
<div th:fragment="modalReprogramarCita" class="modal fade" id="modalReprogramarCita" tabindex="-1" role="dialog" aria-labelledby="modalReprogramarCitaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document" style="max-width: 850px;">
        <div class="modal-content">
            <form th:action="@{/citas/reprogramar}" method="post" data-auto-loading="true">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="modalReprogramarCitaLabel">
                        <i class="fas fa-calendar-alt mr-2"></i>Reprogramar Cita
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="reprogramarCitaId" name="citaId">
                    <input type="hidden" id="reprogramarOdontologoId" name="odontologoUsuarioId">
                    <input type="hidden" id="nuevaFechaHoraInicioReprogramar" name="nuevaFechaHoraInicio" required>

                    <!-- Información de la cita actual -->
                    <div class="alert alert-info mb-3">
                        <h6><i class="fas fa-info-circle mr-2"></i>Cita Actual</h6>
                        <p class="mb-1"><strong>Paciente:</strong> <span id="reprogramarPaciente"></span></p>
                        <p class="mb-1"><strong>Odontólogo:</strong> <span id="reprogramarOdontologo"></span></p>
                        <p class="mb-0"><strong>Fecha/Hora:</strong> <span id="reprogramarFechaActual"></span></p>
                    </div>

                    <!-- Layout horizontal: 2 columnas -->
                    <div class="row">
                        <!-- Columna Izquierda: Selección de Fecha y Motivo -->
                        <div class="col-md-5">
                            <!-- Seleccionar Nueva Fecha -->
                            <h6 class="text-primary mb-3 border-bottom pb-2">
                                <i class="fas fa-calendar-alt mr-2"></i>Nueva Fecha
                            </h6>
                            <div class="form-group">
                                <label for="fechaCitaReprogramar">Fecha <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="fechaCitaReprogramar" required>
                                <small class="form-text text-muted">
                                    <i class="fas fa-calendar-alt"></i> Seleccione para ver horarios
                                </small>
                            </div>

                            <!-- Indicador de horario seleccionado -->
                            <div class="alert alert-success" id="horario-seleccionado-info-reprogramar" style="display: none;">
                                <i class="fas fa-check-circle mr-2"></i>
                                <strong>Horario:</strong> <span id="horario-seleccionado-texto-reprogramar">Ninguno</span>
                            </div>

                            <hr class="my-3">

                            <!-- Motivo -->
                            <h6 class="text-primary mb-3 border-bottom pb-2">
                                <i class="fas fa-comment mr-2"></i>Motivo
                            </h6>
                            <div class="form-group">
                                <label for="motivoReprogramacion">Motivo <small class="text-muted">(Opcional)</small></label>
                                <textarea class="form-control" id="motivoReprogramacion" name="motivo" rows="3" placeholder="Indique el motivo"></textarea>
                            </div>
                        </div>

                        <!-- Columna Derecha: Horarios Disponibles -->
                        <div class="col-md-7">
                            <h6 class="text-primary mb-3 border-bottom pb-2">
                                <i class="fas fa-clock mr-2"></i>Horarios Disponibles
                            </h6>
                            <!-- Grilla de horarios disponibles con scroll -->
                            <div id="grilla-horarios-disponibles-reprogramar" class="mb-3" style="max-height: 320px; overflow-y: auto;">
                                <div class="alert alert-secondary text-center">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    Seleccione una fecha para ver los horarios
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-warning" id="btnConfirmarReprogramar" data-loading-text="Reprogramando cita...">
                        <i class="fas fa-check mr-1"></i>Reprogramar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- MODAL: Cancelar Cita -->
<!-- ========================================== -->
<div th:fragment="modalCancelarCita" class="modal fade" id="modalCancelarCita" tabindex="-1" role="dialog" aria-labelledby="modalCancelarCitaLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form th:action="@{/citas/cancelar}" method="post" data-auto-loading="true">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modalCancelarCitaLabel">
                        <i class="fas fa-ban mr-2"></i>Cancelar Cita
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="cancelarCitaId" name="citaId">

                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        ¿Está seguro de que desea cancelar esta cita?
                    </div>

                    <div class="form-group">
                        <label for="motivoCancelacion">Motivo de la Cancelación <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="motivoCancelacion" name="motivo" rows="3" placeholder="Indique el motivo de la cancelación" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>No, volver
                    </button>
                    <button type="submit" class="btn btn-danger" data-loading-text="Cancelando cita...">
                        <i class="fas fa-ban mr-1"></i>Sí, cancelar cita
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- MODAL: Registrar Tratamiento -->
<!-- ========================================== -->
<th:block th:fragment="modalRegistrarTratamiento">
    <div th:replace="~{modulos/citas/modal-tratamiento-avanzado :: modalRegistrarTratamiento}"></div>
    <!-- Incluir el script del modal -->
    <th:block th:replace="~{modulos/citas/modal-tratamiento-avanzado :: scriptModalTratamiento}"></th:block>
</th:block>

<!-- Script de validaciones inline para modal de citas -->
<script th:fragment="scriptValidacionesCita">
$(document).ready(function() {
    // Inicializar Select2 para buscador de pacientes
    $('#pacienteIdAgendar').select2({
        dropdownParent: $('#modalAgendarCita'),
        placeholder: 'Busque y seleccione un paciente',
        allowClear: true,
        width: '100%',
        language: {
            noResults: function() {
                return "No se encontraron pacientes";
            },
            searching: function() {
                return "Buscando...";
            }
        }
    });

    // Referencias a elementos del formulario
    const formAgendar = $('#modalAgendarCita form');
    const fechaInput = $('#fechaHoraInicioAgendar');
    const pacienteSelect = $('#pacienteIdAgendar');
    const odontologoSelect = $('#odontologoIdAgendar');
    const alertaValidacion = $('#alertaValidacionCita');
    const mensajeValidacion = $('#mensajeValidacionCita');

    // Función para validar fecha (no puede ser pasada)
    function validarFecha() {
        const fechaSeleccionada = new Date(fechaInput.val());
        const ahora = new Date();

        if (fechaInput.val() && fechaSeleccionada < ahora) {
            fechaInput.addClass('is-invalid');
            return false;
        } else {
            fechaInput.removeClass('is-invalid');
            return true;
        }
    }

    // Función para validar select
    function validarSelect(selectElement) {
        if (!selectElement.val() || selectElement.val() === '') {
            selectElement.addClass('is-invalid');
            return false;
        } else {
            selectElement.removeClass('is-invalid');
            return true;
        }
    }

    // Validación en tiempo real al cambiar fecha
    fechaInput.on('change', function() {
        validarFecha();
        ocultarAlerta();
    });

    // Validación en tiempo real al cambiar selects
    pacienteSelect.on('change', function() {
        validarSelect($(this));
        ocultarAlerta();
    });

    odontologoSelect.on('change', function() {
        validarSelect($(this));
        ocultarAlerta();
    });

    // Función para mostrar alerta de error
    function mostrarAlerta(mensaje) {
        mensajeValidacion.text(mensaje);
        alertaValidacion.removeClass('d-none');
        alertaValidacion[0].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Función para ocultar alerta
    function ocultarAlerta() {
        alertaValidacion.addClass('d-none');
    }

    // Validación al enviar el formulario
    formAgendar.on('submit', function(e) {
        let esValido = true;
        let mensaje = '';

        // Limpiar validaciones previas
        fechaInput.removeClass('is-invalid');
        pacienteSelect.removeClass('is-invalid');
        odontologoSelect.removeClass('is-invalid');
        ocultarAlerta();

        // Validar fecha
        if (!fechaInput.val()) {
            fechaInput.addClass('is-invalid');
            mensaje = 'Por favor seleccione una fecha y hora de inicio';
            esValido = false;
        } else if (!validarFecha()) {
            mensaje = 'La fecha y hora no puede ser en el pasado';
            esValido = false;
        }

        // Validar paciente
        if (!validarSelect(pacienteSelect)) {
            mensaje = mensaje || 'Por favor seleccione un paciente';
            esValido = false;
        }

        // Validar odontólogo
        if (!validarSelect(odontologoSelect)) {
            mensaje = mensaje || 'Por favor seleccione un odontólogo';
            esValido = false;
        }

        // Si no es válido, prevenir envío y mostrar mensaje
        if (!esValido) {
            e.preventDefault();
            mostrarAlerta(mensaje);
            return false;
        }

        return true;
    });

    // Limpiar validaciones al cerrar el modal
    $('#modalAgendarCita').on('hidden.bs.modal', function() {
        fechaInput.removeClass('is-invalid');
        pacienteSelect.removeClass('is-invalid');
        odontologoSelect.removeClass('is-invalid');
        ocultarAlerta();
        formAgendar[0].reset();
    });

    // ============ SCRIPT PARA MODAL DE TRATAMIENTO ============

    // Autocompletar fecha/hora actual al abrir el modal
    $('#modalRegistrarTratamiento').on('show.bs.modal', function() {
        const ahora = new Date();
        const fechaFormateada = ahora.toISOString().slice(0, 16); // Formato YYYY-MM-DDTHH:mm
        $('#tratamientoFechaRealizacion').val(fechaFormateada);
    });

    // Mapeo de insumos con su stock (se carga desde Thymeleaf)
    const insumosStock = {};

    // Al cambiar el insumo seleccionado, mostrar stock disponible
    $('#tratamientoInsumoId').on('change', function() {
        const insumoId = $(this).val();
        const stockWarning = $('#stockWarning');
        const stockText = $('#stockDisponibleText');

        if (!insumoId) {
            stockWarning.addClass('d-none');
            stockText.text('');
            $('#tratamientoCantidadAjustada').val('').prop('disabled', true);
            return;
        }

        // Habilitar campo de cantidad
        $('#tratamientoCantidadAjustada').prop('disabled', false);

        // Extraer stock del texto del option seleccionado
        const selectedOption = $(this).find('option:selected').text();
        const stockMatch = selectedOption.match(/Stock:\s*([\d.]+)\s*(\w+)/);

        if (stockMatch) {
            const stockDisponible = parseFloat(stockMatch[1]);
            const unidad = stockMatch[2];
            insumosStock[insumoId] = { stock: stockDisponible, unidad: unidad };
            stockText.html(`<i class="fas fa-box mr-1"></i>Stock disponible: <strong>${stockDisponible} ${unidad}</strong>`);

            // Advertencia si stock bajo
            if (stockDisponible < 10) {
                stockWarning.removeClass('d-none');
                $('#stockWarningText').text(`Stock bajo: solo quedan ${stockDisponible} ${unidad}`);
            } else {
                stockWarning.addClass('d-none');
            }
        }
    });

    // Validar cantidad al escribir
    $('#tratamientoCantidadAjustada').on('input', function() {
        const insumoId = $('#tratamientoInsumoId').val();
        const cantidad = parseFloat($(this).val());
        const stockWarning = $('#stockWarning');

        if (insumoId && insumosStock[insumoId] && cantidad) {
            const stockDisponible = insumosStock[insumoId].stock;
            const unidad = insumosStock[insumoId].unidad;

            if (cantidad > stockDisponible) {
                stockWarning.removeClass('d-none').removeClass('alert-warning').addClass('alert-danger');
                $('#stockWarningText').text(`¡CANTIDAD EXCEDE EL STOCK! Disponible: ${stockDisponible} ${unidad}, Solicitado: ${cantidad} ${unidad}`);
                $(this).addClass('is-invalid');
            } else {
                stockWarning.removeClass('alert-danger').addClass('alert-warning').addClass('d-none');
                $(this).removeClass('is-invalid');
            }
        }
    });

    // Limpiar al cerrar modal de tratamiento
    $('#modalRegistrarTratamiento').on('hidden.bs.modal', function() {
        $('#stockWarning').addClass('d-none');
        $('#stockDisponibleText').text('');
        $('#tratamientoCantidadAjustada').prop('disabled', true).removeClass('is-invalid');

        // Resetear formulario si existe
        const formulario = $(this).find('form')[0];
        if (formulario) {
            formulario.reset();
        }

        // Limpiar campos manualmente
        $('#tratamientoProcedimientoId').val('');
        $('#tratamientoPiezasDentales').val('');
        $('#tratamientoDescripcion').val('');
    });
});
</script>

</body>
</html>
