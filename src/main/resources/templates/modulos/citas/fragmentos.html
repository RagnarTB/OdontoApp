<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<body>

<!-- ========================================== -->
<!-- MODAL: Agendar Nueva Cita -->
<!-- ========================================== -->
<div th:fragment="modalAgendarCita" class="modal fade" id="modalAgendarCita" tabindex="-1" role="dialog" aria-labelledby="modalAgendarCitaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form th:action="@{/citas/agendar}" method="post">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalAgendarCitaLabel">
                        <i class="fas fa-calendar-plus mr-2"></i>Agendar Nueva Cita
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Alerta de validación -->
                    <div id="alertaValidacionCita" class="alert alert-danger d-none" role="alert">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span id="mensajeValidacionCita"></span>
                    </div>

                    <!-- Campo hidden para enviar la fecha/hora seleccionada -->
                    <input type="hidden" id="fechaHoraInicioAgendar" name="fechaHoraInicio" required>

                    <!-- PASO 1: Información Básica -->
                    <h6 class="text-primary mb-3 border-bottom pb-2">
                        <i class="fas fa-user-md mr-2"></i>Paso 1: Información Básica
                    </h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="pacienteIdAgendar">Paciente <span class="text-danger">*</span></label>
                                <select class="form-control" id="pacienteIdAgendar" name="pacienteUsuarioId" required>
                                    <option value="">Seleccione un paciente</option>
                                    <option th:each="paciente : ${listaPacientes}"
                                            th:value="${paciente.usuario != null ? paciente.usuario.id : ''}"
                                            th:text="${paciente.nombreCompleto}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="odontologoIdAgendar">Odontólogo <span class="text-danger">*</span></label>
                                <select class="form-control" id="odontologoIdAgendar" name="odontologoUsuarioId" required>
                                    <option value="">Seleccione un odontólogo</option>
                                    <option th:each="odontologo : ${listaOdontologos}"
                                            th:value="${odontologo.id}"
                                            th:text="${odontologo.nombreCompleto}"></option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="procedimientoIdAgendar">Procedimiento <small class="text-muted">(Opcional)</small></label>
                                <select class="form-control" id="procedimientoIdAgendar" name="procedimientoId">
                                    <option value="">Seleccione un procedimiento</option>
                                    <option th:each="procedimiento : ${listaProcedimientos}"
                                            th:value="${procedimiento.id}"
                                            th:text="${procedimiento.nombre}"
                                            th:attr="data-duracion=${procedimiento.duracionBaseMinutos}"></option>
                                </select>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i> Influye en la duración de la cita
                                </small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="fechaCitaAgendar">Fecha de la Cita <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="fechaCitaAgendar" required>
                                <small class="form-text text-muted">
                                    <i class="fas fa-calendar-alt"></i> Seleccione la fecha para ver horarios
                                </small>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- PASO 2: Seleccionar Horario -->
                    <h6 class="text-primary mb-3 border-bottom pb-2">
                        <i class="fas fa-clock mr-2"></i>Paso 2: Seleccionar Horario Disponible
                    </h6>

                    <!-- Indicador de horario seleccionado -->
                    <div class="alert alert-info" id="horario-seleccionado-info" style="display: none;">
                        <i class="fas fa-check-circle mr-2"></i>
                        <strong>Horario seleccionado:</strong> <span id="horario-seleccionado-texto">Ninguno</span>
                    </div>

                    <!-- Grilla de horarios disponibles -->
                    <div id="grilla-horarios-disponibles" class="mb-3">
                        <div class="alert alert-secondary text-center">
                            <i class="fas fa-info-circle mr-2"></i>
                            Seleccione un odontólogo y fecha para ver los horarios disponibles
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- PASO 3: Información Adicional -->
                    <h6 class="text-primary mb-3 border-bottom pb-2">
                        <i class="fas fa-notes-medical mr-2"></i>Paso 3: Información Adicional <small class="text-muted">(Opcional)</small>
                    </h6>

                    <div class="form-group">
                        <label for="motivoConsultaAgendar">Motivo de Consulta</label>
                        <textarea class="form-control" id="motivoConsultaAgendar" name="motivoConsulta" rows="2" placeholder="Describa el motivo de la consulta"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="notasInternasAgendar">Notas Internas</label>
                        <textarea class="form-control" id="notasInternasAgendar" name="notasInternas" rows="2" placeholder="Notas visibles solo para el personal"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check mr-1"></i>Agendar Cita
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- MODAL: Detalle de Cita -->
<!-- ========================================== -->
<div th:fragment="modalDetalleCita" class="modal fade" id="modalDetalleCita" tabindex="-1" role="dialog" aria-labelledby="modalDetalleCitaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalDetalleCitaLabel">
                    <i class="fas fa-info-circle mr-2"></i>Detalle de Cita
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="detalleCitaId" class="citaIdField">

                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Paciente:</strong> <span id="detallePaciente"></span></p>
                        <p><strong>Odontólogo:</strong> <span id="detalleOdontologo"></span></p>
                        <p><strong>Procedimiento:</strong> <span id="detalleProcedimiento"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Estado:</strong> <span id="detalleEstado" class="badge"></span></p>
                        <p><strong>Fecha Inicio:</strong> <span id="detalleFechaHoraInicio"></span></p>
                        <p><strong>Fecha Fin:</strong> <span id="detalleFechaHoraFin"></span></p>
                    </div>
                </div>

                <hr>

                <div class="row">
                    <div class="col-12">
                        <p><strong>Motivo de Consulta:</strong></p>
                        <p class="text-muted" id="detalleMotivoConsulta"></p>
                    </div>
                    <div class="col-12">
                        <p><strong>Notas Internas:</strong></p>
                        <p class="text-muted" id="detalleNotasInternas"></p>
                    </div>
                </div>

                <hr>

                <!-- Botones de Acción -->
                <div class="text-center">
                    <!-- Botón Confirmar Cita -->
                    <form th:action="@{/citas/confirmar}" method="post" style="display: inline-block;" id="btnConfirmarCita">
                        <input type="hidden" name="citaId" class="citaIdField">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check-circle mr-1"></i>Confirmar Cita
                        </button>
                    </form>

                    <!-- Botones Marcar Asistencia -->
                    <div id="divAsistencia" style="display: none;">
                        <form th:action="@{/citas/marcar-asistencia}" method="post" style="display: inline-block;">
                            <input type="hidden" name="citaId" class="citaIdField">
                            <input type="hidden" name="asistio" value="true">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-user-check mr-1"></i>Asistió
                            </button>
                        </form>
                        <form th:action="@{/citas/marcar-asistencia}" method="post" style="display: inline-block;">
                            <input type="hidden" name="citaId" class="citaIdField">
                            <input type="hidden" name="asistio" value="false">
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-user-times mr-1"></i>No Asistió
                            </button>
                        </form>
                    </div>

                    <!-- Botón Reprogramar -->
                    <button type="button" class="btn btn-warning" id="btnReprogramar" data-dismiss="modal" data-toggle="modal" data-target="#modalReprogramarCita">
                        <i class="fas fa-calendar-alt mr-1"></i>Reprogramar
                    </button>

                    <!-- Botón Cancelar -->
                    <button type="button" class="btn btn-danger" id="btnCancelar" data-dismiss="modal" data-toggle="modal" data-target="#modalCancelarCita">
                        <i class="fas fa-ban mr-1"></i>Cancelar
                    </button>

                    <!-- Botón Registrar Tratamiento -->
                    <button type="button" class="btn btn-primary" id="btnRegistrarTratamiento" data-dismiss="modal" data-toggle="modal" data-target="#modalRegistrarTratamiento">
                        <i class="fas fa-notes-medical mr-1"></i>Registrar Tratamiento
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times mr-1"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- MODAL: Reprogramar Cita -->
<!-- ========================================== -->
<div th:fragment="modalReprogramarCita" class="modal fade" id="modalReprogramarCita" tabindex="-1" role="dialog" aria-labelledby="modalReprogramarCitaLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form th:action="@{/citas/reprogramar}" method="post">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="modalReprogramarCitaLabel">
                        <i class="fas fa-calendar-alt mr-2"></i>Reprogramar Cita
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="reprogramarCitaId" name="citaId">

                    <div class="form-group">
                        <label for="nuevaFechaHoraInicio">Nueva Fecha y Hora <span class="text-danger">*</span></label>
                        <input type="datetime-local" class="form-control" id="nuevaFechaHoraInicio"
                               name="nuevaFechaHoraInicio"
                               data-validar="cita-anticipacion"
                               required>
                        <small class="form-text text-muted">
                            Mínimo 2 horas de anticipación desde ahora
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="motivoReprogramacion">Motivo de la Reprogramación</label>
                        <textarea class="form-control" id="motivoReprogramacion" name="motivo" rows="3" placeholder="Indique el motivo de la reprogramación"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-check mr-1"></i>Reprogramar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- MODAL: Cancelar Cita -->
<!-- ========================================== -->
<div th:fragment="modalCancelarCita" class="modal fade" id="modalCancelarCita" tabindex="-1" role="dialog" aria-labelledby="modalCancelarCitaLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form th:action="@{/citas/cancelar}" method="post">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="modalCancelarCitaLabel">
                        <i class="fas fa-ban mr-2"></i>Cancelar Cita
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="cancelarCitaId" name="citaId">

                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        ¿Está seguro de que desea cancelar esta cita?
                    </div>

                    <div class="form-group">
                        <label for="motivoCancelacion">Motivo de la Cancelación <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="motivoCancelacion" name="motivo" rows="3" placeholder="Indique el motivo de la cancelación" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>No, volver
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-ban mr-1"></i>Sí, cancelar cita
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ========================================== -->
<!-- MODAL: Registrar Tratamiento -->
<!-- ========================================== -->
<div th:fragment="modalRegistrarTratamiento" class="modal fade" id="modalRegistrarTratamiento" tabindex="-1" role="dialog" aria-labelledby="modalRegistrarTratamientoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form th:action="@{/tratamientos/registrar}" method="post">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalRegistrarTratamientoLabel">
                        <i class="fas fa-notes-medical mr-2"></i>Registrar Tratamiento
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="tratamientoCitaId" name="citaId">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="tratamientoProcedimientoId">Procedimiento <span class="text-danger">*</span></label>
                                <select class="form-control" id="tratamientoProcedimientoId" name="procedimientoId" required>
                                    <option value="">Seleccione un procedimiento</option>
                                    <option th:each="procedimiento : ${listaProcedimientos}"
                                            th:value="${procedimiento.id}"
                                            th:text="${procedimiento.nombre}"></option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="tratamientoOdontologoId">Odontólogo <span class="text-danger">*</span></label>
                                <select class="form-control" id="tratamientoOdontologoId" name="odontologoUsuarioId" required>
                                    <option value="">Seleccione un odontólogo</option>
                                    <option th:each="odontologo : ${listaOdontologos}"
                                            th:value="${odontologo.id}"
                                            th:text="${odontologo.nombreCompleto}"></option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="tratamientoPiezaDental">Pieza Dental</label>
                                <input type="text" class="form-control" id="tratamientoPiezaDental" name="piezaDental" placeholder="Ej: 16, 21, 34...">
                                <small class="form-text text-muted">Número de la pieza dental tratada</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="tratamientoFechaRealizacion">Fecha de Realización <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" id="tratamientoFechaRealizacion" name="fechaRealizacion" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="tratamientoDescripcion">Descripción del Trabajo</label>
                        <textarea class="form-control" id="tratamientoDescripcion" name="descripcionTrabajo" rows="3" placeholder="Describa el tratamiento realizado"></textarea>
                    </div>

                    <hr>
                    <h6 class="text-muted">Insumo Ajustado (Opcional)</h6>
                    <div class="alert alert-info alert-sm">
                        <i class="fas fa-info-circle mr-2"></i>
                        <small>El stock del insumo seleccionado se descontará automáticamente al registrar el tratamiento.</small>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="tratamientoInsumoId">Insumo</label>
                                <select class="form-control" id="tratamientoInsumoId" name="insumoAjustadoId">
                                    <option value="">Ninguno</option>
                                    <option th:each="insumo : ${listaInsumos}"
                                            th:value="${insumo.id}"
                                            th:text="${insumo.nombre + ' (Stock: ' + insumo.stockActual + ' ' + insumo.unidadMedida.abreviatura + ')'}"></option>
                                </select>
                                <small class="form-text text-muted">Si se usó un insumo, el stock se descontará automáticamente</small>
                                <div id="stockWarning" class="alert alert-warning mt-2 d-none">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                    <span id="stockWarningText"></span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="tratamientoCantidadAjustada">Cantidad</label>
                                <input type="number" class="form-control" id="tratamientoCantidadAjustada" name="cantidadInsumoAjustada" step="0.01" min="0.01" placeholder="0.00">
                                <small class="form-text text-muted" id="stockDisponibleText"></small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save mr-1"></i>Registrar Tratamiento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Script de validaciones inline para modal de citas -->
<script th:fragment="scriptValidacionesCita">
$(document).ready(function() {
    // Referencias a elementos del formulario
    const formAgendar = $('#modalAgendarCita form');
    const fechaInput = $('#fechaHoraInicioAgendar');
    const pacienteSelect = $('#pacienteIdAgendar');
    const odontologoSelect = $('#odontologoIdAgendar');
    const alertaValidacion = $('#alertaValidacionCita');
    const mensajeValidacion = $('#mensajeValidacionCita');

    // Función para validar fecha (no puede ser pasada)
    function validarFecha() {
        const fechaSeleccionada = new Date(fechaInput.val());
        const ahora = new Date();

        if (fechaInput.val() && fechaSeleccionada < ahora) {
            fechaInput.addClass('is-invalid');
            return false;
        } else {
            fechaInput.removeClass('is-invalid');
            return true;
        }
    }

    // Función para validar select
    function validarSelect(selectElement) {
        if (!selectElement.val() || selectElement.val() === '') {
            selectElement.addClass('is-invalid');
            return false;
        } else {
            selectElement.removeClass('is-invalid');
            return true;
        }
    }

    // Validación en tiempo real al cambiar fecha
    fechaInput.on('change', function() {
        validarFecha();
        ocultarAlerta();
    });

    // Validación en tiempo real al cambiar selects
    pacienteSelect.on('change', function() {
        validarSelect($(this));
        ocultarAlerta();
    });

    odontologoSelect.on('change', function() {
        validarSelect($(this));
        ocultarAlerta();
    });

    // Función para mostrar alerta de error
    function mostrarAlerta(mensaje) {
        mensajeValidacion.text(mensaje);
        alertaValidacion.removeClass('d-none');
        alertaValidacion[0].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Función para ocultar alerta
    function ocultarAlerta() {
        alertaValidacion.addClass('d-none');
    }

    // Validación al enviar el formulario
    formAgendar.on('submit', function(e) {
        let esValido = true;
        let mensaje = '';

        // Limpiar validaciones previas
        fechaInput.removeClass('is-invalid');
        pacienteSelect.removeClass('is-invalid');
        odontologoSelect.removeClass('is-invalid');
        ocultarAlerta();

        // Validar fecha
        if (!fechaInput.val()) {
            fechaInput.addClass('is-invalid');
            mensaje = 'Por favor seleccione una fecha y hora de inicio';
            esValido = false;
        } else if (!validarFecha()) {
            mensaje = 'La fecha y hora no puede ser en el pasado';
            esValido = false;
        }

        // Validar paciente
        if (!validarSelect(pacienteSelect)) {
            mensaje = mensaje || 'Por favor seleccione un paciente';
            esValido = false;
        }

        // Validar odontólogo
        if (!validarSelect(odontologoSelect)) {
            mensaje = mensaje || 'Por favor seleccione un odontólogo';
            esValido = false;
        }

        // Si no es válido, prevenir envío y mostrar mensaje
        if (!esValido) {
            e.preventDefault();
            mostrarAlerta(mensaje);
            return false;
        }

        return true;
    });

    // Limpiar validaciones al cerrar el modal
    $('#modalAgendarCita').on('hidden.bs.modal', function() {
        fechaInput.removeClass('is-invalid');
        pacienteSelect.removeClass('is-invalid');
        odontologoSelect.removeClass('is-invalid');
        ocultarAlerta();
        formAgendar[0].reset();
    });

    // ============ SCRIPT PARA MODAL DE TRATAMIENTO ============

    // Autocompletar fecha/hora actual al abrir el modal
    $('#modalRegistrarTratamiento').on('show.bs.modal', function() {
        const ahora = new Date();
        const fechaFormateada = ahora.toISOString().slice(0, 16); // Formato YYYY-MM-DDTHH:mm
        $('#tratamientoFechaRealizacion').val(fechaFormateada);
    });

    // Mapeo de insumos con su stock (se carga desde Thymeleaf)
    const insumosStock = {};

    // Al cambiar el insumo seleccionado, mostrar stock disponible
    $('#tratamientoInsumoId').on('change', function() {
        const insumoId = $(this).val();
        const stockWarning = $('#stockWarning');
        const stockText = $('#stockDisponibleText');

        if (!insumoId) {
            stockWarning.addClass('d-none');
            stockText.text('');
            $('#tratamientoCantidadAjustada').val('').prop('disabled', true);
            return;
        }

        // Habilitar campo de cantidad
        $('#tratamientoCantidadAjustada').prop('disabled', false);

        // Extraer stock del texto del option seleccionado
        const selectedOption = $(this).find('option:selected').text();
        const stockMatch = selectedOption.match(/Stock:\s*([\d.]+)\s*(\w+)/);

        if (stockMatch) {
            const stockDisponible = parseFloat(stockMatch[1]);
            const unidad = stockMatch[2];
            insumosStock[insumoId] = { stock: stockDisponible, unidad: unidad };
            stockText.html(`<i class="fas fa-box mr-1"></i>Stock disponible: <strong>${stockDisponible} ${unidad}</strong>`);

            // Advertencia si stock bajo
            if (stockDisponible < 10) {
                stockWarning.removeClass('d-none');
                $('#stockWarningText').text(`Stock bajo: solo quedan ${stockDisponible} ${unidad}`);
            } else {
                stockWarning.addClass('d-none');
            }
        }
    });

    // Validar cantidad al escribir
    $('#tratamientoCantidadAjustada').on('input', function() {
        const insumoId = $('#tratamientoInsumoId').val();
        const cantidad = parseFloat($(this).val());
        const stockWarning = $('#stockWarning');

        if (insumoId && insumosStock[insumoId] && cantidad) {
            const stockDisponible = insumosStock[insumoId].stock;
            const unidad = insumosStock[insumoId].unidad;

            if (cantidad > stockDisponible) {
                stockWarning.removeClass('d-none').removeClass('alert-warning').addClass('alert-danger');
                $('#stockWarningText').text(`¡CANTIDAD EXCEDE EL STOCK! Disponible: ${stockDisponible} ${unidad}, Solicitado: ${cantidad} ${unidad}`);
                $(this).addClass('is-invalid');
            } else {
                stockWarning.removeClass('alert-danger').addClass('alert-warning').addClass('d-none');
                $(this).removeClass('is-invalid');
            }
        }
    });

    // Limpiar al cerrar modal de tratamiento
    $('#modalRegistrarTratamiento').on('hidden.bs.modal', function() {
        $('#stockWarning').addClass('d-none');
        $('#stockDisponibleText').text('');
        $('#tratamientoCantidadAjustada').prop('disabled', true).removeClass('is-invalid');
        $(this).find('form')[0].reset();
    });
});
</script>

</body>
</html>
