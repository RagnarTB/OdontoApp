<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(titulo='Punto de Venta (POS)', contenido=~{::#contenido-principal}, scripts=~{::#page-scripts})}">

<body>
<div id="contenido-principal">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Punto de Venta (POS)</h1>
                    <p class="text-muted">Registra ventas directas de procedimientos e insumos</p>
                </div>
                <div class="col-sm-6">
                    <a th:href="@{/facturacion}" class="btn btn-outline-secondary float-sm-right">
                        <i class="fas fa-arrow-left mr-2"></i> Volver al Listado
                    </a>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">

            <!-- Mensajes flash -->
            <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle mr-2"></i>
                <span th:text="${success}"></span>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span th:text="${error}"></span>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <form id="formPOS" th:action="@{/facturacion/generar-venta-directa}" method="post" th:object="${comprobanteDTO}">

                <div class="row">
                    <!-- Columna Izquierda: Búsqueda de Items -->
                    <div class="col-md-5">
                        <div class="card card-primary">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-search mr-2"></i>Buscar Items
                                </h3>
                            </div>
                            <div class="card-body">
                                <!-- Selección de Paciente -->
                                <div class="form-group">
                                    <label for="pacienteUsuarioId">Paciente <span class="text-danger">*</span></label>
                                    <select id="pacienteUsuarioId" name="pacienteUsuarioId" class="form-control select2" required style="width: 100%;">
                                        <option value="">Seleccione un paciente</option>
                                        <option th:each="paciente : ${listaPacientes}"
                                                th:value="${paciente.usuario != null ? paciente.usuario.id : ''}"
                                                th:text="${paciente.nombreCompleto + ' - ' + paciente.numeroDocumento}"></option>
                                    </select>
                                </div>

                                <hr>

                                <!-- Búsqueda de Procedimientos -->
                                <div class="form-group">
                                    <label for="selectProcedimiento">Agregar Procedimiento</label>
                                    <select id="selectProcedimiento" class="form-control select2" style="width: 100%;">
                                        <option value="">Buscar procedimiento...</option>
                                        <option th:each="procedimiento : ${listaProcedimientos}"
                                                th:value="${procedimiento.id}"
                                                th:text="${procedimiento.nombre}"
                                                th:attr="data-price=${procedimiento.precioBase},data-nombre=${procedimiento.nombre}"></option>
                                    </select>
                                </div>

                                <!-- Búsqueda de Insumos -->
                                <div class="form-group">
                                    <label for="selectInsumo">Agregar Insumo</label>
                                    <select id="selectInsumo" class="form-control select2" style="width: 100%;">
                                        <option value="">Buscar insumo...</option>
                                        <option th:each="insumo : ${listaInsumos}"
                                                th:value="${insumo.id}"
                                                th:text="${insumo.stockActual > 0 ? (insumo.nombre + ' (Stock: ' + insumo.stockActual + ')') : (insumo.nombre + ' (SIN STOCK)')}"
                                                th:attr="data-price=${insumo.precioUnitario},data-nombre=${insumo.nombre},data-stock=${insumo.stockActual}"
                                                th:disabled="${insumo.stockActual <= 0}"
                                                th:classappend="${insumo.stockActual <= 0} ? 'text-muted'"></option>
                                    </select>
                                    <small class="form-text text-info">
                                        <i class="fas fa-info-circle"></i> Los insumos sin stock aparecen deshabilitados
                                    </small>
                                </div>

                                <button type="button" id="btnAgregarItem" class="btn btn-success btn-block">
                                    <i class="fas fa-plus-circle mr-2"></i>Agregar al Carrito
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Columna Derecha: Carrito de Compra -->
                    <div class="col-md-7">
                        <div class="card card-success">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-shopping-cart mr-2"></i>Detalles del Comprobante
                                </h3>
                            </div>
                            <div class="card-body p-0">
                                <table class="table table-sm" id="tablaDetalles">
                                    <thead>
                                        <tr>
                                            <th style="width: 40%;">Descripción</th>
                                            <th class="text-center" style="width: 15%;">Cantidad</th>
                                            <th class="text-right" style="width: 20%;">P. Unitario</th>
                                            <th class="text-right" style="width: 20%;">Subtotal</th>
                                            <th class="text-center" style="width: 5%;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbodyDetalles">
                                        <tr id="filaVacia">
                                            <td colspan="5" class="text-center text-muted py-4">
                                                <i class="fas fa-cart-plus fa-3x mb-2"></i>
                                                <p>No hay items en el carrito. Usa el panel de búsqueda para agregar.</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="card-footer">
                                <!-- Total -->
                                <div class="row">
                                    <div class="col-6">
                                        <h3>Total:</h3>
                                    </div>
                                    <div class="col-6 text-right">
                                        <h2 class="text-success">
                                            S/ <span id="montoTotal">0.00</span>
                                        </h2>
                                    </div>
                                </div>

                                <!-- Observaciones -->
                                <div class="form-group mt-3">
                                    <label for="observaciones">Observaciones</label>
                                    <textarea id="observaciones" name="observaciones" class="form-control" rows="2" placeholder="Observaciones adicionales del comprobante"></textarea>
                                </div>

                                <!-- Selector de tipo de venta -->
                                <div class="form-group">
                                    <label for="tipoVenta">Tipo de Venta</label>
                                    <select id="tipoVenta" class="form-control">
                                        <option value="pendiente">Generar Comprobante Pendiente</option>
                                        <option value="pagada">Venta Pagada (Generar y Cobrar)</option>
                                    </select>
                                </div>

                                <!-- Campos de pago (solo visible cuando es venta pagada) -->
                                <div id="camposPago" style="display: none;">
                                    <hr>
                                    <h5><i class="fas fa-money-bill-wave mr-2"></i>Datos de Pago</h5>

                                    <div class="form-group">
                                        <label for="metodoPagoId">Método de Pago <span class="text-danger">*</span></label>
                                        <select id="metodoPagoId" name="metodoPagoId" class="form-control">
                                            <option value="">Seleccione un método</option>
                                            <option th:each="metodo : ${listaMetodosPago}"
                                                    th:value="${metodo.id}"
                                                    th:text="${metodo.nombre}"></option>
                                        </select>
                                    </div>

                                    <!-- Campos para pago mixto -->
                                    <div id="camposMixtoPOS" style="display: none;">
                                        <div class="alert alert-info alert-sm">
                                            <i class="fas fa-info-circle"></i> Ingrese cuánto pagará por cada método
                                        </div>
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="form-group">
                                                    <label for="montoEfectivoPOS">Efectivo</label>
                                                    <div class="input-group input-group-sm">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">S/</span>
                                                        </div>
                                                        <input type="number" class="form-control" id="montoEfectivoPOS"
                                                               step="0.01" min="0" placeholder="0.00">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="form-group">
                                                    <label for="montoYapePOS">Yape</label>
                                                    <div class="input-group input-group-sm">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">S/</span>
                                                        </div>
                                                        <input type="number" class="form-control" id="montoYapePOS"
                                                               step="0.01" min="0" placeholder="0.00">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="montoPagoPOS">Monto Recibido <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">S/</span>
                                            </div>
                                            <input type="number" class="form-control" id="montoPagoPOS"
                                                   step="0.01" min="0.01" placeholder="0.00">
                                            <div class="input-group-append">
                                                <button class="btn btn-outline-success" type="button" id="btnMontoExacto">
                                                    <i class="fas fa-check-double"></i> Exacto
                                                </button>
                                            </div>
                                        </div>
                                        <small class="text-muted">El monto debe ser igual o mayor al total</small>
                                    </div>

                                    <div id="cambioPOS" class="alert alert-success" style="display: none;">
                                        <strong>Cambio:</strong> S/ <span id="montoCambio">0.00</span>
                                    </div>

                                    <div class="form-group">
                                        <label for="referenciaYapePOS">Referencia Yape/Transferencia</label>
                                        <input type="text" class="form-control" id="referenciaYapePOS" placeholder="Número de operación (opcional)">
                                    </div>
                                </div>

                                <!-- Botón Generar -->
                                <button type="button" class="btn btn-success btn-lg btn-block" id="btnGenerar" disabled>
                                    <i class="fas fa-file-invoice-dollar mr-2"></i><span id="btnGenerarTexto">Generar Comprobante Pendiente</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Container para inputs hidden de detalles (se llenarán con JS) -->
                <div id="containerDetallesHidden"></div>

            </form>

        </div>
    </section>
</div>

<th:block id="page-scripts">
    <!-- Select2 CSS -->
    <link rel="stylesheet" th:href="@{/adminlte/plugins/select2/css/select2.min.css}">
    <link rel="stylesheet" th:href="@{/adminlte/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css}">

    <!-- Select2 JS -->
    <script th:src="@{/adminlte/plugins/select2/js/select2.full.min.js}"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        $(document).ready(function() {
            // Inicializar Select2
            $('.select2').select2({
                theme: 'bootstrap4',
                placeholder: 'Seleccione una opción',
                allowClear: true
            });

            // Array para almacenar los detalles del comprobante
            let detalles = [];
            let itemIndex = 0;

            // Botón Agregar Item
            $('#btnAgregarItem').click(function() {
                let tipoItem = '';
                let itemId = '';
                let descripcion = '';
                let precio = 0;

                // Verificar si se seleccionó un procedimiento
                if ($('#selectProcedimiento').val()) {
                    tipoItem = 'PROCEDIMIENTO';
                    itemId = $('#selectProcedimiento').val();
                    let option = $('#selectProcedimiento option:selected');
                    descripcion = option.attr('data-nombre');
                    precio = parseFloat(option.attr('data-price') || 0);
                }
                // Verificar si se seleccionó un insumo
                else if ($('#selectInsumo').val()) {
                    tipoItem = 'INSUMO';
                    itemId = $('#selectInsumo').val();
                    let option = $('#selectInsumo option:selected');
                    descripcion = option.attr('data-nombre');
                    precio = parseFloat(option.attr('data-price') || 0);
                    let stockDisponible = parseInt(option.attr('data-stock') || 0);

                    // Validar stock disponible
                    if (stockDisponible <= 0) {
                        mostrarError('Este insumo no tiene stock disponible.');
                        return;
                    }
                }
                else {
                    mostrarAdvertencia('Por favor, selecciona un procedimiento o un insumo.');
                    return;
                }

                // Obtener stock si es insumo
                let stockDisponible = null;
                if (tipoItem === 'INSUMO') {
                    let option = $('#selectInsumo option:selected');
                    stockDisponible = parseInt(option.attr('data-stock') || 0);
                }

                // Crear objeto detalle
                let detalle = {
                    index: itemIndex++,
                    tipoItem: tipoItem,
                    itemId: itemId,
                    descripcionItem: descripcion,
                    cantidad: 1,
                    precioUnitario: precio,
                    subtotal: precio * 1,
                    stockDisponible: stockDisponible
                };

                // Agregar a la lista
                detalles.push(detalle);

                // Agregar fila a la tabla
                agregarFilaDetalle(detalle);

                // Limpiar selección
                $('#selectProcedimiento').val(null).trigger('change');
                $('#selectInsumo').val(null).trigger('change');

                // Actualizar total
                actualizarTotal();

                // Habilitar botón generar
                $('#btnGenerar').prop('disabled', false);
            });

            // Función para agregar fila a la tabla
            function agregarFilaDetalle(detalle) {
                // Ocultar fila vacía
                $('#filaVacia').hide();

                let fila = `
                    <tr data-index="${detalle.index}">
                        <td>${detalle.descripcionItem}</td>
                        <td class="text-center">
                            <input type="number" class="form-control form-control-sm cantidad-input" value="${detalle.cantidad}" min="1" step="0.01" style="width: 80px; display: inline-block;">
                        </td>
                        <td class="text-right">S/ ${detalle.precioUnitario.toFixed(2)}</td>
                        <td class="text-right subtotal">S/ ${detalle.subtotal.toFixed(2)}</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-danger btn-sm btn-eliminar" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;

                $('#tbodyDetalles').append(fila);
            }

            // Event listener para cambio de cantidad
            $(document).on('change', '.cantidad-input', function() {
                let fila = $(this).closest('tr');
                let index = fila.data('index');
                let nuevaCantidad = parseFloat($(this).val());

                // Actualizar detalle en el array
                let detalle = detalles.find(d => d.index === index);
                if (detalle) {
                    // Validar stock si es insumo
                    if (detalle.tipoItem === 'INSUMO' && detalle.stockDisponible !== null) {
                        if (nuevaCantidad > detalle.stockDisponible) {
                            mostrarError(`Stock insuficiente. Disponible: ${detalle.stockDisponible} unidades`);
                            $(this).val(detalle.cantidad); // Restaurar valor anterior
                            return;
                        }
                    }

                    // Validar que sea positivo
                    if (nuevaCantidad <= 0) {
                        mostrarAdvertencia('La cantidad debe ser mayor a 0');
                        $(this).val(detalle.cantidad);
                        return;
                    }

                    detalle.cantidad = nuevaCantidad;
                    detalle.subtotal = detalle.precioUnitario * nuevaCantidad;

                    // Actualizar subtotal en la fila
                    fila.find('.subtotal').text('S/ ' + detalle.subtotal.toFixed(2));

                    // Actualizar total
                    actualizarTotal();
                }
            });

            // Event listener para eliminar fila
            $(document).on('click', '.btn-eliminar', function() {
                let fila = $(this).closest('tr');
                let index = fila.data('index');

                // Eliminar del array
                detalles = detalles.filter(d => d.index !== index);

                // Eliminar fila
                fila.remove();

                // Si no hay detalles, mostrar fila vacía
                if (detalles.length === 0) {
                    $('#filaVacia').show();
                    $('#btnGenerar').prop('disabled', true);
                }

                // Actualizar total
                actualizarTotal();
            });

            // Función para actualizar el total
            function actualizarTotal() {
                let total = detalles.reduce((sum, d) => sum + d.subtotal, 0);
                $('#montoTotal').text(total.toFixed(2));
            }

            // Cambio de tipo de venta
            $('#tipoVenta').change(function() {
                var tipo = $(this).val();

                if (tipo === 'pagada') {
                    $('#camposPago').slideDown();
                    $('#btnGenerarTexto').text('Generar Venta Pagada');
                    $('#metodoPagoId').prop('required', true);
                    $('#montoPagoPOS').prop('required', true);
                } else {
                    $('#camposPago').slideUp();
                    $('#btnGenerarTexto').text('Generar Comprobante Pendiente');
                    $('#metodoPagoId').prop('required', false);
                    $('#montoPagoPOS').prop('required', false);
                }
            });

            // Cambio de método de pago en POS
            $('#metodoPagoId').change(function() {
                var metodoTexto = $(this).find('option:selected').text().toUpperCase();

                $('#camposMixtoPOS').hide();
                $('#montoEfectivoPOS').val('');
                $('#montoYapePOS').val('');

                if (metodoTexto.includes('MIXTO')) {
                    $('#camposMixtoPOS').show();
                    var total = parseFloat($('#montoTotal').text()) || 0;
                    if (total > 0) {
                        var mitad = (total / 2).toFixed(2);
                        $('#montoEfectivoPOS').val(mitad);
                        $('#montoYapePOS').val(mitad);
                        $('#montoPagoPOS').val(total.toFixed(2));
                    }
                }
            });

            // Auto-calcular en pago mixto POS
            $('#montoEfectivoPOS, #montoYapePOS').on('input', function() {
                var efectivo = parseFloat($('#montoEfectivoPOS').val()) || 0;
                var yape = parseFloat($('#montoYapePOS').val()) || 0;
                var suma = efectivo + yape;
                $('#montoPagoPOS').val(suma.toFixed(2));
                $('#montoPagoPOS').trigger('input');
            });

            // Botón monto exacto
            $('#btnMontoExacto').click(function() {
                var total = parseFloat($('#montoTotal').text()) || 0;
                $('#montoPagoPOS').val(total.toFixed(2));
                $('#montoPagoPOS').trigger('input');
            });

            // Calcular cambio
            $('#montoPagoPOS').on('input', function() {
                var total = parseFloat($('#montoTotal').text()) || 0;
                var montoPago = parseFloat($(this).val()) || 0;

                if (montoPago >= total) {
                    var cambio = montoPago - total;
                    $('#montoCambio').text(cambio.toFixed(2));
                    $('#cambioPOS').slideDown();
                } else {
                    $('#cambioPOS').slideUp();
                }
            });

            // Antes de "enviar" el formulario
            $('#btnGenerar').click(function(e) {
                if (detalles.length === 0) {
                    alert('Debe agregar al menos un item al carrito.');
                    return false;
                }

                var tipoVenta = $('#tipoVenta').val();

                // Validar datos de pago si es venta pagada
                if (tipoVenta === 'pagada') {
                    var metodoPagoId = $('#metodoPagoId').val();
                    var montoPago = parseFloat($('#montoPagoPOS').val()) || 0;
                    var total = parseFloat($('#montoTotal').text()) || 0;

                    if (!metodoPagoId) {
                        alert('Debe seleccionar un método de pago.');
                        return false;
                    }

                    if (montoPago < total) {
                        alert('El monto recibido no puede ser menor al total (S/ ' + total.toFixed(2) + ')');
                        return false;
                    }

                    // Validar pago mixto
                    var metodoTexto = $('#metodoPagoId option:selected').text().toUpperCase();
                    if (metodoTexto.includes('MIXTO')) {
                        var efectivo = parseFloat($('#montoEfectivoPOS').val()) || 0;
                        var yape = parseFloat($('#montoYapePOS').val()) || 0;

                        if (efectivo <= 0 || yape <= 0) {
                            alert('Para pago mixto, ambos montos deben ser mayores a cero.');
                            return false;
                        }

                        if (Math.abs((efectivo + yape) - total) > 0.01) {
                            alert('La suma de efectivo y yape debe ser igual al total.');
                            return false;
                        }
                    }
                }

                // Limpiar container de hidden inputs
                $('#containerDetallesHidden').empty();

                // Crear inputs hidden para cada detalle
                detalles.forEach((detalle, idx) => {
                    $('#containerDetallesHidden').append(`
                        <input type="hidden" name="detalles[${idx}].tipoItem" value="${detalle.tipoItem}">
                        <input type="hidden" name="detalles[${idx}].itemId" value="${detalle.itemId}">
                        <input type="hidden" name="detalles[${idx}].descripcionItem" value="${detalle.descripcionItem}">
                        <input type="hidden" name="detalles[${idx}].cantidad" value="${detalle.cantidad}">
                        <input type="hidden" name="detalles[${idx}].precioUnitario" value="${detalle.precioUnitario}">
                        <input type="hidden" name="detalles[${idx}].subtotal" value="${detalle.subtotal}">
                    `);
                });

                // Si es venta pagada, agregar datos de pago
                if (tipoVenta === 'pagada') {
                    $('#containerDetallesHidden').append(`
                        <input type="hidden" name="generarPago" value="true">
                        <input type="hidden" name="metodoPagoId" value="${$('#metodoPagoId').val()}">
                        <input type="hidden" name="montoPago" value="${$('#montoPagoPOS').val()}">
                        <input type="hidden" name="montoEfectivo" value="${$('#montoEfectivoPOS').val() || ''}">
                        <input type="hidden" name="montoYape" value="${$('#montoYapePOS').val() || ''}">
                        <input type="hidden" name="referenciaYape" value="${$('#referenciaYapePOS').val() || ''}">
                    `);
                }

                // Enviar el formulario
                $('#formPOS').submit();
            });
        });
        /*]]>*/
    </script>
</th:block>

</body>
</html>
