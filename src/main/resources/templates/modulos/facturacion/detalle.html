<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(titulo='Detalle de Comprobante', contenido=~{::#contenido-principal})}">

<body>
<div id="contenido-principal">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Detalle de Comprobante</h1>
                    <p class="text-muted">Información completa del comprobante y pagos realizados</p>
                </div>
                <div class="col-sm-6">
                    <a th:href="@{/facturacion}" class="btn btn-outline-secondary float-sm-right">
                        <i class="fas fa-arrow-left mr-2"></i> Volver al Listado
                    </a>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">

            <!-- Mensajes flash -->
            <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle mr-2"></i>
                <span th:text="${success}"></span>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span th:text="${error}"></span>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="row">
                <!-- Columna Izquierda: Información del Comprobante -->
                <div class="col-md-8">

                    <!-- Información General -->
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-file-invoice mr-2"></i>Información del Comprobante
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Número:</strong> <span th:text="${comprobante.numeroComprobante}">B001-0000001</span></p>
                                    <p><strong>Tipo:</strong> <span class="badge badge-info" th:text="${comprobante.tipoComprobante}">CITA</span></p>
                                    <p><strong>Paciente:</strong> <span th:text="${comprobante.paciente.nombreCompleto}">Juan Pérez</span></p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Fecha Emisión:</strong>
                                        <span th:text="${#temporals.format(comprobante.fechaEmision, 'dd/MM/yyyy')}">01/11/2025</span>
                                        <small class="text-muted ml-1" th:text="'a las ' + ${#temporals.format(comprobante.fechaEmision, 'HH:mm')}">a las 14:30</small>
                                    </p>
                                    <p><strong>Estado:</strong>
                                        <span class="badge"
                                              th:classappend="${comprobante.estadoPago.nombre == 'PENDIENTE'} ? 'badge-warning' :
                                                              (${comprobante.estadoPago.nombre == 'PAGADO_PARCIAL'} ? 'badge-info' :
                                                              (${comprobante.estadoPago.nombre == 'PAGADO_TOTAL'} ? 'badge-success' :
                                                              (${comprobante.estadoPago.nombre == 'ANULADO'} ? 'badge-danger' : 'badge-secondary')))"
                                              th:text="${comprobante.estadoPago.nombre}">
                                            PENDIENTE
                                        </span>
                                    </p>
                                    <p th:if="${comprobante.cita != null}">
                                        <strong>Cita ID:</strong> <span th:text="${comprobante.cita.id}">123</span>
                                    </p>
                                </div>
                            </div>

                            <div th:if="${comprobante.descripcion}" class="mt-3">
                                <p><strong>Descripción:</strong></p>
                                <p class="text-muted" th:text="${comprobante.descripcion}">Comprobante generado desde cita</p>
                            </div>
                        </div>
                    </div>

                    <!-- Detalles del Comprobante -->
                    <div class="card card-secondary">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-list mr-2"></i>Detalles del Comprobante
                            </h3>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Tipo</th>
                                        <th>Descripción</th>
                                        <th class="text-center">Cantidad</th>
                                        <th class="text-right">P. Unitario</th>
                                        <th class="text-right">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:if="${comprobante.detalles == null || comprobante.detalles.empty}">
                                        <td colspan="5" class="text-center text-muted py-3">
                                            No hay detalles registrados.
                                        </td>
                                    </tr>
                                    <tr th:each="detalle : ${comprobante.detalles}" class="detalle-row" th:data-tipo="${detalle.tipoItem}">
                                        <td>
                                            <span class="badge"
                                                  th:classappend="${detalle.tipoItem == 'PROCEDIMIENTO'} ? 'badge-primary' : 'badge-warning'"
                                                  th:text="${detalle.tipoItem}">PROCEDIMIENTO</span>
                                        </td>
                                        <td class="detalle-descripcion" th:text="${detalle.descripcionItem}">Limpieza Dental</td>
                                        <td class="text-center detalle-cantidad" th:text="${#numbers.formatDecimal(detalle.cantidad, 1, 2)}">1.00</td>
                                        <td class="text-right">S/ <span th:text="${#numbers.formatDecimal(detalle.precioUnitario, 1, 2)}">80.00</span></td>
                                        <td class="text-right"><strong>S/ <span th:text="${#numbers.formatDecimal(detalle.subtotal, 1, 2)}">80.00</span></strong></td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="4" class="text-right">Total:</th>
                                        <th class="text-right text-success">
                                            S/ <span th:text="${#numbers.formatDecimal(comprobante.montoTotal, 1, 2)}">150.00</span>
                                        </th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- Historial de Pagos -->
                    <div class="card card-success">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-history mr-2"></i>Historial de Pagos
                            </h3>
                            <div class="card-tools" th:if="${pagos != null && !pagos.empty}">
                                <span class="badge badge-success">
                                    <i class="fas fa-receipt mr-1"></i><span th:text="${pagos.size()}">0</span> pago(s)
                                </span>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Fecha</th>
                                        <th>Método</th>
                                        <th class="text-right">Monto</th>
                                        <th>Notas</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:if="${pagos == null || pagos.empty}">
                                        <td colspan="5" class="text-center text-muted py-3">
                                            <i class="fas fa-info-circle fa-2x mb-2 d-block"></i>
                                            No se han registrado pagos aún.
                                        </td>
                                    </tr>
                                    <tr th:each="pago, iterStat : ${pagos}">
                                        <td>
                                            <span class="badge badge-light" th:text="${iterStat.count}">1</span>
                                        </td>
                                        <td>
                                            <small th:text="${#temporals.format(pago.fechaPago, 'dd/MM/yyyy')}">01/11/2025</small>
                                            <br>
                                            <small class="text-muted" th:text="${#temporals.format(pago.fechaPago, 'HH:mm')}">14:30</small>
                                        </td>
                                        <td>
                                            <span class="badge"
                                                  th:classappend="${pago.metodoPago.nombre.contains('EFECTIVO')} ? 'badge-success' :
                                                                 (${pago.metodoPago.nombre.contains('YAPE')} ? 'badge-info' :
                                                                 (${pago.metodoPago.nombre.contains('MIXTO')} ? 'badge-warning' : 'badge-primary'))"
                                                  th:text="${pago.metodoPago.nombre}">EFECTIVO</span>

                                            <!-- Detalles de pago mixto -->
                                            <div th:if="${pago.montoEfectivo != null && pago.montoYape != null}" class="small text-muted mt-1">
                                                <i class="fas fa-money-bill-wave mr-1"></i>Efectivo: S/ <span th:text="${#numbers.formatDecimal(pago.montoEfectivo, 1, 2)}">25.00</span>
                                                <br>
                                                <i class="fas fa-mobile-alt mr-1"></i>Yape: S/ <span th:text="${#numbers.formatDecimal(pago.montoYape, 1, 2)}">25.00</span>
                                            </div>

                                            <!-- Referencia de Yape/Transferencia -->
                                            <span th:if="${pago.referenciaYape}" class="text-muted small d-block mt-1">
                                                <i class="fas fa-hashtag"></i> Ref: <span th:text="${pago.referenciaYape}">123456</span>
                                            </span>
                                        </td>
                                        <td class="text-right">
                                            <strong class="text-success">
                                                S/ <span th:text="${#numbers.formatDecimal(pago.monto, 1, 2)}">50.00</span>
                                            </strong>
                                        </td>
                                        <td>
                                            <small th:if="${pago.notas}" th:text="${pago.notas}">Pago parcial</small>
                                            <small th:unless="${pago.notas}" class="text-muted">-</small>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot th:if="${pagos != null && !pagos.empty}" class="bg-light font-weight-bold">
                                    <tr>
                                        <td colspan="3" class="text-right">Total Pagado:</td>
                                        <td class="text-right text-success">
                                            S/ <span th:text="${#numbers.formatDecimal(comprobante.montoPagado, 1, 2)}">150.00</span>
                                        </td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                </div>

                <!-- Columna Derecha: Resumen de Pagos -->
                <div class="col-md-4">
                    <div class="card card-success">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-calculator mr-2"></i>Resumen de Pagos
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label>Monto Total:</label>
                                <h3 class="text-dark">S/ <span th:text="${#numbers.formatDecimal(comprobante.montoTotal, 1, 2)}">150.00</span></h3>
                            </div>

                            <div class="mb-3">
                                <label>Monto Pagado:</label>
                                <h3 class="text-success">S/ <span th:text="${#numbers.formatDecimal(comprobante.montoPagado, 1, 2)}">50.00</span></h3>
                            </div>

                            <div class="mb-4">
                                <label>Saldo Pendiente:</label>
                                <h2 class="text-danger">S/ <span th:text="${#numbers.formatDecimal(comprobante.montoPendiente, 1, 2)}">100.00</span></h2>
                            </div>

                            <hr>

                            <!-- Botón Registrar Pago -->
                            <button type="button" class="btn btn-success btn-lg btn-block"
                                    data-toggle="modal"
                                    data-target="#modalRegistrarPago"
                                    th:if="${comprobante.estadoPago.nombre != 'ANULADO' && comprobante.estadoPago.nombre != 'PAGADO_TOTAL'}"
                                    th:attr="data-comprobante-id=${comprobante.id},
                                             data-numero-comprobante=${comprobante.numeroComprobante},
                                             data-saldo-pendiente=${comprobante.montoPendiente}">
                                <i class="fas fa-money-bill-wave mr-2"></i>Registrar Pago
                            </button>

                            <div th:if="${comprobante.estadoPago.nombre == 'PAGADO_TOTAL'}" class="alert alert-success text-center">
                                <i class="fas fa-check-circle fa-2x mb-2"></i>
                                <p class="mb-0"><strong>Comprobante Pagado Totalmente</strong></p>
                            </div>

                            <div th:if="${comprobante.estadoPago.nombre == 'ANULADO'}" class="alert alert-danger text-center">
                                <i class="fas fa-ban fa-2x mb-2"></i>
                                <p class="mb-0"><strong>Comprobante Anulado</strong></p>
                            </div>
                        </div>
                    </div>

                    <!-- Acciones Adicionales -->
                    <div class="card card-warning">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-cogs mr-2"></i>Acciones
                            </h3>
                        </div>
                        <div class="card-body">
                            <!-- Botón Imprimir: Solo habilitado cuando está PAGADO_TOTAL -->
                            <a th:href="@{/facturacion/imprimir/{id}(id=${comprobante.id})}"
                               class="btn btn-block"
                               th:classappend="${comprobante.estadoPago.nombre == 'PAGADO_TOTAL'} ? 'btn-primary' : 'btn-secondary disabled'"
                               th:disabled="${comprobante.estadoPago.nombre != 'PAGADO_TOTAL'}"
                               th:attr="aria-disabled=${comprobante.estadoPago.nombre != 'PAGADO_TOTAL'}"
                               target="_blank">
                                <i class="fas fa-print mr-2"></i>Imprimir Comprobante
                            </a>

                            <small th:if="${comprobante.estadoPago.nombre != 'PAGADO_TOTAL'}" class="text-muted d-block mt-2">
                                <i class="fas fa-info-circle"></i> Solo se puede imprimir comprobantes pagados totalmente
                            </small>

                            <button type="button"
                               class="btn btn-outline-danger btn-block mt-2"
                               th:if="${comprobante.estadoPago.nombre != 'ANULADO' && (pagos == null || pagos.empty)}"
                               th:attr="data-comprobante-id=${comprobante.id},
                                        data-tiene-insumos=${comprobante.detalles.?[tipoItem == 'INSUMO'].size() > 0}"
                               onclick="confirmarAnulacion(this);">
                                <i class="fas fa-ban mr-2"></i>Anular Comprobante
                            </button>

                            <div th:if="${comprobante.estadoPago.nombre != 'ANULADO' && pagos != null && !pagos.empty}"
                                 class="alert alert-warning small mt-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                No se puede anular un comprobante con pagos registrados.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <!-- Incluir Modal de Registrar Pago -->
    <div th:replace="~{modulos/facturacion/fragmentos :: modalRegistrarPago}"></div>

</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    $(document).ready(function() {
        console.log('=== SCRIPT DETALLE.HTML CARGADO ===');

        // Datos del comprobante desde Thymeleaf
        var comprobanteIdThymeleaf = /*[[${comprobante.id}]]*/ null;
        var numeroComprobanteThymeleaf = /*[[${comprobante.numeroComprobante}]]*/ '';
        var saldoPendienteThymeleaf = /*[[${comprobante.montoPendiente}]]*/ 0;

        console.log('Datos de Thymeleaf:', {
            comprobanteId: comprobanteIdThymeleaf,
            numeroComprobante: numeroComprobanteThymeleaf,
            saldoPendiente: saldoPendienteThymeleaf
        });

        // ==============================================
        // SCRIPTS DEL MODAL DE PAGO
        // ==============================================

        // Botón "Pagar Total" - setea el monto al saldo pendiente completo
        $('#btnPagarTotal').click(function() {
            const saldoPendiente = parseFloat($('#infoSaldoPendiente').text()) || 0;
            $('#monto').val(saldoPendiente.toFixed(2));
            $('#monto').trigger('input');
        });

        // Validación en tiempo real del monto
        $('#monto').on('input', function() {
            const montoIngresado = parseFloat($(this).val()) || 0;
            const saldoPendiente = parseFloat($('#infoSaldoPendiente').text()) || 0;

            if (montoIngresado > saldoPendiente) {
                $('#montoValidacion').show();
                $(this).addClass('is-invalid');
                $('#montoInfo').hide();
            } else {
                $('#montoValidacion').hide();
                $(this).removeClass('is-invalid');

                if (montoIngresado > 0) {
                    const restante = saldoPendiente - montoIngresado;
                    if (restante > 0) {
                        $('#montoRestante').text('Quedará pendiente: S/ ' + restante.toFixed(2));
                    } else {
                        $('#montoRestante').text('Pago completo - Saldará la deuda');
                    }
                    $('#montoInfo').show();
                } else {
                    $('#montoInfo').hide();
                }
            }
        });

        // Event listener para cambio de método de pago
        $('#metodoPagoId').change(function() {
            var metodoTexto = $(this).find('option:selected').text().toUpperCase();
            console.log('Método de pago seleccionado:', metodoTexto);

            // Ocultar todos los campos opcionales
            $('#camposYape').hide();
            $('#camposMixto').hide();
            $('#referenciaYape').prop('required', false);
            $('#montoEfectivo').prop('required', false);
            $('#montoYape').prop('required', false);

            // Limpiar valores previos
            $('#referenciaYape').val('');
            $('#montoEfectivo').val('');
            $('#montoYape').val('');

            // Mostrar campos según el método seleccionado
            if (metodoTexto.includes('YAPE') || metodoTexto.includes('TRANSFERENCIA')) {
                console.log('Mostrando campos Yape');
                $('#camposYape').show();
                $('#referenciaYape').prop('required', true);
            }
            if (metodoTexto.includes('MIXTO')) {
                console.log('Mostrando campos MIXTO');
                $('#camposMixto').show();
                $('#montoEfectivo').prop('required', true);
                $('#montoYape').prop('required', true);

                // Auto-distribuir el monto del saldo pendiente en dos partes iguales
                var saldoPendiente = parseFloat($('#infoSaldoPendiente').text()) || 0;
                if (saldoPendiente > 0) {
                    var mitad = (saldoPendiente / 2).toFixed(2);
                    $('#montoEfectivo').val(mitad);
                    $('#montoYape').val(mitad);
                    $('#monto').val(saldoPendiente.toFixed(2));
                    $('#monto').trigger('input');
                    console.log('Montos mixtos cargados:', {efectivo: mitad, yape: mitad});
                }
            }
        });

        // Auto-calcular monto total cuando cambian los montos mixtos
        $('#montoEfectivo, #montoYape').on('input', function() {
            var metodoTexto = $('#metodoPagoId option:selected').text().toUpperCase();

            if (metodoTexto.includes('MIXTO')) {
                var montoEfectivo = parseFloat($('#montoEfectivo').val()) || 0;
                var montoYape = parseFloat($('#montoYape').val()) || 0;
                var sumaActual = montoEfectivo + montoYape;
                var saldoPendiente = parseFloat($('#infoSaldoPendiente').text()) || 0;

                // Actualizar el monto total automáticamente
                $('#monto').val(sumaActual.toFixed(2));
                $('#monto').trigger('input');

                // Validar que no exceda el saldo pendiente
                if (sumaActual > saldoPendiente) {
                    $('#montoEfectivo, #montoYape').addClass('border-danger');
                    if (!$('#warningMixto').length) {
                        $('#camposMixto').append(
                            '<small id="warningMixto" class="text-danger d-block mt-2">' +
                            '<i class="fas fa-exclamation-triangle mr-1"></i>La suma excede el saldo pendiente: S/ ' + saldoPendiente.toFixed(2) +
                            '</small>'
                        );
                    } else {
                        $('#warningMixto').html('<i class="fas fa-exclamation-triangle mr-1"></i>La suma excede el saldo pendiente: S/ ' + saldoPendiente.toFixed(2));
                        $('#warningMixto').removeClass('text-success').addClass('text-danger');
                    }
                } else if (sumaActual > 0) {
                    $('#montoEfectivo, #montoYape').removeClass('border-danger border-warning').addClass('border-success');
                    if (!$('#warningMixto').length) {
                        $('#camposMixto').append(
                            '<small id="warningMixto" class="text-success d-block mt-2">' +
                            '<i class="fas fa-check-circle mr-1"></i>Total: S/ ' + sumaActual.toFixed(2) +
                            '</small>'
                        );
                    } else {
                        $('#warningMixto').html('<i class="fas fa-check-circle mr-1"></i>Total: S/ ' + sumaActual.toFixed(2));
                        $('#warningMixto').removeClass('text-danger').addClass('text-success');
                    }
                } else {
                    $('#montoEfectivo, #montoYape').removeClass('border-danger border-warning border-success');
                    $('#warningMixto').remove();
                }
            }
        });

        // Limpiar modal al cerrar
        $('#modalRegistrarPago').on('hidden.bs.modal', function() {
            console.log('Modal cerrado - limpiando campos');
            $(this).find('form')[0].reset();
            $('#camposYape').hide();
            $('#camposMixto').hide();
            $('#warningMixto').remove();
        });

        // IMPORTANTE: Usar 'show.bs.modal' para cargar datos ANTES de mostrar el modal
        $('#modalRegistrarPago').on('show.bs.modal', function (event) {
            console.log('=== ABRIENDO MODAL DE PAGO ===');

            // Usar datos de Thymeleaf directamente
            var comprobanteId = comprobanteIdThymeleaf;
            var numeroComprobante = numeroComprobanteThymeleaf;
            var saldoPendiente = parseFloat(saldoPendienteThymeleaf) || 0;

            console.log('Usando datos:', {comprobanteId, numeroComprobante, saldoPendiente});

            // Validar que tenemos el ID del comprobante
            if (!comprobanteId) {
                console.error('ERROR: No hay ID del comprobante');
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo cargar la información del comprobante. Por favor, recargue la página.'
                });
                event.preventDefault();
                return false;
            }

            // Rellenar campos del modal
            $('#pagoComprobanteId').val(comprobanteId);
            $('#infoNumeroComprobante').text(numeroComprobante || 'N/A');
            $('#infoSaldoPendiente').text(saldoPendiente.toFixed(2));

            // Asignar automáticamente la fecha y hora actual
            // Formato para datetime-local: yyyy-MM-ddTHH:mm
            const ahora = new Date();
            const year = ahora.getFullYear();
            const month = String(ahora.getMonth() + 1).padStart(2, '0');
            const day = String(ahora.getDate()).padStart(2, '0');
            const hours = String(ahora.getHours()).padStart(2, '0');
            const minutes = String(ahora.getMinutes()).padStart(2, '0');
            const fechaFormateada = `${year}-${month}-${day}T${hours}:${minutes}`;
            $('#fechaPago').val(fechaFormateada);
            console.log('Fecha formateada:', fechaFormateada);

            // Precargar el monto con el saldo pendiente
            $('#monto').attr('max', saldoPendiente);
            $('#monto').val(saldoPendiente.toFixed(2));
            $('#monto').trigger('input');

            console.log('✓ Comprobante ID seteado:', $('#pagoComprobanteId').val());
            console.log('✓ Fecha de pago seteada:', $('#fechaPago').val());
            console.log('✓ Saldo pendiente:', $('#infoSaldoPendiente').text());
        });

        // Validación al enviar el formulario
        $('#modalRegistrarPago form').submit(function(e) {
            console.log('=== ENVIANDO FORMULARIO DE PAGO ===');

            // VALIDAR QUE EL ID DEL COMPROBANTE ESTÉ PRESENTE
            var comprobanteId = $('#pagoComprobanteId').val();
            var fechaPago = $('#fechaPago').val();
            var metodoPagoId = $('#metodoPagoId').val();
            var monto = $('#monto').val();

            console.log('Datos del formulario:');
            console.log('  - ID Comprobante:', comprobanteId);
            console.log('  - Fecha Pago:', fechaPago);
            console.log('  - Método Pago ID:', metodoPagoId);
            console.log('  - Monto:', monto);

            if (!comprobanteId || comprobanteId === '' || comprobanteId === '0') {
                e.preventDefault();
                console.error('ERROR: ID del comprobante vacío');
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se ha especificado el comprobante. Por favor, cierre y vuelva a abrir el modal.',
                    confirmButtonText: 'Entendido'
                });
                return false;
            }

            var metodoTexto = $('#metodoPagoId option:selected').text().toUpperCase();

            // Validar pago mixto
            if (metodoTexto.includes('MIXTO')) {
                var montoTotal = parseFloat($('#monto').val() || 0);
                var montoEfectivo = parseFloat($('#montoEfectivo').val() || 0);
                var montoYape = parseFloat($('#montoYape').val() || 0);
                var suma = montoEfectivo + montoYape;

                console.log('Validando pago mixto:', {montoTotal, montoEfectivo, montoYape, suma});

                if (montoEfectivo <= 0 || montoYape <= 0) {
                    e.preventDefault();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error en Pago Mixto',
                        html: 'Ambos montos (Efectivo y Yape) deben ser <strong>mayores a cero</strong>.',
                        confirmButtonText: 'Entendido'
                    });
                    return false;
                }

                if (Math.abs(suma - montoTotal) > 0.01) {
                    e.preventDefault();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error en Pago Mixto',
                        html: 'La suma de <strong>Efectivo (S/ ' + montoEfectivo.toFixed(2) + ')</strong> + ' +
                              '<strong>Yape (S/ ' + montoYape.toFixed(2) + ')</strong> = ' +
                              '<strong>S/ ' + suma.toFixed(2) + '</strong><br><br>' +
                              'Debe ser igual al <strong>Monto Total: S/ ' + montoTotal.toFixed(2) + '</strong>',
                        confirmButtonText: 'Corregir'
                    });
                    return false;
                }
            }

            // Validar referencia Yape/Transferencia
            if ((metodoTexto.includes('YAPE') || metodoTexto.includes('TRANSFERENCIA')) && !metodoTexto.includes('MIXTO')) {
                var referenciaYape = $('#referenciaYape').val().trim();
                if (!referenciaYape) {
                    e.preventDefault();
                    Swal.fire({
                        icon: 'warning',
                        title: 'Referencia Requerida',
                        text: 'Por favor ingrese el número de operación o referencia de la transacción.',
                        confirmButtonText: 'Entendido'
                    });
                    $('#referenciaYape').focus();
                    return false;
                }
            }

            // Validar fecha de pago
            var fechaPago = $('#fechaPago').val();
            if (!fechaPago) {
                e.preventDefault();
                console.error('ERROR: Fecha de pago vacía');
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'La fecha de pago no está configurada.',
                    confirmButtonText: 'Entendido'
                });
                return false;
            }

            console.log('✓ Formulario válido, enviando...');
            return true;
        });
    });

    // Función para confirmar anulación con SweetAlert2
    function confirmarAnulacion(button) {
        var comprobanteId = $(button).data('comprobante-id');
        var tieneInsumos = $(button).data('tiene-insumos');

        // Si tiene insumos, preguntar si desea regresar al inventario
        if (tieneInsumos) {
            // Obtener lista de insumos del comprobante desde la tabla
            var insumosHTML = '';
            var hayInsumos = false;

            $('.detalle-row').each(function() {
                var tipo = $(this).data('tipo');
                if (tipo === 'INSUMO') {
                    hayInsumos = true;
                    var descripcion = $(this).find('.detalle-descripcion').text();
                    var cantidad = $(this).find('.detalle-cantidad').text();
                    insumosHTML += '<li class="mb-2"><i class="fas fa-box text-warning mr-2"></i><strong>' + descripcion + '</strong> - Cantidad: ' + cantidad + '</li>';
                }
            });

            if (!hayInsumos) {
                insumosHTML = '<li class="text-muted">No hay insumos en este comprobante</li>';
            }

            Swal.fire({
                title: '¿Anular este comprobante?',
                html: `
                    <div class="text-left">
                        <p class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <strong>Esta acción no se puede deshacer.</strong>
                        </p>
                        <div class="card">
                            <div class="card-header bg-info text-white py-2">
                                <strong><i class="fas fa-clipboard-list mr-2"></i>Insumos utilizados:</strong>
                            </div>
                            <div class="card-body p-3">
                                <ul class="list-unstyled mb-0" style="max-height: 200px; overflow-y: auto;">
                                    ${insumosHTML}
                                </ul>
                            </div>
                        </div>
                        <p class="mt-3 text-center font-weight-bold">¿Desea regresar estos insumos al inventario?</p>
                        <p class="text-muted small text-center">El motivo será registrado como "Anulación de Venta"</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                showDenyButton: hayInsumos,
                confirmButtonText: '<i class="fas fa-check mr-1"></i> Sí, regresar insumos',
                denyButtonText: '<i class="fas fa-times mr-1"></i> No regresar insumos',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#28a745',
                denyButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                reverseButtons: true,
                width: '650px'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Anular y regresar insumos
                    window.location.href = '/facturacion/anular/' + comprobanteId + '?regresarInventario=true';
                } else if (result.isDenied) {
                    // Anular sin regresar insumos
                    window.location.href = '/facturacion/anular/' + comprobanteId + '?regresarInventario=false';
                }
            });
        } else {
            // No tiene insumos, solo confirmar anulación
            Swal.fire({
                title: '¿Está seguro?',
                text: '¿Desea anular este comprobante? Esta acción no se puede deshacer.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, anular',
                cancelButtonText: 'Cancelar',
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/facturacion/anular/' + comprobanteId + '?regresarInventario=false';
                }
            });
        }
    }
    /*]]>*/
</script>

</body>
</html>
