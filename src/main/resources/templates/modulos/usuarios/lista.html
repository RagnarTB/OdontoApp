<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout/base :: layout(titulo='Gestión de Usuarios', contenido=~{::#contenido-principal})}">

<body>
<div id="contenido-principal">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>Gestión de Usuarios</h1>
                    <p class="text-muted">Administra los usuarios y roles del sistema</p>
                </div>
                <div class="col-sm-6">
                    <a th:href="@{/usuarios/nuevo}" class="btn btn-primary float-sm-right"
                       sec:authorize="hasAuthority('CREAR_USUARIOS')">
                        <i class="fas fa-plus"></i> Nuevo Usuario
                    </a>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">

            <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                <span th:text="${success}"></span>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <span th:text="${error}"></span>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>

            <div class="card">
                <div class="card-body d-flex justify-content-between">
                    <form th:action="@{/usuarios}" method="get" class="form-inline w-100">
                        <div class="input-group w-100">
                            <div class="input-group-prepend">
                                <span class="input-group-text bg-transparent border-right-0"><i class="fas fa-search"></i></span>
                            </div>
                            <input type="text" name="keyword" class="form-control border-left-0"
                                   placeholder="Buscar por nombre, email o teléfono..." th:value="${keyword}">
                        </div>
                    </form>
                </div>
            </div>

            <div class="card user-list-container">
                <div class="card-header">
                    <h3 class="card-title">Usuarios del Sistema <span class="badge badge-secondary ml-1" th:text="${paginaUsuarios.totalElements}"></span></h3>
                </div>
                <div class="card-body">

                    <div class="user-list-card-header d-none d-md-flex">
                        <div class="user-info-header">Usuario</div>          <div class="user-role-header">Rol</div>              <div class="user-contact-header">Contacto</div>      <div class="user-hiring-header">Contratación</div>  <div class="user-status-header">Estado</div>         <div class="user-access-header">Último Acceso</div>   <div class="user-actions-header">Acciones</div>      </div>

                    <div th:if="${!paginaUsuarios.empty}">
                        <div class="user-card" th:each="usuario : ${paginaUsuarios.content}">

                            <div class="user-info">
                                <div class="user-avatar"
                                     th:classappend="${#strings.containsIgnoreCase(usuario.getRoles().iterator().next().getNombre(), 'Admin')} ? 'bg-purple' : (${#strings.containsIgnoreCase(usuario.getRoles().iterator().next().getNombre(), 'Odontologo')} ? 'bg-teal' : (${#strings.containsIgnoreCase(usuario.getRoles().iterator().next().getNombre(), 'Recepcionista')} ? 'bg-orange' : 'bg-info'))"
                                     th:text="${#strings.substring(usuario.nombreCompleto, 0, 1) + (#strings.contains(usuario.nombreCompleto, ' ') ? #strings.substring(usuario.nombreCompleto, #strings.indexOf(usuario.nombreCompleto, ' ')+1, #strings.indexOf(usuario.nombreCompleto, ' ')+2) : '')}">
                                </div>
                                <div class="user-details">
                                    <div class="user-name" th:text="${usuario.nombreCompleto}"></div>
                                    <div class="user-email" th:text="${usuario.email}"></div>
                                </div>
                            </div>

                            <div class="user-role">
                                <span class="role-pill"
                                      th:classappend="${#strings.toLowerCase(usuario.getRoles().iterator().next().getNombre())}"
                                      th:text="${usuario.getRoles().iterator().next().getNombre()}"></span>
                            </div>

                            <div class="user-contact">
                                <span th:text="${usuario.telefono ?: '-'}"></span>
                            </div>

                            <div class="user-hiring">
                                <span th:if="${usuario.fechaContratacion}"
                                      th:text="${#temporals.format(usuario.fechaContratacion, 'dd/MM/yyyy')}"></span>
                                <span th:unless="${usuario.fechaContratacion}" class="text-muted">-</span>
                            </div>

                            <div class="user-status">
                                <span class="status-pill"
                                      th:classappend="${usuario.estaActivo} ? 'active' : 'inactive'"
                                      th:text="${usuario.estaActivo} ? 'Activo' : 'Inactivo'">
                                </span>
                            </div>

                            <div class="user-access">
                                <span th:if="${usuario.ultimoAcceso}"
                                      th:text="${#temporals.format(usuario.ultimoAcceso, 'dd/MM/yyyy HH:mm')}"></span> <span th:unless="${usuario.ultimoAcceso}" class="text-muted">-</span>
                            </div>

                            <div class="user-actions">
                                <!-- Mostrar badge para super-admin en lugar de acciones -->
                                <span th:if="${usuario.esSuperAdmin}" class="badge badge-primary">
                                    <i class="fas fa-shield-alt"></i> Super Admin
                                </span>

                                <!-- Mostrar acciones solo si NO es super-admin -->
                                <div th:unless="${usuario.esSuperAdmin}">
                                    <label class="switch" title="Cambiar Estado">
                                        <input type="checkbox" th:checked="${usuario.estaActivo}"
                                               th:attr="onchange=|location.href='@{/usuarios/cambiar-estado/{id}(id=${usuario.id})}'|">
                                        <span class="slider"></span>
                                    </label>
                                    <a th:href="@{/usuarios/editar/{id}(id=${usuario.id})}"
                                       class="btn btn-sm btn-outline-secondary" title="Editar"
                                       sec:authorize="hasAuthority('EDITAR_USUARIOS')">
                                        <i class="fas fa-pencil-alt"></i>
                                    </a>
                                    <a th:href="@{/usuarios/eliminar/{id}(id=${usuario.id})}"
                                       class="btn btn-sm btn-outline-danger btn-eliminar-usuario" title="Eliminar"
                                       th:data-nombre="${usuario.nombreCompleto}"
                                       sec:authorize="hasAuthority('ELIMINAR_USUARIOS')">
                                        <i class="fas fa-trash-alt"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div th:if="${paginaUsuarios.empty}" class="text-center p-5">
                        <p class="text-muted">No se encontraron usuarios con los criterios de búsqueda.</p>
                    </div>

                </div><div class="card-footer clearfix" th:if="${paginaUsuarios.totalPages > 1}">
                <ul class="pagination pagination-sm m-0 float-right">
                    <li class="page-item" th:classappend="${paginaUsuarios.first} ? 'disabled'">
                        <a class="page-link" th:href="@{/usuarios(page=0, keyword=${keyword})}">&laquo;</a>
                    </li>
                    <li class="page-item" th:classappend="${!paginaUsuarios.hasPrevious()} ? 'disabled'">
                        <a class="page-link" th:href="@{/usuarios(page=${paginaUsuarios.number - 1}, keyword=${keyword})}">&lsaquo;</a>
                    </li>
                    <li class="page-item" th:each="i : ${#numbers.sequence(0, paginaUsuarios.totalPages - 1)}" th:classappend="${paginaUsuarios.number == i} ? 'active'">
                        <a class="page-link" th:href="@{/usuarios(page=${i}, keyword=${keyword})}" th:text="${i + 1}"></a>
                    </li>
                    <li class="page-item" th:classappend="${!paginaUsuarios.hasNext()} ? 'disabled'">
                        <a class="page-link" th:href="@{/usuarios(page=${paginaUsuarios.number + 1}, keyword=${keyword})}">&rsaquo;</a>
                    </li>
                    <li class="page-item" th:classappend="${paginaUsuarios.last} ? 'disabled'">
                        <a class="page-link" th:href="@{/usuarios(page=${paginaUsuarios.totalPages - 1}, keyword=${keyword})}">&raquo;</a>
                    </li>
                </ul>
            </div>
            </div> </div> </section>
</div>

<script>
    // Confirmación de eliminación de usuario con SweetAlert2
    $(document).on('click', '.btn-eliminar-usuario', function(e) {
        e.preventDefault();
        const url = $(this).attr('href');
        const nombre = $(this).data('nombre');

        confirmarEliminacion(nombre).then((result) => {
            if (result.isConfirmed) {
                window.location.href = url;
            }
        });
    });
</script>
</body>
</html>